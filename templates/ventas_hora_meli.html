<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impacto de Precios - Mercado Libre</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 65px;
        }

        .main-container {
            max-width: 1750px;
            margin: 0 auto;
            padding: 0.9rem 2.5rem;
        }

        .page-header {
            background: white;
            border-radius: 10px;
            padding: 0.9rem 1.2rem;
            margin-bottom: 0.9rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #e74c3c;
        }

        .page-header h1 {
            color: #2C2C2C;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.4rem;
        }

        .page-header h1 i {
            color: #e74c3c;
            font-size: 1.4rem;
        }

        .page-header p {
            font-size: 0.82rem;
            margin-bottom: 0;
            color: #6c757d;
        }

        .card-custom {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 0.9rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border: none;
        }

        .selector-sku-container {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.9rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .btn-cargar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .btn-cargar:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
            color: white;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        #chartContainer {
            position: relative;
            height: 700px;
            width: 100%;
        }

        .info-box {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%);
            border-left: 4px solid #3498db;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .stat-badge {
            display: inline-block;
            background: #f8f9fa;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            margin-right: 0.5rem;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
        }

        .stat-badge strong {
            color: #e74c3c;
        }

        .tarjeta-dia {
            background: white;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 140px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            pointer-events: auto;
            font-size: 0.75rem;
            position: absolute;
            top: 0px;
        }

        .tarjeta-dia-header {
            font-weight: 700;
            font-size: 0.8rem;
            color: #e74c3c;
            border-bottom: 1px solid #fee;
            padding-bottom: 4px;
            margin-bottom: 6px;
            text-align: center;
        }

        .tarjeta-dia-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .tarjeta-dia-label {
            color: #666;
            font-weight: 600;
        }

        .tarjeta-dia-value {
            color: #2C2C2C;
            font-weight: 700;
        }

        .tarjeta-dia-variacion {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .variacion-positiva-bg {
            background: #d4edda;
            color: #155724;
        }

        .variacion-negativa-bg {
            background: #f8d7da;
            color: #721c24;
        }

        .variacion-neutral-bg {
            background: #e2e3e5;
            color: #383d41;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i class="bi bi-graph-up-arrow"></i>
                Análisis de Impacto de Precios en Ventas
            </h1>
            <p class="text-muted mb-0">Visualiza cómo los cambios de precio afectan la cantidad vendida por hora en Mercado Libre</p>
        </div>

        <!-- Error Alert -->
        {% if error %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Selector de SKU -->
        <div class="selector-sku-container">
            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-box-seam"></i> Selecciona un SKU para analizar
                    </label>
                    <select class="form-select form-select-lg" id="skuSelector">
                        <option value="">-- Selecciona un SKU --</option>
                        {% for sku_data in skus_disponibles %}
                        <option value="{{ sku_data.sku }}" {% if sku_data.sku == sku_seleccionado %}selected{% endif %}>
                            {{ sku_data.sku }} - {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-cargar btn-lg w-100" id="btnCargar">
                        <i class="bi bi-arrow-clockwise me-2"></i>Cargar Análisis
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box" id="infoBox" style="display: none;">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <strong><i class="bi bi-info-circle-fill me-2"></i>SKU Analizado:</strong>
                    <span id="infoSku" class="ms-2 text-primary fw-bold"></span>
                </div>
                <div>
                    <span class="stat-badge">
                        <i class="bi bi-calendar-range"></i> Total de registros:
                        <strong id="infoRegistros">0</strong>
                    </span>
                </div>
            </div>
        </div>

        <!-- Gráfico -->
        <div class="card-custom">
            <div id="noDataMessage" class="text-center py-5">
                <i class="bi bi-graph-up" style="font-size: 3rem; color: #dee2e6;"></i>
                <p class="text-muted mt-3">Selecciona un SKU y haz clic en "Cargar Análisis" para visualizar los datos</p>
            </div>
            <div id="chartContainer" style="display: none; position: relative;">
                <h5 class="text-center mb-3 fw-bold" style="color: #2C2C2C;">Análisis de Precio vs Cantidad Vendida por Hora</h5>

                <!-- Tarjetas Resumen Flotantes - DENTRO del chart container -->
                <div id="tarjetasResumenContainer" style="display: none; position: absolute; top: 60px; left: 0; right: 0; pointer-events: none; z-index: 10;">
                    <div id="tarjetasResumen" style="position: relative; width: 100%; height: 120px;">
                        <!-- Se llenarán con JavaScript -->
                    </div>
                </div>

                <canvas id="myChart"></canvas>
            </div>
        </div>

        <!-- Leyenda del gráfico -->
        <div class="card-custom" id="leyendaContainer" style="display: none;">
            <h6 class="fw-bold mb-3"><i class="bi bi-info-square"></i> Interpretación del Gráfico</h6>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2">
                        <span style="display: inline-block; width: 20px; height: 20px; background: rgba(52, 152, 219, 0.8); border-radius: 4px; vertical-align: middle;"></span>
                        <strong class="ms-2">Barras Azules:</strong> Cantidad vendida por hora
                    </p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2">
                        <span style="display: inline-block; width: 40px; height: 15px; background: rgba(231, 76, 60, 0.15); border: 2px solid rgba(231, 76, 60, 0.8); border-radius: 2px; vertical-align: middle;"></span>
                        <strong class="ms-2">Área Roja:</strong> Precio del producto (Precio_cliente)
                    </p>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <p class="mb-2">
                        <span style="display: inline-block; width: 3px; height: 20px; background: rgba(0, 0, 0, 0.2); vertical-align: middle;"></span>
                        <strong class="ms-2">Líneas Verticales Gruesas:</strong> Indican cambio de día
                    </p>
                </div>
            </div>
            <p class="text-muted mb-0 mt-2">
                <i class="bi bi-lightbulb"></i>
                <small><strong>Tip:</strong> Busca patrones donde un cambio de precio (área roja) coincida con un aumento o disminución en la cantidad vendida (barras azules). Las fechas aparecen debajo del eje X agrupadas por día.</small>
            </p>
        </div>

        <!-- Segundo gráfico: Franjas de precio -->
        <div class="card-custom" id="chartContainerPrecio" style="display: none;">
            <div class="text-center mb-4">
                <h5 class="fw-bold mb-2">
                    <i class="bi bi-graph-down" style="color: #3498db;"></i>
                    Evolución de Precios por Franjas Horarias
                </h5>
                <p class="text-muted mb-0" style="font-size: 0.9rem;">
                    Visualiza cómo se mantiene el precio a lo largo del tiempo. Cada barra representa un periodo con precio constante.
                </p>
            </div>

            <div class="d-flex justify-content-center">
                <div style="width: 100%; height: 550px; position: relative;">
                    <canvas id="myChartPrecio"></canvas>
                </div>
            </div>

            <!-- Indicadores de referencia -->
            <div class="row mt-3 text-center">
                <div class="col-md-12">
                    <p class="mb-0" style="font-size: 0.85rem;">
                        <i class="bi bi-info-circle text-primary"></i>
                        <span class="text-muted">El color más intenso indica mayor volumen de ventas en ese rango de precio</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let myChart = null;
        let myChartPrecio = null;

        // Función para cargar datos del SKU
        function cargarDatosGrafico() {
            const sku = document.getElementById('skuSelector').value;

            if (!sku) {
                alert('Por favor selecciona un SKU');
                return;
            }

            // Mostrar loading
            document.getElementById('loadingOverlay').classList.add('active');

            // Hacer petición AJAX
            const formData = new FormData();
            formData.append('sku', sku);

            fetch('/ventas-hora-meli-datos', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Ocultar loading
                document.getElementById('loadingOverlay').classList.remove('active');

                if (data.success) {
                    // Mostrar info box
                    document.getElementById('infoBox').style.display = 'block';
                    document.getElementById('infoSku').textContent = data.sku;
                    document.getElementById('infoRegistros').textContent = data.total_registros;

                    // Ocultar mensaje "no data"
                    document.getElementById('noDataMessage').style.display = 'none';
                    document.getElementById('chartContainer').style.display = 'block';
                    document.getElementById('chartContainerPrecio').style.display = 'block';
                    document.getElementById('leyendaContainer').style.display = 'block';

                    // Renderizar gráfico
                    renderizarGrafico(data.datos);

                    // Renderizar gráfico de franjas de precio
                    renderizarGraficoPrecio(data.datos);

                    // Generar tarjetas resumen
                    generarTarjetasResumen(data.datos);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('Error al cargar datos: ' + error);
                console.error('Error:', error);
            });
        }

        // Función para renderizar el gráfico
        function renderizarGrafico(datos) {
            const ctx = document.getElementById('myChart').getContext('2d');

            // Destruir gráfico anterior si existe
            if (myChart) {
                myChart.destroy();
            }

            // Preparar etiquetas personalizadas para el eje X
            const labelsPersonalizados = datos.horas.map((hora, index) => {
                return {
                    hora: hora.toString().padStart(2, '0') + ':00',
                    dia: datos.dias[index]
                };
            });

            // PRE-CALCULAR índices donde cambia el día (para las líneas divisorias)
            const indicesCambioDia = [];
            for (let i = 1; i < datos.dias.length; i++) {
                if (datos.dias[i] !== datos.dias[i - 1]) {
                    indicesCambioDia.push(i);
                    console.log(`Cambio de día detectado en índice ${i}: ${datos.dias[i - 1]} -> ${datos.dias[i]}`);
                }
            }
            console.log('Total de cambios de día:', indicesCambioDia.length);
            console.log('Índices con líneas divisorias:', indicesCambioDia);

            // Plugin para dibujar las líneas divisorias de día
            const lineasDivisoriasPlugin = {
                id: 'lineasDivisorias',
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const chartArea = chart.chartArea;

                    ctx.save();

                    // Dibujar una línea vertical en cada índice de cambio de día
                    indicesCambioDia.forEach(index => {
                        const x = xAxis.getPixelForValue(index);

                        // Dibujar línea vertical gruesa y oscura
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(x, chartArea.top);
                        ctx.lineTo(x, chartArea.bottom);
                        ctx.stroke();
                    });

                    ctx.restore();
                }
            };

            // Plugin para dibujar el nombre del día de la semana como subtítulo
            const diaSubtituloPlugin = {
                id: 'diaSubtitulo',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;

                    ctx.save();
                    ctx.font = '10px Arial';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';

                    // Nombres de los días de la semana en español
                    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

                    // Agrupar índices por día para calcular el punto medio
                    const datosPorDia = {};
                    chart.data.labels.forEach((label, index) => {
                        if (label && label.dia) {
                            const dia = label.dia;
                            if (!datosPorDia[dia]) {
                                datosPorDia[dia] = {
                                    indices: [],
                                    dia: dia
                                };
                            }
                            datosPorDia[dia].indices.push(index);
                        }
                    });

                    // Dibujar el nombre del día en el centro de cada sección
                    Object.values(datosPorDia).forEach(diaInfo => {
                        const indices = diaInfo.indices;
                        const primerIndice = indices[0];
                        const ultimoIndice = indices[indices.length - 1];

                        // Calcular posición X central
                        const xInicio = xAxis.getPixelForValue(primerIndice);
                        const xFin = xAxis.getPixelForValue(ultimoIndice);
                        const xCentro = (xInicio + xFin) / 2;
                        const y = chart.chartArea.bottom + 35;

                        // Parsear la fecha y obtener el día de la semana
                        const fechaParts = diaInfo.dia.split('-');
                        const year = parseInt(fechaParts[0]);
                        const month = parseInt(fechaParts[1]) - 1; // Meses 0-11
                        const day = parseInt(fechaParts[2]);
                        const fechaObj = new Date(year, month, day);

                        // Obtener el nombre del día de la semana
                        const nombreDia = diasSemana[fechaObj.getDay()];

                        ctx.fillText(nombreDia, xCentro, y);
                    });

                    ctx.restore();
                }
            };

            // Crear nuevo gráfico
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsPersonalizados,
                    datasets: [
                        {
                            type: 'line',
                            label: 'Precio Cliente (Área)',
                            data: datos.precios,
                            borderColor: 'rgba(231, 76, 60, 0.8)',
                            backgroundColor: 'rgba(231, 76, 60, 0.15)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Cantidad Vendida',
                            data: datos.cantidades,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 1
                        }
                    ]
                },
                plugins: [lineasDivisoriasPlugin, diaSubtituloPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 150,  // Espacio arriba para las tarjetas
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return datos.dias[index] + ' - ' + datos.horas[index] + ':00 hrs';
                                },
                                afterTitle: function(context) {
                                    const index = context[0].dataIndex;
                                    const killer = datos.killers[index];
                                    return killer === 1 ? '⚡ PRODUCTO KILLER' : '';
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y') {
                                        label += context.parsed.y + ' unidades';
                                    } else {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const ventaNeta = datos.ventas_netas[index];
                                    const variacion = datos.variaciones[index];

                                    let extra = [];
                                    extra.push('Venta Neta: $' + ventaNeta.toFixed(2));
                                    if (variacion !== null && variacion !== 0) {
                                        const signo = variacion > 0 ? '+' : '';
                                        extra.push('Var. vs día ant.: ' + signo + variacion.toFixed(1) + '%');
                                    }
                                    return extra;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                font: {
                                    size: 10
                                },
                                autoSkip: true,
                                maxTicksLimit: 30,
                                callback: function(value, index, ticks) {
                                    const label = this.getLabelForValue(value);
                                    if (label && label.hora) {
                                        // Solo mostrar la hora
                                        return label.hora;
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)', // Líneas normales muy sutiles
                                lineWidth: 1
                            },
                            // Plugin para mostrar el día como subtítulo
                            afterFit: function(scale) {
                                scale.paddingBottom = 40;
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Cantidad Vendida',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#3498db'
                            },
                            ticks: {
                                color: '#3498db'
                            },
                            grid: {
                                color: 'rgba(52, 152, 219, 0.1)'
                            },
                            // Reducir espacio arriba para dejar más margen para las tarjetas
                            grace: '5%',
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Precio ($)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#e74c3c'
                            },
                            ticks: {
                                color: '#e74c3c',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Función para renderizar gráfico de franjas de precio
        function renderizarGraficoPrecio(datos) {
            const ctx = document.getElementById('myChartPrecio').getContext('2d');

            // Destruir gráfico anterior si existe
            if (myChartPrecio) {
                myChartPrecio.destroy();
            }

            // Agrupar datos por franjas de precio continuo
            const franjas = [];
            let franjaActual = null;

            datos.precios.forEach((precio, index) => {
                if (!franjaActual || franjaActual.precio !== precio) {
                    // Cerrar franja anterior si existe
                    if (franjaActual) {
                        franjaActual.indiceFin = index - 1;
                        franjas.push(franjaActual);
                    }

                    // Iniciar nueva franja
                    franjaActual = {
                        precio: precio,
                        indiceInicio: index,
                        indiceFin: index,
                        cantidad: datos.cantidades[index]
                    };
                } else {
                    // Acumular cantidad en la franja actual
                    franjaActual.cantidad += datos.cantidades[index];
                }
            });

            // Cerrar última franja
            if (franjaActual) {
                franjaActual.indiceFin = datos.precios.length - 1;
                franjas.push(franjaActual);
            }

            console.log('Franjas de precio detectadas:', franjas.length);
            console.log('Franjas:', franjas);

            // Preparar labels personalizados (igual que el primer gráfico)
            const labelsPersonalizados = datos.horas.map((hora, index) => {
                return {
                    hora: hora.toString().padStart(2, '0') + ':00',
                    dia: datos.dias[index]
                };
            });

            // Crear datasets para el gráfico
            // Usaremos un gráfico de barras horizontales (floatingBar)
            const datasets = franjas.map((franja, i) => {
                // Usar el mismo color e intensidad para TODOS los rectángulos
                const colorBase = 'rgba(52, 152, 219';
                const intensidad = 0.7; // Color fijo para todos

                return {
                    label: `Precio: $${franja.precio} (${franja.cantidad} unidades)`,
                    data: [{
                        x: [franja.indiceInicio, franja.indiceFin + 1],
                        y: franja.precio
                    }],
                    backgroundColor: `${colorBase}, ${intensidad})`,
                    borderColor: `${colorBase}, 0.9)`,
                    borderWidth: 2,
                    barThickness: 25, // Tamaño fijo para todas las barras
                    maxBarThickness: 25
                };
            });

            // Plugin para mostrar precio y cantidad a la DERECHA del rectángulo
            const textoPrecioIzquierdaPlugin = {
                id: 'textoPrecioIzquierda',
                afterDatasetsDraw: function(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;

                    ctx.save();
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';

                    franjas.forEach((franja, index) => {
                        // Posición X: FIN del rectángulo + pequeño margen
                        const xFin = xAxis.getPixelForValue(franja.indiceFin + 1);
                        const xPos = xFin + 5; // 5px de margen desde el borde derecho

                        // Posición Y: centro del rectángulo
                        const yPosCentro = yAxis.getPixelForValue(franja.precio);

                        // Texto del precio (línea 1)
                        ctx.font = 'bold 11px Arial';
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                        const textoPrecio = `$${franja.precio.toLocaleString('es-ES')}`;
                        ctx.fillText(textoPrecio, xPos, yPosCentro - 6);

                        // Texto de cantidad (línea 2)
                        ctx.font = '10px Arial';
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                        const textoUnidades = `${franja.cantidad} uds`;
                        ctx.fillText(textoUnidades, xPos, yPosCentro + 6);
                    });

                    ctx.restore();
                }
            };

            // Plugin para mostrar días como subtítulo (reutilizado del primer gráfico)
            const diaSubtituloPluginPrecio = {
                id: 'diaSubtituloPrecio',
                afterDraw: function(chart) {
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;

                    ctx.save();
                    ctx.font = '10px Arial';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';

                    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    const datosPorDia = {};

                    labelsPersonalizados.forEach((label, index) => {
                        if (label && label.dia) {
                            const dia = label.dia;
                            if (!datosPorDia[dia]) {
                                datosPorDia[dia] = { indices: [], dia: dia };
                            }
                            datosPorDia[dia].indices.push(index);
                        }
                    });

                    Object.values(datosPorDia).forEach(diaInfo => {
                        const indices = diaInfo.indices;
                        const primerIndice = indices[0];
                        const ultimoIndice = indices[indices.length - 1];
                        const xInicio = xAxis.getPixelForValue(primerIndice);
                        const xFin = xAxis.getPixelForValue(ultimoIndice);
                        const xCentro = (xInicio + xFin) / 2;
                        const y = chart.chartArea.bottom + 35;

                        const fechaParts = diaInfo.dia.split('-');
                        const year = parseInt(fechaParts[0]);
                        const month = parseInt(fechaParts[1]) - 1;
                        const day = parseInt(fechaParts[2]);
                        const fechaObj = new Date(year, month, day);
                        const nombreDia = diasSemana[fechaObj.getDay()];

                        ctx.fillText(nombreDia, xCentro, y);
                    });

                    ctx.restore();
                }
            };

            // Crear gráfico
            myChartPrecio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsPersonalizados,
                    datasets: datasets
                },
                plugins: [textoPrecioIzquierdaPlugin, diaSubtituloPluginPrecio],
                options: {
                    indexAxis: 'y', // Barras horizontales
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 10,
                            right: 150  // Margen derecho amplio para que no se corte el texto
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#2c3e50',
                            bodyColor: '#34495e',
                            borderColor: 'rgba(52, 152, 219, 0.8)',
                            borderWidth: 2,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13, weight: 'bold' },
                            padding: 15,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const franja = franjas[context[0].datasetIndex];
                                    const horaInicio = datos.horas[franja.indiceInicio];
                                    const horaFin = datos.horas[franja.indiceFin];
                                    const diaInicio = datos.dias[franja.indiceInicio];
                                    const diaFin = datos.dias[franja.indiceFin];
                                    return `${diaInicio} ${horaInicio}:00 - ${diaFin} ${horaFin}:00`;
                                },
                                label: function(context) {
                                    const franja = franjas[context.datasetIndex];
                                    return [
                                        `$${franja.precio.toLocaleString('es-ES')}`,
                                        `${franja.cantidad} uds`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0,
                            max: datos.horas.length + 15, // Extender el eje X para dar espacio al texto del último día
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    const label = this.getLabelForValue(value);
                                    if (label && label.hora) {
                                        return label.hora;
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.08)',
                                lineWidth: 1
                            },
                            afterFit: function(scale) {
                                scale.paddingBottom = 40;
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            grace: '15%', // Agregar 15% de espacio arriba y abajo
                            title: {
                                display: true,
                                text: 'Precio ($)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#2c3e50'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#34495e',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES', { maximumFractionDigits: 0 });
                                },
                                padding: 8
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1,
                                drawBorder: true,
                                borderColor: 'rgba(0, 0, 0, 0.2)',
                                borderWidth: 2
                            }
                        }
                    }
                }
            });
        }

        // Función para generar tarjetas resumen flotantes por día
        function generarTarjetasResumen(datos) {
            // Agrupar datos por día y guardar el índice del primer registro de cada día
            const datosPorDia = {};
            const indicesPrimerRegistro = {};

            datos.dias.forEach((dia, index) => {
                if (!datosPorDia[dia]) {
                    datosPorDia[dia] = {
                        fecha: dia,
                        precios: [],
                        cantidades: []
                    };
                    // Guardar el índice del primer registro de este día
                    indicesPrimerRegistro[dia] = index;
                }

                datosPorDia[dia].precios.push(datos.precios[index]);
                datosPorDia[dia].cantidades.push(datos.cantidades[index]);
            });

            // Calcular estadísticas por día y preparar para ordenar
            const resumenDias = [];
            let diaAnterior = null;

            Object.keys(datosPorDia).sort().forEach(dia => {
                const info = datosPorDia[dia];

                // Calcular métricas
                const precioPromedio = info.precios.reduce((a, b) => a + b, 0) / info.precios.length;
                const totalVendido = info.cantidades.reduce((a, b) => a + b, 0);

                // Calcular variaciones vs día anterior
                let variacionPrecio = null;
                let variacionCantidad = null;

                if (diaAnterior) {
                    const precioAnterior = diaAnterior.precioPromedio;
                    const cantidadAnterior = diaAnterior.totalVendido;

                    variacionPrecio = ((precioPromedio - precioAnterior) / precioAnterior) * 100;
                    variacionCantidad = ((totalVendido - cantidadAnterior) / cantidadAnterior) * 100;
                }

                const resumenDia = {
                    fecha: dia,
                    precioPromedio: precioPromedio,
                    totalVendido: totalVendido,
                    variacionPrecio: variacionPrecio,
                    variacionCantidad: variacionCantidad,
                    indicePrimerRegistro: indicesPrimerRegistro[dia]
                };

                resumenDias.push(resumenDia);
                diaAnterior = resumenDia;
            });

            // Generar tarjetas
            const container = document.getElementById('tarjetasResumen');
            container.innerHTML = '';

            // Esperar un momento para que el gráfico se haya renderizado completamente
            setTimeout(() => {
                if (!myChart) return;

                const xAxis = myChart.scales.x;
                const chartArea = myChart.chartArea;

                resumenDias.forEach((dia, indexDia) => {
                    // Calcular la posición X del día en el gráfico
                    const indicePrimerPunto = dia.indicePrimerRegistro;

                    // Calcular el índice del siguiente día o el último punto
                    let indiceUltimoPunto;
                    if (indexDia < resumenDias.length - 1) {
                        indiceUltimoPunto = resumenDias[indexDia + 1].indicePrimerRegistro - 1;
                    } else {
                        indiceUltimoPunto = datos.dias.length - 1;
                    }

                    // Calcular la posición central del día
                    const xInicio = xAxis.getPixelForValue(indicePrimerPunto);
                    const xFin = xAxis.getPixelForValue(indiceUltimoPunto);
                    const xCentro = (xInicio + xFin) / 2;

                    // Calcular posición relativa al contenedor
                    const containerOffset = chartArea.left;
                    const posicionLeft = xCentro - containerOffset - 70; // 70 es aprox. la mitad del ancho de la tarjeta

                    // Formatear fecha - parsear manualmente para evitar problemas de zona horaria
                    const fechaParts = dia.fecha.split('-');
                    const year = parseInt(fechaParts[0]);
                    const month = parseInt(fechaParts[1]) - 1; // Los meses en JS van de 0-11
                    const day = parseInt(fechaParts[2]);
                    const fechaObj = new Date(year, month, day);
                    const fechaFormato = fechaObj.toLocaleDateString('es-MX', {
                        month: 'short',
                        day: 'numeric'
                    });

                    // Crear tarjeta
                    const tarjeta = document.createElement('div');
                    tarjeta.className = 'tarjeta-dia';
                    tarjeta.style.left = posicionLeft + 'px';

                    // Formato de variaciones
                    const formatVariacion = (valor, esPositivo = true) => {
                        if (valor === null) return '<span class="tarjeta-dia-variacion variacion-neutral-bg">--</span>';
                        const clase = valor > 0 ? 'variacion-positiva-bg' : (valor < 0 ? 'variacion-negativa-bg' : 'variacion-neutral-bg');
                        const signo = valor > 0 ? '+' : '';
                        return `<span class="tarjeta-dia-variacion ${clase}">${signo}${valor.toFixed(1)}%</span>`;
                    };

                    tarjeta.innerHTML = `
                        <div class="tarjeta-dia-header">${fechaFormato}</div>
                        <div class="tarjeta-dia-row">
                            <span class="tarjeta-dia-label">Precio:</span>
                            <span class="tarjeta-dia-value">$${dia.precioPromedio.toFixed(0)}</span>
                        </div>
                        <div class="tarjeta-dia-row">
                            <span class="tarjeta-dia-label">Vendido:</span>
                            <span class="tarjeta-dia-value">${dia.totalVendido.toFixed(0)}</span>
                        </div>
                        <div class="tarjeta-dia-row">
                            <span class="tarjeta-dia-label" style="font-size: 0.7rem;">Δ Precio:</span>
                            ${formatVariacion(dia.variacionPrecio)}
                        </div>
                        <div class="tarjeta-dia-row">
                            <span class="tarjeta-dia-label" style="font-size: 0.7rem;">Δ Ventas:</span>
                            ${formatVariacion(dia.variacionCantidad)}
                        </div>
                    `;

                    container.appendChild(tarjeta);
                });

                // Mostrar tarjetas
                document.getElementById('tarjetasResumenContainer').style.display = 'block';
            }, 100); // Pequeño delay para asegurar que el gráfico esté renderizado
        }

        // Event listener para el botón
        document.getElementById('btnCargar').addEventListener('click', cargarDatosGrafico);

        // Cargar automáticamente el primer SKU si existe
        {% if sku_seleccionado %}
        window.addEventListener('load', function() {
            cargarDatosGrafico();
        });
        {% endif %}
    </script>
</body>
</html>
