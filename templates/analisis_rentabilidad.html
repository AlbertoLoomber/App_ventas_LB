{% extends "layout.html" %}

{% block content %}
<style>
/* Estilos para las tarjetas de métricas de rentabilidad */

/* Responsive design para 7 tarjetas en una fila */
@media (max-width: 1400px) {
    #rentabilidadContainer {
        gap: 4px !important;
    }
    #rentabilidadContainer .flex-fill {
        min-width: 130px !important;
        max-width: 160px !important;
    }
}

@media (max-width: 1200px) {
    #rentabilidadContainer {
        flex-wrap: wrap !important;
        gap: 8px !important;
    }
    #rentabilidadContainer .flex-fill {
        min-width: 140px !important;
        max-width: 180px !important;
        flex: 0 0 calc(50% - 4px) !important;
    }
}

@media (max-width: 768px) {
    #rentabilidadContainer .flex-fill {
        flex: 0 0 100% !important;
        max-width: none !important;
    }
}

.subfila-row {
    opacity: 0;
    transform: scale(0.98);
    transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
}

.subfila-row.show {
    opacity: 1;
    transform: scale(1);
}

.subfila-row:hover {
    background-color: rgba(248, 249, 250, 0.8) !important;
}

/* Estilos para las filas de categoría (tercer nivel) */
.categoria-row {
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.3s ease;
}

.categoria-row.show {
    opacity: 1;
    transform: scale(1);
}

.categoria-row:hover {
    background-color: rgba(248, 249, 250, 0.9) !important;
}

/* Animación específica para categorías */
.categoria-row td {
    border-left: 3px solid transparent;
    transition: all 0.3s ease;
}

.categoria-row:hover td {
    border-left: 3px solid rgba(108, 117, 125, 0.3);
}

/* Animación para las tarjetas de métricas */
.rentabilidad-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.rentabilidad-card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}


/* Estilos específicos para la tabla de análisis por canales */
.channel-analysis-table {
    border-collapse: separate !important;
    border-spacing: 0 2px;
}

.channel-analysis-table tbody tr {
    transition: all 0.3s ease;
    border-radius: 8px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    margin-bottom: 4px;
}

.channel-analysis-table tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    background: rgba(248,249,250,0.8);
}

.channel-analysis-table .metric-cell {
    transition: all 0.3s ease;
}

.channel-analysis-table tbody tr:hover .metric-cell {
    transform: scale(1.05);
    background: rgba(23, 162, 184, 0.15) !important;
}

.channel-analysis-table .badge-channel {
    transition: all 0.3s ease;
}

.channel-analysis-table tbody tr:hover .badge-channel {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
}

/* Estilos para el dropdown de SKUs */
.sku-dropdown {
    animation: slideInUp 0.2s ease;
}

.sku-dropdown::-webkit-scrollbar {
    width: 6px;
}

.sku-dropdown::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.sku-dropdown::-webkit-scrollbar-thumb {
    background: rgba(212, 175, 55, 0.5);
    border-radius: 10px;
}

.sku-dropdown::-webkit-scrollbar-thumb:hover {
    background: rgba(212, 175, 55, 0.8);
}

.sku-search-container .form-control:focus {
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.15);
}

.dropdown-item:last-child {
    border-bottom: none !important;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.badge:hover {
    transform: scale(1.05);
}

/* Sticky Headers - Solución mejorada sin overlay */
.channel-analysis-table {
    position: relative;
}

/* Forzar nuevo contexto de apilamiento en la tabla completa */
.channel-analysis-table,
.table-responsive {
    transform: translateZ(0);
    will-change: transform;
}

.channel-analysis-table thead th {
    position: sticky !important;
    top: -15px !important;
    z-index: 1050 !important;
    padding: 40px 15px !important;
    min-height: 110px !important;
    border: none !important;
    border-bottom: 5px solid rgba(0,0,0,0.2) !important;
    font-weight: 700 !important;
    color: #2C2C2C !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    vertical-align: middle !important;
    line-height: 1.3 !important;
    backdrop-filter: saturate(180%) blur(20px);
    margin-top: -10px !important;
}

/* Barrera más grande para evitar que contenido se pase por encima */
.channel-analysis-table thead th::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -5px;
    right: -5px;
    height: 35px;
    z-index: 1051 !important;
    pointer-events: none;
    background: inherit;
    border-radius: 8px 8px 0 0;
}


/* Forzar que todo el contenido de tbody esté en un contexto inferior */
.channel-analysis-table tbody {
    position: relative;
    z-index: 1 !important;
    transform: translateZ(0);
    margin-top: -5px !important;
}

/* Barrera adicional en toda la tabla */
.channel-analysis-table::before {
    content: '';
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    height: 100px;
    background: transparent;
    z-index: 1054 !important;
    pointer-events: none;
    display: block;
    margin-bottom: -100px;
}

.channel-analysis-table tbody tr,
.channel-analysis-table tbody td {
    position: relative;
    z-index: 1 !important;
}

/* Eliminar solo las líneas entre encabezados */
.channel-analysis-table thead th {
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
    padding: 40px 12px !important;
    font-size: 0.87rem !important;
}

/* Optimización mínima de celdas */
.channel-analysis-table tbody td {
    padding: 13px 12px !important;
}

/* Columna de producto con proporción original */
.channel-analysis-table td:first-child {
    max-width: 280px !important;
    padding: 13px 12px !important;
}

/* Badges ligeramente más compactos */
.channel-analysis-table .badge {
    font-size: 0.75rem !important;
    padding: 7px 10px !important;
}

/* Mantener estructura de tabla con proporciones naturales */
.channel-analysis-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100% !important;
}


/* Forzar contexto de apilamiento para la tabla */
.table-responsive {
    position: relative;
    z-index: 1;
    transform: translateZ(0);
}

/* Headers con color base uniforme y barrera reforzada para tablas SKU */
.channel-analysis-table thead th {
    background: #f8f9fa !important;
    z-index: 1052 !important;
}

.channel-analysis-table thead th::before {
    background: #f8f9fa !important;
    z-index: 1053 !important;
}

/* Headers sticky para tabla de Canal - aplicar mismos estilos que las tablas SKU */
.canal-table thead th {
    position: sticky !important;
    top: -15px !important;
    z-index: 1050 !important;
    padding: 40px 12px !important;
    min-height: 110px !important;
    border: none !important;
    border-bottom: 5px solid rgba(0,0,0,0.2) !important;
    font-weight: 700 !important;
    color: #2C2C2C !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    vertical-align: middle !important;
    line-height: 1.3 !important;
    backdrop-filter: saturate(180%) blur(20px);
    margin-top: -10px !important;
    background: #f8f9fa !important;
}

/* Barrera para tabla de Canal para evitar superposiciones */
.canal-table thead th::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -2px;
    right: -2px;
    height: 35px;
    z-index: 1051 !important;
    pointer-events: none;
    background: #f8f9fa !important;
    border-radius: 8px 8px 0 0;
}

/* Optimización de celdas para tabla Canal */
.canal-table tbody td {
    padding: 13px 12px !important;
    position: relative;
    z-index: 1 !important;
}

/* Forzar contexto de apilamiento para tabla Canal */
.canal-table tbody {
    position: relative;
    z-index: 1 !important;
    transform: translateZ(0);
    margin-top: -5px !important;
}


/* Mejorar la visibilidad del texto en sticky headers */
.channel-analysis-table thead th {
    font-weight: 700 !important;
    color: #2C2C2C !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    vertical-align: middle !important;
    line-height: 1.2 !important;
}

/* Forzar contexto de apilamiento más fuerte */
.channel-analysis-table {
    contain: layout style paint;
    isolation: isolate;
}

/* Asegurar que el thead tenga el contexto correcto */
.channel-analysis-table thead {
    position: relative;
    z-index: 99998 !important;
    isolation: isolate;
}

/* Hacer que el tbody esté claramente por debajo */
.channel-analysis-table tbody {
    position: relative;
    z-index: 1 !important;
    isolation: isolate;
}

/* Smooth scroll para mejor experiencia */
html {
    scroll-behavior: smooth;
}

/* Ajuste para contenedores de tabla para mejor scroll */
.table-responsive {
    max-height: 90vh;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 15px;
    position: relative;
}

/* Sombra adicional cuando se hace scroll */
.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    transition: background 0.3s ease;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
}

/* ✅ NUEVO: Estilos para Tooltip de Ingreso Ideal */
.tooltip-ingreso-ideal {
    --bs-tooltip-max-width: 380px;
    --bs-tooltip-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    --bs-tooltip-opacity: 0.98;
}

.tooltip-ingreso-ideal .tooltip-inner {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 16px;
    text-align: left;
    max-width: 380px;
    font-size: 0.9rem;
}

.tooltip-ingreso-ideal .tooltip-arrow::before {
    border-right-color: #1e293b !important;
}

/* Animación de aparición para el icono */
@keyframes pulseIcon {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.bi-exclamation-circle-fill:hover,
.bi-check-circle-fill:hover,
.bi-info-circle:hover {
    animation: pulseIcon 0.6s ease-in-out;
}
</style>

<div class="container mt-4">
    <h2 class="mb-4" data-aos="fade-down" style="color: #2C2C2C; font-weight: 700;">
        <i class="bi bi-graph-up me-3" style="color: #28a745;"></i>Control de Ingreso Real
    </h2>

    <!-- FILTRO PRINCIPAL DE MES -->
    <form method="GET" action="{{ url_for('analisis_rentabilidad.analisis_rentabilidad') }}" id="filtro_form" class="row g-3 align-items-end mb-4" data-aos="fade-down">
        <div class="col-md-3">
            <label for="mes_filtro" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Filtrar por Mes:</strong></label>
            <select class="form-select" name="mes_filtro" id="mes_filtro"
                    onchange="this.form.submit()"
                    style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
                {% if meses_disponibles %}
                    {% for mes_data in meses_disponibles %}
                        <option value="{{ mes_data.valor }}" {% if mes_seleccionado == mes_data.valor %}selected{% endif %}>
                            {{ mes_data.nombre }}
                        </option>
                    {% endfor %}
                {% else %}
                    <!-- Fallback si no hay meses disponibles -->
                    <option value="{{ mes_seleccionado }}" selected>
                        Mes {{ mes_seleccionado }}
                    </option>
                {% endif %}
            </select>
        </div>
    </form>

    {% if error %}
    <div class="alert alert-danger" role="alert" data-aos="shake">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
    </div>
    {% endif %}

    <!-- SECCIÓN: ANÁLISIS DE RENTABILIDAD -->
    <!-- Mostrar siempre que hay datos de ventas -->
    {% if resumen_general and resumen_general.ventas_totales > 0 %}
    <div class="mb-5">
        <h3 class="mb-4" data-aos="fade-down" style="color: #2C2C2C; font-weight: 600; font-size: 1.5rem;">
            <i class="bi bi-bar-chart me-3" style="color: #28a745;"></i>Métricas de Ingreso Real
        </h3>
        
        <div class="d-flex flex-nowrap gap-1 justify-content-center" id="rentabilidadContainer" data-aos="fade-up" data-aos-delay="100" style="overflow: visible; flex-wrap: nowrap;">
            <!-- Ventas Totales -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="200">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(40, 167, 69, 0.2); display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)"
                     onclick="if(window.chartModalInstance) window.chartModalInstance.openModal('ventasEvolucionChart')">
                    
                    <!-- Efecto de fondo sutil -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                         style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08) 0%, transparent 100%);"></div>
                    
                    <!-- Parte superior: Icono + Título + Valor -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto" 
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745, #20c997); 
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-currency-dollar text-white" style="font-size: 1rem;"></i>
                        </div>
                        
                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">Ventas Totales</h6>
                        <p class="mb-1 fw-bold" style="color: #28a745; font-size: 1.4rem; line-height: 1;">
                            <span class="animated-number" 
                                  data-value="{{ resumen_general.ventas_totales }}"
                                  data-type="currency">
                                ${{ "{:,.0f}".format(resumen_general.ventas_totales) }}
                            </span>
                        </p>
                        <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                            Precio promedio: ${{ "{:,.0f}".format(resumen_general.precio_promedio_ventas) }}
                        </small>
                    </div>
                    
                    <!-- Parte inferior: Mini gráfico integrado -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative">
                        <div class="position-relative d-flex justify-content-center" style="height: 80px; margin: 0 auto; width: 98%;">
                            <canvas id="ventasEvolucionChart" 
                                    style="background: transparent;
                                           width: 100%;
                                           height: 80px;
                                           display: block;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso sutil en la parte inferior -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(40, 167, 69, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all" 
                             style="background: linear-gradient(90deg, #28a745, #20c997); 
                                    width: 0%; 
                                    transition: width 1.5s ease 0.5s;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Costo de Venta -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="300">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(220, 53, 69, 0.2); display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)"
                     onclick="if(window.chartModalInstance) window.chartModalInstance.openModal('costoEvolucionChart')"
                     data-bs-toggle="tooltip"
                     data-bs-placement="top"
                     data-bs-title="Incluye IVA 16%"
                     data-bs-html="true">
                    
                    <!-- Efecto de fondo sutil -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                         style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.08) 0%, transparent 100%);"></div>
                    
                    <!-- Parte superior: Icono + Título + Valor -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto" 
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); 
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-currency-dollar text-white" style="font-size: 1rem;"></i>
                        </div>
                        
                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">Costo de Venta</h6>
                        <p class="mb-1 fw-bold" style="color: #dc3545; font-size: 1.4rem; line-height: 1;">
                            <span class="animated-number" 
                                  data-value="{{ resumen_general.costo_venta }}"
                                  data-type="currency">
                                ${{ "{:,.0f}".format(resumen_general.costo_venta) }}
                            </span>
                        </p>
                        <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                            Promedio: ${{ "{:,.0f}".format(resumen_general.precio_promedio_costo) }}
                        </small>
                    </div>
                    
                    <!-- Parte inferior: Mini gráfico integrado -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative">
                        <div class="position-relative d-flex justify-content-center" style="height: 80px; margin: 0 auto; width: 98%;">
                            <canvas id="costoEvolucionChart" 
                                    style="background: transparent;
                                           width: 100%;
                                           height: 80px;
                                           display: block;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso sutil en la parte inferior -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(220, 53, 69, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all" 
                             style="background: linear-gradient(90deg, #dc3545, #c82333); 
                                    width: 0%; 
                                    transition: width 1.5s ease 0.7s;
                                    border-radius: 0 0 12px 12px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Gastos Directos -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="400">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative" 
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(255, 193, 7, 0.2); display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)">
                    
                    <!-- Efecto de fondo sutil -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                         style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, transparent 100%);"></div>
                    
                    <!-- Parte superior: Icono + Título + Valor total -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto" 
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); 
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-receipt text-white" style="font-size: 1rem;"></i>
                        </div>
                        
                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">Gastos Directos</h6>
                        <p class="mb-2 fw-bold" style="color: #ffc107; font-size: 1.2rem; line-height: 1;">
                            <span class="animated-number" 
                                  data-value="{{ resumen_general.gastos_directos }}"
                                  data-type="currency">
                                ${{ "{:,.0f}".format(resumen_general.gastos_directos) }}
                            </span>
                        </p>
                    </div>
                    
                    <!-- Desglose de componentes -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative" style="padding: 0 8px;">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1" style="font-size: 0.7rem;">
                                <span style="color: #6c757d; font-weight: 500;">
                                    <i class="bi bi-percent" style="font-size: 0.6rem; color: #ffc107;"></i>
                                    Comisión
                                </span>
                                <span style="color: #2C2C2C; font-weight: 600;">
                                    ${{ "{:,.0f}".format(resumen_general.comision_periodo) }}
                                </span>
                            </div>
                            <div class="progress" style="height: 3px; background: rgba(255, 193, 7, 0.1);">
                                <div class="progress-bar" style="background: linear-gradient(90deg, #ffc107, #e0a800); width: {{ (resumen_general.comision_periodo / resumen_general.gastos_directos * 100) if resumen_general.gastos_directos > 0 else 0 }}%; transition: width 1.5s ease 0.5s;"></div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1" style="font-size: 0.7rem;">
                                <span style="color: #6c757d; font-weight: 500;">
                                    <i class="bi bi-geo-alt" style="font-size: 0.6rem; color: #ffc107;"></i>
                                    Destino
                                </span>
                                <span style="color: #2C2C2C; font-weight: 600;">
                                    ${{ "{:,.0f}".format(resumen_general.destino_periodo) }}
                                </span>
                            </div>
                            <div class="progress" style="height: 3px; background: rgba(255, 193, 7, 0.1);">
                                <div class="progress-bar" style="background: linear-gradient(90deg, #ffc107, #e0a800); width: {{ (resumen_general.destino_periodo / resumen_general.gastos_directos * 100) if resumen_general.gastos_directos > 0 else 0 }}%; transition: width 1.5s ease 0.7s;"></div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1" style="font-size: 0.7rem;">
                                <span style="color: #6c757d; font-weight: 500;">
                                    <i class="bi bi-truck" style="font-size: 0.6rem; color: #ffc107;"></i>
                                    Última Milla
                                </span>
                                <span style="color: #2C2C2C; font-weight: 600;">
                                    ${{ "{:,.0f}".format(resumen_general.milla_periodo) }}
                                </span>
                            </div>
                            <div class="progress" style="height: 3px; background: rgba(255, 193, 7, 0.1);">
                                <div class="progress-bar" style="background: linear-gradient(90deg, #ffc107, #e0a800); width: {{ (resumen_general.milla_periodo / resumen_general.gastos_directos * 100) if resumen_general.gastos_directos > 0 else 0 }}%; transition: width 1.5s ease 0.9s;"></div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2">
                            <small class="text-muted" style="font-size: 0.7rem; font-weight: 500;">
                                Promedio: ${{ "{:,.0f}".format(resumen_general.precio_promedio_gastos) }}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso sutil en la parte inferior -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(255, 193, 7, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all" 
                             style="background: linear-gradient(90deg, #ffc107, #e0a800); 
                                    width: 0%; 
                                    transition: width 1.5s ease 0.9s;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Ingreso Real -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="500">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid {{ 'rgba(40, 167, 69, 0.2)' if resumen_general.ingreso_real >= 0 else 'rgba(220, 53, 69, 0.2)' }}; display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)"
                     onclick="if(window.chartModalInstance) window.chartModalInstance.openModal('ingresoEvolucionChart')">
                    
                    <!-- Efecto de fondo sutil con color dinámico -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                         style="background: linear-gradient(135deg, {{ 'rgba(40, 167, 69, 0.08)' if resumen_general.ingreso_real >= 0 else 'rgba(220, 53, 69, 0.08)' }} 0%, transparent 100%);"></div>
                    
                    <!-- Parte superior: Icono + Título + Valor -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto" 
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, 
                                    {% if resumen_general.ingreso_real >= 0 %}#28a745, #20c997{% else %}#dc3545, #c82333{% endif %}); 
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-cash-coin text-white" style="font-size: 1rem;"></i>
                        </div>
                        
                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">Ingreso Real</h6>
                        <p class="mb-1 fw-bold" style="color: {% if resumen_general.ingreso_real >= 0 %}#28a745{% else %}#dc3545{% endif %}; font-size: 1.4rem; line-height: 1;">
                            <span class="animated-number" 
                                  data-value="{{ resumen_general.ingreso_real }}"
                                  data-type="currency">
                                ${{ "{:,.0f}".format(resumen_general.ingreso_real) }}
                            </span>
                        </p>
                        <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                            Promedio: ${{ "{:,.0f}".format(resumen_general.precio_promedio_ingreso) }}
                        </small>
                    </div>
                    
                    <!-- Parte inferior: Mini gráfico integrado -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative">
                        <div class="position-relative d-flex justify-content-center" style="height: 80px; margin: 0 auto; width: 98%;">
                            <canvas id="ingresoEvolucionChart" 
                                    style="background: transparent;
                                           width: 100%;
                                           height: 80px;
                                           display: block;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso sutil en la parte inferior con color dinámico -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: {{ 'rgba(40, 167, 69, 0.1)' if resumen_general.ingreso_real >= 0 else 'rgba(220, 53, 69, 0.1)' }}; border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all" 
                             style="background: linear-gradient(90deg, {% if resumen_general.ingreso_real >= 0 %}#28a745, #20c997{% else %}#dc3545, #c82333{% endif %}); 
                                    width: 0%; 
                                    transition: width 1.5s ease 1.1s;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Línea divisoria vertical -->
            <div class="d-flex align-items-center justify-content-center" style="width: 30px;" data-aos="fade-up" data-aos-delay="550">
                <div class="position-relative d-flex align-items-center" style="height: 280px;">
                    <div class="vr-custom" style="height: 240px; width: 3px; border-radius: 2px; 
                                                   background: linear-gradient(180deg, 
                                                   rgba(212, 175, 55, 0.1) 0%, 
                                                   rgba(212, 175, 55, 0.4) 50%, 
                                                   rgba(212, 175, 55, 0.1) 100%);
                                                   box-shadow: 0 0 8px rgba(212, 175, 55, 0.2);
                                                   position: relative;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                    width: 8px; height: 8px; border-radius: 50%;
                                    background: rgba(212, 175, 55, 0.6);
                                    box-shadow: 0 0 6px rgba(212, 175, 55, 0.4);"></div>
                    </div>
                </div>
            </div>
            
            <!-- % Gastos Directos y % Costo de Venta (División Vertical) -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="600">
                <div class="rentabilidad-card border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(255, 193, 7, 0.2); display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)">

                    <!-- SECCIÓN SUPERIOR: % Gastos Directos -->
                    <div class="p-2 text-center position-relative" style="height: 50%; border-bottom: 1px solid rgba(255, 193, 7, 0.1); display: flex; flex-direction: column; justify-content: center;">
                        <!-- Efecto de fondo sutil superior -->
                        <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                             style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, transparent 100%); border-radius: 12px 12px 0 0;"></div>

                        <div class="position-relative">
                            <div class="icon-circle mb-1 mx-auto"
                                 style="width: 30px; height: 30px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9));
                                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-percent text-white" style="font-size: 0.8rem;"></i>
                            </div>

                            <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.75rem;">% Gastos Directos</h6>
                            <p class="mb-0 fw-bold" style="color: #ffc107; font-size: 1.2rem; line-height: 1;">
                                <span class="animated-number"
                                      data-value="{{ resumen_general.gastos_directos_porcentaje }}"
                                      data-type="percentage">
                                    {{ "{:.1f}".format(resumen_general.gastos_directos_porcentaje) }}%
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- SECCIÓN INFERIOR: % Costo de Venta -->
                    <div class="p-2 text-center position-relative" style="height: 50%; display: flex; flex-direction: column; justify-content: center;">
                        <!-- Efecto de fondo sutil inferior -->
                        <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                             style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.08) 0%, transparent 100%); border-radius: 0 0 12px 12px;"></div>

                        <div class="position-relative">
                            <div class="icon-circle mb-1 mx-auto"
                                 style="width: 30px; height: 30px; background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9));
                                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-percent text-white" style="font-size: 0.8rem;"></i>
                            </div>

                            <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.75rem;">% Costo de Venta</h6>
                            <p class="mb-0 fw-bold" style="color: #dc3545; font-size: 1.2rem; line-height: 1;">
                                <span class="animated-number"
                                      data-value="{{ resumen_general.costo_venta_porcentaje }}"
                                      data-type="percentage">
                                    {{ "{:.1f}".format(resumen_general.costo_venta_porcentaje) }}%
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso sutil en la parte inferior -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(255, 193, 7, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all"
                             style="background: linear-gradient(90deg, #ffc107, #dc3545);
                                    width: 0%;
                                    transition: width 1.5s ease 1.3s;
                                    border-radius: 0 0 12px 12px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- % Ingreso Real -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="700">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(40, 167, 69, 0.2); display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)"
                     onclick="if(window.chartModalInstance) window.chartModalInstance.openModal('ingresoEvolucionChartPorcentaje')">

                    <!-- Efecto de fondo sutil -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                         style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.08) 0%, transparent 100%);"></div>

                    <!-- Parte superior: Icono + Título + Valor -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto"
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745, #20c997);
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-graph-up text-white" style="font-size: 1rem;"></i>
                        </div>

                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">% Ingreso Real</h6>
                        <p class="mb-1 fw-bold" style="color: #28a745; font-size: 1.4rem; line-height: 1;">
                            <span class="animated-number"
                                  data-value="{{ resumen_general.ingreso_real_porcentaje }}"
                                  data-type="percentage">
                                {{ "{:.1f}".format(resumen_general.ingreso_real_porcentaje) }}%
                            </span>
                        </p>
                        <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                            ${{ "{:,.0f}".format(resumen_general.ingreso_real) }}
                        </small>
                    </div>

                    <!-- Parte inferior: Mini gráfico integrado -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative">
                        <div class="position-relative d-flex justify-content-center" style="height: 80px; margin: 0 auto; width: 98%;">
                            <canvas id="ingresoEvolucionChartPorcentaje"
                                    style="background: transparent;
                                           width: 100%;
                                           height: 80px;
                                           display: block;"></canvas>
                        </div>
                    </div>

                    <!-- Barra de progreso sutil en la parte inferior -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(40, 167, 69, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all"
                             style="background: linear-gradient(90deg, #28a745, #20c997);
                                    width: 0%;
                                    transition: width 1.5s ease 1.5s;"></div>
                    </div>
                </div>
            </div>

            <!-- ROI -->
            <div class="flex-fill" style="min-width: 140px; max-width: 170px;" data-aos="fade-up" data-aos-delay="800">
                <div class="rentabilidad-card p-3 border rounded-3 bg-white position-relative"
                     style="height: 280px; cursor: pointer; border: 1px solid rgba(32, 201, 151, 0.2);
                            display: flex; flex-direction: column;"
                     onmouseenter="animateMetricCard(this)"
                     onmouseleave="resetMetricCard(this)"
                     onclick="if(window.chartModalInstance) window.chartModalInstance.openModal('roiEvolucionChart')">

                    <!-- Efecto de fondo sutil con color Teal fijo -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                         style="background: linear-gradient(135deg, rgba(32, 201, 151, 0.08) 0%, transparent 100%);"></div>

                    <!-- Parte superior: Icono + Título + Valor -->
                    <div class="text-center position-relative flex-shrink-0">
                        <div class="icon-circle mb-2 mx-auto"
                             style="width: 40px; height: 40px; background: linear-gradient(135deg, #20c997, #17a2b8);
                                    border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-graph-up-arrow text-white" style="font-size: 1rem;"></i>
                        </div>

                        <h6 class="mb-1" style="color: #2C2C2C; font-weight: 600; font-size: 0.85rem;">ROI</h6>
                        <p class="mb-1 fw-bold" style="color: #20c997; font-size: 1.4rem; line-height: 1;">
                            <span class="animated-number"
                                  data-value="{{ resumen_general.roi_promedio }}"
                                  data-type="percentage">
                                {{ "{:.1f}".format(resumen_general.roi_promedio) }}%
                            </span>
                        </p>
                        <small class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                            Retorno de inversión
                        </small>
                    </div>

                    <!-- Parte inferior: Mini gráfico integrado -->
                    <div class="flex-grow-1 d-flex flex-column justify-content-center position-relative">
                        <div class="position-relative d-flex justify-content-center" style="height: 80px; margin: 0 auto; width: 98%;">
                            <canvas id="roiEvolucionChart"
                                    style="background: transparent;
                                           width: 100%;
                                           height: 80px;
                                           display: block;"></canvas>
                        </div>
                    </div>

                    <!-- Barra de progreso sutil en la parte inferior con color Teal fijo -->
                    <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(32, 201, 151, 0.1); border-radius: 0 0 12px 12px;">
                        <div class="h-100 transition-all"
                             style="background: linear-gradient(90deg, #20c997, #17a2b8);
                                    width: 0%;
                                    transition: width 1.5s ease 1.7s;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert" data-aos="fade-up">
        <i class="bi bi-info-circle-fill me-2"></i>No hay datos de ventas disponibles para generar el análisis de rentabilidad.
    </div>
    {% endif %}

    <!-- TABLA DE RESUMEN DETALLADO POR CANAL -->
    {% if canales_principales and canales_principales|length > 0 %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-down">
            <h3 class="mb-0" style="color: #2C2C2C; font-weight: 600; font-size: 1.5rem;">
                <i class="bi bi-table me-3" style="color: #17a2b8;"></i>Resumen Detallado por Canal
            </h3>
            
            <!-- Botones para mostrar/ocultar niveles de desglose -->
            <div class="d-flex gap-2">
                <button type="button" id="toggle-subfilas" class="btn btn-outline-info btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;"
                        onclick="toggleSubfilas()">
                    <i class="bi bi-eye me-2"></i>Ver Desglose por Marca
                </button>

                <button type="button" id="toggle-categorias" class="btn btn-outline-success btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;"
                        onclick="toggleCategorias()">
                    <i class="bi bi-tags me-2"></i>Ver Desglose por Categoría
                </button>
            </div>
        </div>
        
        <div class="table-responsive" data-aos="fade-up" data-aos-delay="100" style="overflow-x: auto; max-width: 100%; background: rgba(248,249,250,0.3); padding: 20px; border-radius: 12px;">
            <table class="table table-hover canal-table" style="background: rgba(248,249,250,0.4); min-width: 1150px; table-layout: fixed; border-radius: 8px;">
                <thead>
                    <tr style="background: #f8f9fa; border: none;">
                        <th class="border-0 py-3 px-3" style="color: #2C2C2C; font-weight: 700; font-size: 0.95rem; width: 170px;">
                            <i class="bi bi-broadcast me-2" style="color: #D4AF37;"></i>Canal
                        </th>
                        <th class="border-0 py-3 px-3 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.9rem; width: 140px;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="border-0 py-3 px-3 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.9rem; width: 130px;">
                            <i class="bi bi-percent me-2" style="color: #dc3545;"></i>Costo Venta
                        </th>
                        <th class="border-0 py-3 px-3 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.9rem; width: 130px;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="border-0 py-3 px-3 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.9rem; width: 130px;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="border-0 py-3 px-2 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.8rem; width: 120px;">
                            <i class="bi bi-pie-chart me-1" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="border-0 py-3 px-2 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.8rem; width: 120px;">
                            <i class="bi bi-graph-up me-1" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="border-0 py-3 px-2 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.8rem; width: 120px;">
                            <i class="bi bi-graph-up-arrow me-1" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="border-0 py-3 px-2 text-center" style="color: #2C2C2C; font-weight: 700; font-size: 0.8rem; width: 110px;">
                            <i class="bi bi-trophy me-1" style="color: #20c997;"></i>%ROI
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for canal in canales_principales %}
                    <tr class="canal-table-row{% if canal.es_subfila %} subfila-row{% endif %}{% if canal.es_categoria_row %} categoria-row{% endif %}"
                        data-canal="{{ canal.canal }}"
                        style="transition: all 0.3s ease; border: none;{% if canal.es_subfila %} background-color: rgba(248, 249, 250, 0.5); display: none;{% endif %}{% if canal.es_categoria_row %} background-color: rgba(248, 249, 250, 0.7); display: none;{% endif %}"
                        onmouseenter="highlightTableRow(this)" 
                        onmouseleave="resetTableRow(this)">
                        <td class="border-0 py-3 px-4" style="vertical-align: middle;">
                            {% if canal.es_fila_principal %}
                            <!-- FILA PRINCIPAL DEL CANAL - SIN CÍRCULO DE ESTADO -->
                            <div class="d-flex align-items-center">
                                <div class="d-flex flex-column">
                                    <span style="font-weight: 700; color: #2C2C2C; font-size: 1.05rem;">{{ canal.canal }}</span>
                                    <small style="color: #6c757d; font-weight: 500;">Total del canal</small>
                                </div>
                            </div>
                            {% elif canal.es_categoria_row %}
                            <!-- SUB-SUB-FILA DE CATEGORÍA -->
                            <div class="d-flex align-items-center" style="padding-left: 20px;">
                                <div class="canal-status-mini me-2"
                                     style="width: 8px; height: 8px; border-radius: 50%;
                                            background: {% if canal.marca_tipo == 'Loomber' %}#D4AF37{% else %}#6c757d{% endif %};">
                                </div>
                                <div class="d-flex flex-column">
                                    <span style="{% if canal.marca_tipo == 'Loomber' %}font-weight: 500; color: #B8860B;{% else %}font-weight: 500; color: #495057;{% endif %} font-size: 0.8rem;">
                                        <i class="bi bi-tag me-1" style="font-size: 0.7rem;"></i>{{ canal.categoria_nombre }}
                                        <span class="badge ms-1"
                                              style="{% if canal.marca_tipo == 'Loomber' %}background-color: rgba(212, 175, 55, 0.1); color: #B8860B; border: 1px solid rgba(212, 175, 55, 0.2);{% else %}background-color: rgba(108, 117, 125, 0.1); color: #495057; border: 1px solid rgba(108, 117, 125, 0.2);{% endif %} font-size: 0.55rem; font-weight: 500; padding: 1px 3px;">
                                            {{ "{:.1f}".format(canal.representacion_ventas) }}%
                                        </span>
                                    </span>
                                    <small style="color: #6c757d; font-weight: 400; font-size: 0.7rem;">{{ "{:,}".format(canal.num_transacciones) }} transacciones</small>
                                </div>
                            </div>
                            {% else %}
                            <!-- SUB-FILA DE MARCA - SIN CÍRCULO DE CUMPLIMIENTO -->
                            <div class="d-flex align-items-center">
                                <div class="canal-status-mini me-3"
                                     style="width: 12px; height: 12px; border-radius: 50%;
                                            background: {% if canal.marca_tipo == 'Loomber' %}#D4AF37{% else %}#6c757d{% endif %};">
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                        {% if canal.marca_tipo == 'Loomber' %}
                                        <i class="bi bi-star-fill" style="color: white; font-size: 0.5rem;"></i>
                                        {% else %}
                                        <i class="bi bi-circle-fill" style="color: white; font-size: 0.4rem;"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="d-flex flex-column">
                                    <span style="{% if canal.marca_tipo == 'Loomber' %}font-weight: 600; color: #D4AF37;{% else %}font-weight: 500; color: #6c757d;{% endif %} font-size: 0.9rem;">
                                        {% if canal.marca_tipo == 'Loomber' %}
                                        Loomber
                                        {% else %}
                                        Otros
                                        {% endif %}
                                        <span class="badge ms-1"
                                              style="{% if canal.marca_tipo == 'Loomber' %}background-color: rgba(212, 175, 55, 0.15); color: #D4AF37; border: 1px solid rgba(212, 175, 55, 0.3);{% else %}background-color: rgba(108, 117, 125, 0.15); color: #6c757d; border: 1px solid rgba(108, 117, 125, 0.3);{% endif %} font-size: 0.6rem; font-weight: 600; padding: 1px 4px;">
                                            {{ "{:.1f}".format(canal.representacion_ventas) }}%
                                        </span>
                                    </span>
                                    <small style="color: #6c757d; font-weight: 500;">{{ "{:,}".format(canal.num_transacciones) }} transacciones</small>
                                </div>
                            </div>
                            {% endif %}
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}#495057{% elif canal.es_subfila %}#2C2C2C{% else %}#28a745{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                ${{ "{:,.0f}".format(canal.ventas_reales) }}
                            </span>
                            {% if canal.es_fila_principal %}
                            <br>
                            <small class="text-muted">
                                Prom: ${{ "{:,.0f}".format(canal.ventas_reales_promedio if canal.ventas_reales_promedio is defined else 0) }}
                            </small>
                            {% endif %}
                            <br>
                            <!-- Indicador de variación vs mes anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_ventas_pct is defined and canal.variacion_ventas_pct != 0 %}
                                    {% if canal.variacion_ventas_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(canal.variacion_ventas_pct) }}%</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(canal.variacion_ventas_pct) }}%</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted" 
                                       style="font-size: 0.6rem; cursor: help;" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Comparación: {{ canal.periodo_comparacion }} ({{ canal.dias_comparados }} días)">
                                    </i>
                                {% else %}
                                    <span class="text-muted fw-normal">Sin datos</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}#495057{% elif canal.es_subfila %}#2C2C2C{% else %}#dc3545{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                ${{ "{:,.0f}".format(canal.costo_venta if canal.costo_venta is defined else 0) }}
                            </span>
                            {% if canal.es_fila_principal %}
                            <br>
                            <small class="text-muted">
                                Prom: ${{ "{:,.0f}".format(canal.costo_venta_promedio if canal.costo_venta_promedio is defined else 0) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}#495057{% elif canal.es_subfila %}#2C2C2C{% else %}#ffc107{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                ${{ "{:,.0f}".format(canal.gastos_directos if canal.gastos_directos is defined else 0) }}
                            </span>
                            {% if canal.es_fila_principal %}
                            <br>
                            <small class="text-muted">
                                Prom: ${{ "{:,.0f}".format(canal.gastos_directos_promedio if canal.gastos_directos_promedio is defined else 0) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}{% if (canal.ingreso_real if canal.ingreso_real is defined else 0) >= 0 %}#495057{% else %}#dc3545{% endif %}{% elif canal.es_subfila %}{% if (canal.ingreso_real if canal.ingreso_real is defined else 0) >= 0 %}#2C2C2C{% else %}#dc3545{% endif %}{% else %}{% if (canal.ingreso_real if canal.ingreso_real is defined else 0) >= 0 %}#6f42c1{% else %}#dc3545{% endif %}{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                {% if (canal.ingreso_real if canal.ingreso_real is defined else 0) >= 0 %}+{% endif %}${{ "{:,.0f}".format(canal.ingreso_real if canal.ingreso_real is defined else 0) }}
                            </span>
                            {% if canal.es_fila_principal %}
                            <br>
                            <small class="text-muted">
                                Prom: ${{ "{:,.0f}".format(canal.ingreso_real_promedio if canal.ingreso_real_promedio is defined else 0) }}
                            </small>
                            {% endif %}
                            <br>
                            <!-- Indicador de variación vs mes anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_ingreso_pct is defined and canal.variacion_ingreso_pct != 0 %}
                                    {% if canal.variacion_ingreso_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(canal.variacion_ingreso_pct) }}%</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(canal.variacion_ingreso_pct) }}%</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted"
                                       style="font-size: 0.6rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Comparación: {{ canal.periodo_comparacion }} ({{ canal.dias_comparados }} días)">
                                    </i>
                                {% else %}
                                    <span class="text-muted fw-normal">Sin datos</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}#495057{% elif canal.es_subfila %}#2C2C2C{% else %}#dc3545{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                {{ "{:.1f}".format(canal.costo_venta_porcentaje if canal.costo_venta_porcentaje is defined else 0) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación vs mes anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_costo_venta_pct is defined and canal.variacion_costo_venta_pct != 0 %}
                                    {% if canal.variacion_costo_venta_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">+{{ "{:.1f}".format(canal.variacion_costo_venta_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">{{ "{:.1f}".format(canal.variacion_costo_venta_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted"
                                       style="font-size: 0.6rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Variación en puntos porcentuales - {{ canal.periodo_comparacion }} ({{ canal.dias_comparados }} días)">
                                    </i>
                                {% else %}
                                    <span class="text-muted fw-normal">Sin datos</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}#495057{% elif canal.es_subfila %}#2C2C2C{% else %}#ffc107{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                {{ "{:.1f}".format(canal.gastos_directos_porcentaje if canal.gastos_directos_porcentaje is defined else 0) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación vs mes anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_gastos_directos_pct is defined and canal.variacion_gastos_directos_pct != 0 %}
                                    {% if canal.variacion_gastos_directos_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">+{{ "{:.1f}".format(canal.variacion_gastos_directos_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">{{ "{:.1f}".format(canal.variacion_gastos_directos_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted"
                                       style="font-size: 0.6rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Variación en puntos porcentuales - {{ canal.periodo_comparacion }} ({{ canal.dias_comparados }} días)">
                                    </i>
                                {% else %}
                                    <span class="text-muted fw-normal">Sin datos</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}{% if (canal.ingreso_real_porcentaje if canal.ingreso_real_porcentaje is defined else 0) >= 0 %}#495057{% else %}#dc3545{% endif %}{% elif canal.es_subfila %}{% if (canal.ingreso_real_porcentaje if canal.ingreso_real_porcentaje is defined else 0) >= 0 %}#2C2C2C{% else %}#dc3545{% endif %}{% else %}{% if (canal.ingreso_real_porcentaje if canal.ingreso_real_porcentaje is defined else 0) >= 0 %}#6f42c1{% else %}#dc3545{% endif %}{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                {{ "{:.1f}".format(canal.ingreso_real_porcentaje if canal.ingreso_real_porcentaje is defined else 0) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación vs mes anterior (PUNTOS PORCENTUALES) -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_ingreso_porcentaje_pct is defined and canal.variacion_ingreso_porcentaje_pct != 0 %}
                                    {% if canal.variacion_ingreso_porcentaje_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(canal.variacion_ingreso_porcentaje_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(canal.variacion_ingreso_porcentaje_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted" 
                                       style="font-size: 0.6rem; cursor: help;" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top"
                                       title="{{ canal.periodo_comparacion if canal.periodo_comparacion is defined else 'Comparación con período anterior' }}"></i>
                                {% else %}
                                    <i class="bi bi-dash text-muted me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-muted fw-normal">Sin cambio</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="border-0 py-3 px-4 text-center" style="vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if canal.es_categoria_row %}{% if (canal.roi_porcentaje if canal.roi_porcentaje is defined else 0) >= 0 %}#495057{% else %}#dc3545{% endif %}{% elif canal.es_subfila %}{% if (canal.roi_porcentaje if canal.roi_porcentaje is defined else 0) >= 0 %}#2C2C2C{% else %}#dc3545{% endif %}{% else %}{% if (canal.roi_porcentaje if canal.roi_porcentaje is defined else 0) >= 0 %}#20c997{% else %}#dc3545{% endif %}{% endif %}; font-size: {% if canal.es_categoria_row %}0.8rem{% elif canal.es_subfila %}0.9rem{% else %}1.05rem{% endif %};">
                                {{ "{:.1f}".format(canal.roi_porcentaje if canal.roi_porcentaje is defined else 0) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación vs mes anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if canal.variacion_roi_pct is defined and canal.variacion_roi_pct != 0 %}
                                    {% if canal.variacion_roi_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(canal.variacion_roi_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(canal.variacion_roi_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted"
                                       style="font-size: 0.6rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="{{ canal.periodo_comparacion if canal.periodo_comparacion is defined else 'Comparación con período anterior' }}"></i>
                                {% else %}
                                    <i class="bi bi-dash text-muted me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-muted fw-normal">Sin cambio</span>
                                {% endif %}
                            </small>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <!-- FILA DE TOTALES -->
                    <tr style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05)); border-top: 2px solid #D4AF37;">
                        <td class="py-3 px-4" style="border: none; vertical-align: middle;">
                            <span style="font-weight: 800; color: #2C2C2C; font-size: 1.05rem;">
                                <i class="bi bi-calculator me-2" style="color: #D4AF37;"></i>TOTALES
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: #28a745; font-size: 1.1rem;">
                                ${{ "{:,.0f}".format(resumen_general.ventas_totales) }}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 1.1rem;">
                                ${{ "{:,.0f}".format(resumen_general.costo_venta if resumen_general.costo_venta is defined else 0) }}
                            </span>
                            <br>
                            <small class="text-muted fw-semibold">
                                Prom: ${{ "{:,.0f}".format(resumen_general.precio_promedio_costo) }}
                            </small>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 1.1rem;">
                                ${{ "{:,.0f}".format(resumen_general.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted fw-semibold">
                                Prom: ${{ "{:,.0f}".format(resumen_general.precio_promedio_gastos) }}
                            </small>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if resumen_general.ingreso_real >= 0 %}#6f42c1{% else %}#dc3545{% endif %}; font-size: 1.1rem;">
                                {% if resumen_general.ingreso_real >= 0 %}+{% endif %}${{ "{:,.0f}".format(resumen_general.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted fw-semibold">
                                Prom: ${{ "{:,.0f}".format(resumen_general.precio_promedio_ingreso) }}
                            </small>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 1.1rem;">
                                {{ "{:.1f}".format(resumen_general.costo_venta_porcentaje) }}%
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 1.1rem;">
                                {{ "{:.1f}".format(resumen_general.gastos_directos_porcentaje) }}%
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if resumen_general.ingreso_real_porcentaje >= 0 %}#6f42c1{% else %}#dc3545{% endif %}; font-size: 1.1rem;">
                                {{ "{:.1f}".format(resumen_general.ingreso_real_porcentaje) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación total vs período anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if resumen_general.variacion_ingreso_pct is defined and resumen_general.variacion_ingreso_pct != 0 %}
                                    {% if resumen_general.variacion_ingreso_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(resumen_general.variacion_ingreso_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(resumen_general.variacion_ingreso_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted" 
                                       style="font-size: 0.6rem; cursor: help;" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top"
                                       title="Total ponderado {{ resumen_general.periodo_comparacion if resumen_general.periodo_comparacion is defined else 'vs período anterior' }}"></i>
                                {% else %}
                                    <i class="bi bi-dash text-muted me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-muted fw-normal">Sin cambio</span>
                                {% endif %}
                            </small>
                        </td>
                        <td class="py-3 px-4 text-center" style="border: none; vertical-align: middle;">
                            <span class="fw-bold" style="color: {% if resumen_general.roi_promedio >= 0 %}#20c997{% else %}#dc3545{% endif %}; font-size: 1.1rem;">
                                {{ "{:.1f}".format(resumen_general.roi_promedio) }}%
                            </span>
                            <br>
                            <!-- Indicador de variación total vs período anterior -->
                            <small class="d-flex align-items-center justify-content-center mt-1" style="font-size: 0.7rem;">
                                {% if resumen_general.variacion_roi_pct is defined and resumen_general.variacion_roi_pct != 0 %}
                                    {% if resumen_general.variacion_roi_pct > 0 %}
                                        <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-success fw-semibold">+{{ "{:.1f}".format(resumen_general.variacion_roi_pct) }}pp</span>
                                    {% else %}
                                        <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                        <span class="text-danger fw-semibold">{{ "{:.1f}".format(resumen_general.variacion_roi_pct) }}pp</span>
                                    {% endif %}
                                    <!-- Tooltip con información del período de comparación -->
                                    <i class="bi bi-info-circle ms-1 text-muted"
                                       style="font-size: 0.6rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="Total ponderado {{ resumen_general.periodo_comparacion if resumen_general.periodo_comparacion is defined else 'vs período anterior' }}"></i>
                                {% else %}
                                    <i class="bi bi-dash text-muted me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-muted fw-normal">Sin cambio</span>
                                {% endif %}
                            </small>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- NUEVA SECCIÓN: RESUMEN DETALLADO POR SKU ESTRELLA -->
    {% if (skus_estrella and skus_estrella|length > 0) or (skus_prometedores and skus_prometedores|length > 0) or (skus_potenciales and skus_potenciales|length > 0) or (skus_revision and skus_revision|length > 0) or (skus_remover and skus_remover|length > 0) %}
    <div class="mb-5" data-aos="fade-up" data-aos-delay="150">
        <div class="mb-4" data-aos="fade-down">
            <!-- Primera fila: Título y espacio para nuevos botones -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0" style="color: #2C2C2C; font-weight: 600; font-size: 1.5rem;">
                    <i class="bi bi-trophy me-3" style="color: #D4AF37;"></i>Resumen Detallado por SKU Prioritario
                </h3>

                <!-- Botones de acciones adicionales -->
                <div class="d-flex gap-2">
                    <button type="button" id="btn-desglose-canales" class="btn btn-outline-primary btn-sm"
                            style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;"
                            onclick="toggleCanalesSku()">
                        <i class="bi bi-eye me-2"></i>Ver Desglose por Canal
                    </button>

                    <button type="button" id="btn-desglose-meses" class="btn btn-outline-info btn-sm ms-2"
                            style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;"
                            onclick="toggleMesesSku()">
                        <i class="bi bi-calendar3 me-2"></i>Ver Desglose por Mes
                    </button>
                </div>
            </div>

            <!-- Segunda fila: Botones de clasificaciones -->
            <div class="d-flex gap-2">
                <button type="button" id="toggle-estrella" class="btn btn-warning btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;
                               background: linear-gradient(135deg, #D4AF37, #B8941F); border: none; color: white;"
                        onclick="toggleClasificacion('estrella')">
                    <i class="bi bi-star-fill me-2"></i>SKUs Estrella
                </button>

                <!-- Botón para expandir/colapsar SKUs unificados (solo visible cuando se muestran SKUs Estrella) -->
                <button type="button" id="toggle-skus-componentes" class="btn btn-outline-warning btn-sm" style="display: none;
                        border-radius: 8px; padding: 6px 12px; font-weight: 500; transition: all 0.3s ease;
                        border-color: #D4AF37; color: #B8941F; font-size: 0.8rem;"
                        onclick="toggleSkusComponentes('estrella')">
                    <i class="bi bi-arrows-expand me-1"></i>Expandir Unificados
                </button>

                <button type="button" id="toggle-prometedores" class="btn btn-outline-secondary btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;
                               border-color: #6c757d; color: #6c757d;"
                        onclick="toggleClasificacion('prometedores')">
                    <i class="bi bi-gem me-2"></i>SKUs Prometedores
                </button>

                <!-- Botón para expandir/colapsar SKUs unificados de Prometedores -->
                <button type="button" id="toggle-skus-componentes-prometedores" class="btn btn-outline-secondary btn-sm" style="display: none;
                        border-radius: 8px; padding: 6px 12px; font-weight: 500; transition: all 0.3s ease;
                        border-color: #6c757d; color: #495057; font-size: 0.8rem;"
                        onclick="toggleSkusComponentes('prometedores')">
                    <i class="bi bi-arrows-expand me-1"></i>Expandir Unificados
                </button>

                <button type="button" id="toggle-potenciales" class="btn btn-outline-info btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;
                               border-color: #17a2b8; color: #17a2b8;"
                        onclick="toggleClasificacion('potenciales')">
                    <i class="bi bi-lightning me-2"></i>SKUs Potenciales
                </button>

                <!-- Botón para expandir/colapsar SKUs unificados de Potenciales -->
                <button type="button" id="toggle-skus-componentes-potenciales" class="btn btn-outline-info btn-sm" style="display: none;
                        border-radius: 8px; padding: 6px 12px; font-weight: 500; transition: all 0.3s ease;
                        border-color: #17a2b8; color: #138496; font-size: 0.8rem;"
                        onclick="toggleSkusComponentes('potenciales')">
                    <i class="bi bi-arrows-expand me-1"></i>Expandir Unificados
                </button>

                <button type="button" id="toggle-revision" class="btn btn-outline-warning btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;
                               border-color: #fd7e14; color: #fd7e14;"
                        onclick="toggleClasificacion('revision')">
                    <i class="bi bi-exclamation-triangle me-2"></i>SKUs Revisión
                </button>

                <!-- Botón para expandir/colapsar SKUs unificados de Revisión -->
                <button type="button" id="toggle-skus-componentes-revision" class="btn btn-outline-warning btn-sm" style="display: none;
                        border-radius: 8px; padding: 6px 12px; font-weight: 500; transition: all 0.3s ease;
                        border-color: #fd7e14; color: #e85d04; font-size: 0.8rem;"
                        onclick="toggleSkusComponentes('revision')">
                    <i class="bi bi-arrows-expand me-1"></i>Expandir Unificados
                </button>

                <button type="button" id="toggle-remover" class="btn btn-outline-danger btn-sm"
                        style="border-radius: 8px; padding: 8px 16px; font-weight: 600; transition: all 0.3s ease;
                               border-color: #dc3545; color: #dc3545;"
                        onclick="toggleClasificacion('remover')">
                    <i class="bi bi-trash me-2"></i>SKUs Remover
                </button>

                <!-- Botón para expandir/colapsar SKUs unificados de Remover -->
                <button type="button" id="toggle-skus-componentes-remover" class="btn btn-outline-danger btn-sm" style="display: none;
                        border-radius: 8px; padding: 6px 12px; font-weight: 500; transition: all 0.3s ease;
                        border-color: #dc3545; color: #c92a2a; font-size: 0.8rem;"
                        onclick="toggleSkusComponentes('remover')">
                    <i class="bi bi-arrows-expand me-1"></i>Expandir Unificados
                </button>
            </div>
        </div>

        <!-- TABLA DE SKUs ESTRELLA -->
        <div id="tabla-estrella" class="table-responsive" style="background: linear-gradient(135deg, rgba(248,249,250,0.4), rgba(233,236,239,0.3)); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);">
            {% if skus_estrella and skus_estrella|length > 0 %}
            <table class="table table-hover mb-0 channel-analysis-table" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(212, 175, 55, 0.2);">
                        <th style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-box me-2" style="color: #D4AF37;"></i>Producto
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #dc3545;"></i>Costo de Venta
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-down me-2" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up-arrow me-2" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-trophy me-2" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="text-center" style="background: rgba(212, 175, 55, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up me-2" style="color: #20c997;"></i>ROI %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sku_data in skus_estrella %}
                    <!-- Verificar si es fila de totales -->
                    {% if sku_data.es_fila_total %}
                    <!-- FILA DE TOTALES ESTRELLA -->
                    <tr style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08)); border-top: 3px solid #D4AF37; border-bottom: 2px solid #D4AF37; font-weight: 700;">
                        <td style="padding: 18px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #D4AF37, #B8941F) !important; box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);">
                                        <i class="bi bi-calculator text-white" style="font-size: 1rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="mb-2">
                                        <span class="badge px-4 py-2"
                                              style="background: linear-gradient(135deg, #D4AF37, #B8941F);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.85rem;
                                                     border-radius: 15px;
                                                     box-shadow: 0 3px 6px rgba(212, 175, 55, 0.4);">
                                            TOTAL ESTRELLA
                                        </span>
                                    </div>
                                    <div style="line-height: 1.3;">
                                        <span style="color: #2C2C2C; font-size: 0.85rem; font-weight: 600;">
                                            Consolidado de todos los SKUs Estrella
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <small style="color: #D4AF37; font-size: 0.75rem; font-weight: 600;">
                                            <i class="bi bi-receipt me-1"></i>{{ sku_data.num_transacciones }} transacciones totales
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% else %}
                    <!-- FILA NORMAL DE SKU -->
                    <tr {% if sku_data.get('es_sku_componente', False) %}class="sku-componente" data-principal="{{ sku_data.sku_principal }}" style="display: none; transition: all 0.3s ease; background: rgba(248, 249, 250, 0.8); border-left: 3px solid #dee2e6; margin-left: 20px;"{% else %}style="transition: all 0.3s ease; {% if sku_data.get('es_producto_unificado', False) %}background: linear-gradient(135deg, rgba(255, 193, 7, 0.08), rgba(212, 175, 55, 0.05)); border-left: 4px solid #ffc107; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);{% endif %}"{% endif %}>
                        <td style="padding: 15px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if sku_data.get('es_sku_componente', False) %}
                                    <!-- Icono para SKUs componentes -->
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 30px; height: 30px; background: linear-gradient(135deg, #6c757d, #495057) !important; margin-left: 15px;">
                                        <i class="bi bi-arrow-return-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                    {% elif sku_data.get('es_producto_unificado', False) %}
                                    <!-- Icono especial para productos unificados -->
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #ffc107, #D4AF37) !important; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);">
                                        <i class="bi bi-collection text-white" style="font-size: 0.9rem;"></i>
                                    </div>
                                    {% else %}
                                    <!-- Icono normal para SKUs individuales -->
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 35px; height: 35px; background: linear-gradient(135deg, #D4AF37, #B8941F) !important;">
                                        <i class="bi bi-star-fill text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <!-- SKU con fondito bonito -->
                                    <div class="mb-2">
                                        {% if sku_data.get('es_sku_componente', False) %}
                                        <!-- Badge para SKUs componentes -->
                                        <span class="badge px-2 py-1"
                                              style="background: linear-gradient(135deg, #6c757d, #495057);
                                                     color: white;
                                                     font-weight: 500;
                                                     font-size: 0.7rem;
                                                     border-radius: 8px;
                                                     box-shadow: 0 1px 3px rgba(108, 117, 125, 0.3);">
                                            <i class="bi bi-arrow-return-right me-1" style="font-size: 0.6rem;"></i>{{ sku_data.sku }}
                                        </span>
                                        {% elif sku_data.get('es_producto_unificado', False) %}
                                        <!-- Badge especial para productos unificados -->
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #ffc107, #D4AF37);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.8rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 3px 6px rgba(255, 193, 7, 0.4);">
                                            <i class="bi bi-collection me-1"></i>{{ sku_data.sku }}
                                        </span>
                                        {% else %}
                                        <!-- Badge normal para SKUs individuales -->
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #D4AF37, #B8941F);
                                                     color: white;
                                                     font-weight: 600;
                                                     font-size: 0.75rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);">
                                            {{ sku_data.sku }}
                                        </span>
                                        {% endif %}
                                    </div>

                                    <!-- Descripción del producto -->
                                    <div style="line-height: 1.3;" class="d-flex align-items-center gap-2">
                                        <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                            {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                                        </span>

                                        <!-- Ícono de Inventario con Tooltip -->
                                        {% set inv_disp = inventario_disponible.get(sku_data.sku, {}) %}
                                        {% set inv_trans = inventario_transito.get(sku_data.sku, {}) %}
                                        {% if inv_disp or inv_trans %}
                                        <span class="inventory-icon-wrapper" style="position: relative; display: inline-block;">
                                            <i class="bi bi-box-seam"
                                               style="font-size: 1.1rem; color: #6c757d; cursor: pointer; transition: all 0.2s ease;"
                                               onmouseenter="this.style.color='#495057'; this.style.transform='scale(1.15)'"
                                               onmouseleave="this.style.color='#6c757d'; this.style.transform='scale(1)'"
                                               data-bs-toggle="tooltip"
                                               data-bs-html="true"
                                               data-bs-placement="right"
                                               title="<div style='text-align: left; font-size: 0.9rem; min-width: 320px; max-width: 450px; padding: 4px;'>
                                                   <div style='font-weight: 700; font-size: 1rem; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.25); color: #fff;'>
                                                       📦 Control de Inventario
                                                   </div>

                                                   {% if inv_disp and inv_disp.total > 0 %}
                                                   <div style='margin-bottom: 14px; padding: 10px; background: rgba(40, 167, 69, 0.15); border-radius: 6px; border-left: 3px solid #28a745;'>
                                                       <div style='font-weight: 700; color: #28a745; margin-bottom: 8px; font-size: 0.95rem;'>
                                                           ✅ DISPONIBLE AHORA
                                                       </div>
                                                       <div style='font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 10px; padding-left: 4px;'>
                                                           Total: {{ '{:,.0f}'.format(inv_disp.total) }} unidades
                                                       </div>
                                                       <div style='font-size: 0.85rem; color: rgba(255,255,255,0.9); line-height: 1.8; padding-left: 4px;'>
                                                           <div style='font-weight: 600; margin-bottom: 6px; color: rgba(255,255,255,0.95);'>📍 Distribución por Almacén:</div>
                                                           {% for alm in inv_disp.almacenes %}
                                                           <div style='padding: 3px 0; padding-left: 12px;'>
                                                               <span style='color: #90EE90; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>{{ alm.almacen }}:</span>
                                                               <span style='color: #fff; font-weight: 700;'>{{ '{:,.0f}'.format(alm.cantidad) }}</span> uds
                                                           </div>
                                                           {% endfor %}
                                                       </div>
                                                   </div>
                                                   {% else %}
                                                   <div style='margin-bottom: 14px; padding: 10px; background: rgba(220, 53, 69, 0.15); border-radius: 6px; border-left: 3px solid #dc3545;'>
                                                       <div style='font-weight: 600; color: #ff6b6b; font-size: 0.9rem;'>
                                                           ⚠️ Sin existencias disponibles
                                                       </div>
                                                   </div>
                                                   {% endif %}

                                                   {% if inv_trans and inv_trans.total > 0 %}
                                                   <div style='padding: 10px; background: rgba(255, 193, 7, 0.15); border-radius: 6px; border-left: 3px solid #ffc107;'>
                                                       <div style='font-weight: 700; color: #ffc107; margin-bottom: 8px; font-size: 0.95rem;'>
                                                           🚚 EN TRÁNSITO
                                                       </div>
                                                       <div style='font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 10px; padding-left: 4px;'>
                                                           Total: {{ '{:,.0f}'.format(inv_trans.total) }} unidades
                                                       </div>
                                                       <div style='font-size: 0.85rem; color: rgba(255,255,255,0.9); line-height: 1.8; padding-left: 4px;'>
                                                           <div style='font-weight: 600; margin-bottom: 6px; color: rgba(255,255,255,0.95);'>📅 Por Fecha de Llegada:</div>
                                                           {% if inv_trans.esta_semana > 0 %}
                                                           <div style='padding: 3px 0; padding-left: 12px;'>
                                                               <span style='color: #FFD700; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>Esta semana (próximos 7 días):</span><br>
                                                               <span style='color: #fff; font-weight: 700; padding-left: 18px;'>{{ '{:,.0f}'.format(inv_trans.esta_semana) }}</span> uds
                                                           </div>
                                                           {% endif %}
                                                           {% if inv_trans.proximas_semanas > 0 %}
                                                           <div style='padding: 3px 0; padding-left: 12px; {% if inv_trans.esta_semana > 0 %}margin-top: 6px;{% endif %}'>
                                                               <span style='color: #FFD700; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>Próximas semanas (después de 7 días):</span><br>
                                                               <span style='color: #fff; font-weight: 700; padding-left: 18px;'>{{ '{:,.0f}'.format(inv_trans.proximas_semanas) }}</span> uds
                                                           </div>
                                                           {% endif %}
                                                           <div style='margin-top: 8px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.8rem; color: rgba(255,255,255,0.85);'>
                                                               <span style='font-weight: 600;'>💡 Detalle:</span> {{ inv_trans.envios|length }} envío{% if inv_trans.envios|length > 1 %}s{% endif %} programado{% if inv_trans.envios|length > 1 %}s{% endif %}
                                                           </div>
                                                       </div>
                                                   </div>
                                                   {% else %}
                                                   <div style='padding: 10px; background: rgba(108, 117, 125, 0.15); border-radius: 6px; border-left: 3px solid #6c757d;'>
                                                       <div style='font-weight: 600; color: #adb5bd; font-size: 0.9rem;'>
                                                           ℹ️ Sin envíos en tránsito recientes
                                                       </div>
                                                   </div>
                                                   {% endif %}

                                                   {% if not inv_disp and not inv_trans %}
                                                   <div style='padding: 15px; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9rem; font-style: italic;'>
                                                       Sin información de inventario disponible
                                                   </div>
                                                   {% endif %}
                                               </div>">
                                            </i>
                                        </span>
                                        {% endif %}
                                    </div>

                                    {% if sku_data.get('es_producto_unificado', False) %}
                                    <!-- Subtítulo más compacto con SKUs componentes -->
                                    <div class="mt-1">
                                        <small style="color: #856404; font-weight: 500; font-size: 0.6rem; line-height: 1.2;">
                                            <i class="bi bi-boxes" style="font-size: 0.55rem;"></i>
                                            {% for sku_componente in sku_data.skus_componentes %}
                                            <span class="badge"
                                                  style="background: rgba(255, 193, 7, 0.12);
                                                         color: #856404;
                                                         font-size: 0.5rem;
                                                         font-weight: 400;
                                                         border-radius: 3px;
                                                         padding: 1px 3px;
                                                         margin: 0 1px;">
                                                {{ sku_componente }}
                                            </span>
                                            {% endfor %}
                                        </small>
                                    </div>
                                    {% endif %}

                                    <!-- Número de transacciones -->
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #D4AF37;"></i>{{ sku_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% endif %}

                        <!-- Celdas de datos con diferentes estilos según si es fila de total o no -->
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}mt-1{% endif %}" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if sku_data.ingreso_real >= 0 else '#dc3545' }}; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.get('periodo_comparacion', 'Sin comparación') }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}mt-1{% endif %}" style="font-size: {% if sku_data.get('es_fila_total', False) %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.get('ingreso_real_promedio', 0)) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.costo_venta_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if sku_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_roi_pct is defined and sku_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Subfilas de canal para SKU Estrella -->
                    {% for canal_data in sku_data.desglose_canales %}
                    <tr class="canal-subfila canal-subfila-estrella-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(212, 175, 55, 0.05); border-left: 4px solid #D4AF37;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-chevron-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ canal_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #D4AF37;"></i>{{ canal_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>

                                <!-- ✅ NUEVO: Tooltip de Ingreso Ideal -->
                                {% if canal_data.tiene_ingreso_ideal %}
                                <div class="ms-2">
                                    <i class="bi bi-info-circle text-warning"
                                       style="font-size: 1.1rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"
                                       data-bs-placement="right"
                                       data-bs-custom-class="tooltip-ingreso-ideal"
                                       title="
                                       <div style='text-align: left; min-width: 340px; font-family: Consolas, Monaco, monospace;'>
                                           <!-- Título -->
                                           <div style='font-size: 1em; font-weight: 700; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3);'>
                                               INGRESO IDEAL
                                           </div>

                                           <!-- Barras de Comparación con Escala Dinámica -->
                                           <div style='margin-bottom: 10px; font-size: 0.85em; line-height: 1.8;'>
                                               <!-- Calcular el máximo para escalar -->
                                               {% if canal_data.ir_ideal >= canal_data.ingreso_real_porcentaje %}
                                                   {% set max_value = canal_data.ir_ideal %}
                                                   {% set bars_ideal = 10 %}
                                                   {% set bars_actual = ((canal_data.ingreso_real_porcentaje / canal_data.ir_ideal) * 10) | int if canal_data.ir_ideal > 0 else 0 %}
                                               {% else %}
                                                   {% set max_value = canal_data.ingreso_real_porcentaje %}
                                                   {% set bars_actual = 10 %}
                                                   {% set bars_ideal = ((canal_data.ir_ideal / canal_data.ingreso_real_porcentaje) * 10) | int if canal_data.ingreso_real_porcentaje > 0 else 0 %}
                                               {% endif %}

                                               <div style='display: flex; align-items: center; margin-bottom: 5px;'>
                                                   <span style='width: 90px;'>IR Actual:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #a78bfa;'>{{ '█' * bars_actual }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_actual) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #a78bfa;'>{{ '{:.1f}'.format(canal_data.ingreso_real_porcentaje) }}%</span>
                                               </div>

                                               <div style='display: flex; align-items: center;'>
                                                   <span style='width: 90px;'>IR Ideal:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #34d399;'>{{ '█' * bars_ideal }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_ideal) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre barras y componentes -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Componentes del Ideal - Formato Compacto 2 Columnas -->
                                           <div style='margin-bottom: 8px;'>
                                               <div style='font-weight: 600; margin-bottom: 6px; font-size: 0.9em;'>Componentes:</div>
                                               <div style='font-size: 0.8em; line-height: 1.6; font-family: Consolas, monospace;'>
                                                   <!-- Fila 1: Base y Calidad -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Base: <span style='font-weight: 700; color: #60a5fa;'>{{ '{:.1f}'.format(canal_data.ir_base) }}%</span></span>
                                                       <span style='flex: 1; text-align: right;'>Calidad: <span style='font-weight: 700; color: #a3e635;'>+{{ '{:.1f}'.format(canal_data.factor_calidad) }}</span></span>
                                                   </div>
                                                   <!-- Fila 2: Diferenciador y Percepción -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Diferenciador: <span style='font-weight: 700; color: #86efac;'>+{{ '{:.1f}'.format(canal_data.factor_diferenciador) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Percepción: <span style='font-weight: 700; color: #fde047;'>+{{ '{:.1f}'.format(canal_data.factor_percepcion) }}</span></span>
                                                   </div>
                                                   <!-- Fila 3: Funcionalidad y Competencia -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Funcionalidad: <span style='font-weight: 700; color: #facc15;'>+{{ '{:.1f}'.format(canal_data.factor_funcionalidad) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Competencia: <span style='font-weight: 700; color: #fca5a5;'>+{{ '{:.1f}'.format(canal_data.factor_competencia) }}</span></span>
                                                   </div>
                                                   <!-- Total IR Final -->
                                                   <div style='border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 6px; padding-top: 6px; font-weight: 700;'>
                                                       <span>= IR Final: <span style='color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span></span>
                                                   </div>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre IR Final y Potencial -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Potencial de Mejora / Mensaje Final -->
                                           {% if canal_data.gap_ingreso_pp < -1 %}
                                           <div style='background: rgba(251, 191, 36, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #fbbf24;'>
                                               <span style='font-weight: 700;'>💡 Potencial:</span>
                                               <span style='color: #fbbf24; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                               <span style='color: rgba(255,255,255,0.7);'>(+${{ '{:,.0f}'.format(canal_data.potencial_mensual) }}/mes)</span>
                                           </div>
                                           {% elif canal_data.gap_ingreso_pp >= 0 %}
                                           <div style='background: rgba(52, 211, 153, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #34d399;'>
                                               <span style='font-weight: 700; color: #34d399;'>✓ Superando ideal:</span>
                                               <span style='color: #34d399; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                           </div>
                                           {% endif %}
                                       </div>
                                       ">
                                    </i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ventas_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ingreso_pct != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ingreso_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.costo_venta_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real por canal (PUNTOS PORCENTUALES) -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_roi_pct is defined and canal_data.variacion_roi_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ROI por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Subfilas temporales para SKU Estrella -->
                    {% for mes_data in sku_data.desglose_meses %}
                    <tr class="mes-subfila mes-subfila-estrella-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(255, 193, 7, 0.05); border-left: 4px solid #ffc107;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-calendar3 text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 600;">
                                        {{ mes_data.mes_corto }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-calendar-range me-1" style="color: #ffc107;"></i>{{ mes_data.periodo }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.costo_venta_promedio if mes_data.costo_venta_promedio is defined else mes_data.costo_venta) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.gastos_directos_promedio if mes_data.gastos_directos_promedio is defined else mes_data.gastos_directos) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ingreso_real_promedio if mes_data.ingreso_real_promedio is defined else mes_data.ingreso_real) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>

                    <!-- Subfilas de canal por mes para SKU Estrella (cuando ambos desgloses están activos) -->
                    {% for canal_mes_data in mes_data.desglose_canales %}
                    <tr class="canal-mes-subfila canal-mes-subfila-estrella-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(255, 193, 7, 0.03); border-left: 4px solid #ffc107;">
                        <td style="padding: 8px 15px 8px 75px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 20px; height: 20px; opacity: 0.5;">
                                        <i class="bi bi-arrow-right text-white" style="font-size: 0.6rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                        {{ canal_mes_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.65rem;">
                                            <i class="bi bi-receipt me-1" style="color: #ffc107;"></i>{{ canal_mes_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-star text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay SKUs clasificados como Estrella en este período</p>
            </div>
            {% endif %}
        </div>

        <!-- TABLA DE SKUs PROMETEDORES -->
        <div id="tabla-prometedores" class="table-responsive" style="background: linear-gradient(135deg, rgba(248,249,250,0.4), rgba(233,236,239,0.3)); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none;">
            {% if skus_prometedores and skus_prometedores|length > 0 %}
            <table class="table table-hover mb-0 channel-analysis-table" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(108, 117, 125, 0.2);">
                        <th style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-box me-2" style="color: #6c757d;"></i>Producto
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #dc3545;"></i>Costo de Venta
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-down me-2" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up-arrow me-2" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-trophy me-2" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="text-center" style="background: rgba(108, 117, 125, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up me-2" style="color: #20c997;"></i>ROI %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sku_data in skus_prometedores %}
                    <!-- Verificar si es fila de totales -->
                    {% if sku_data.es_fila_total %}
                    <!-- FILA DE TOTALES PROMETEDORES -->
                    <tr style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.15), rgba(108, 117, 125, 0.08)); border-top: 3px solid #6c757d; border-bottom: 2px solid #6c757d; font-weight: 700;">
                        <td style="padding: 18px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #6c757d, #495057) !important; box-shadow: 0 4px 8px rgba(108, 117, 125, 0.4);">
                                        <i class="bi bi-calculator text-white" style="font-size: 1rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="mb-2">
                                        <span class="badge px-4 py-2"
                                              style="background: linear-gradient(135deg, #6c757d, #495057);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.85rem;
                                                     border-radius: 15px;
                                                     box-shadow: 0 3px 6px rgba(108, 117, 125, 0.4);">
                                            TOTAL PROMETEDORES
                                        </span>
                                    </div>
                                    <div style="line-height: 1.3;">
                                        <span style="color: #2C2C2C; font-size: 0.85rem; font-weight: 600;">
                                            Consolidado de todos los SKUs Prometedores
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <small style="color: #6c757d; font-size: 0.75rem; font-weight: 600;">
                                            <i class="bi bi-receipt me-1"></i>{{ sku_data.num_transacciones }} transacciones totales
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% else %}
                    <!-- FILA NORMAL DE SKU -->
                    <tr {% if sku_data.get('es_sku_componente', False) %}class="sku-componente" data-principal="{{ sku_data.sku_principal }}" style="display: none; transition: all 0.3s ease; background: rgba(248, 249, 250, 0.8); border-left: 3px solid #dee2e6; margin-left: 20px;"{% else %}style="transition: all 0.3s ease; {% if sku_data.get('es_producto_unificado', False) %}background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.05)); border-left: 4px solid #6c757d; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.15);{% endif %}"{% endif %}>
                        <td style="padding: 15px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if sku_data.get('es_sku_componente', False) %}
                                    <!-- Icono para SKUs componentes -->
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 30px; height: 30px; background: linear-gradient(135deg, #6c757d, #495057) !important; margin-left: 15px;">
                                        <i class="bi bi-arrow-return-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                    {% elif sku_data.get('es_producto_unificado', False) %}
                                    <!-- Icono especial para productos unificados -->
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #6c757d, #495057) !important; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);">
                                        <i class="bi bi-collection text-white" style="font-size: 0.9rem;"></i>
                                    </div>
                                    {% else %}
                                    <!-- Icono normal para SKUs individuales -->
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 35px; height: 35px; background: linear-gradient(135deg, #6c757d, #495057) !important;">
                                        <i class="bi bi-gem text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <!-- SKU con fondito bonito -->
                                    <div class="mb-2">
                                        {% if sku_data.get('es_sku_componente', False) %}
                                        <!-- Badge para SKUs componentes -->
                                        <span class="badge px-2 py-1"
                                              style="background: linear-gradient(135deg, #6c757d, #495057);
                                                     color: white;
                                                     font-weight: 500;
                                                     font-size: 0.7rem;
                                                     border-radius: 8px;
                                                     box-shadow: 0 1px 3px rgba(108, 117, 125, 0.3);">
                                            <i class="bi bi-arrow-return-right me-1" style="font-size: 0.6rem;"></i>{{ sku_data.sku }}
                                        </span>
                                        {% elif sku_data.get('es_producto_unificado', False) %}
                                        <!-- Badge especial para productos unificados -->
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #6c757d, #495057);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.8rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 3px 6px rgba(108, 117, 125, 0.4);">
                                            <i class="bi bi-collection me-1"></i>{{ sku_data.sku }}
                                        </span>
                                        {% else %}
                                        <!-- Badge normal para SKUs individuales -->
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #6c757d, #495057);
                                                     color: white;
                                                     font-weight: 600;
                                                     font-size: 0.75rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);">
                                            {{ sku_data.sku }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <!-- Descripción del producto -->
                                    <div style="line-height: 1.3;" class="d-flex align-items-center gap-2">
                                        <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                            {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                                        </span>

                                        <!-- Ícono de Inventario con Tooltip -->
                                        {% set inv_disp = inventario_disponible.get(sku_data.sku, {}) %}
                                        {% set inv_trans = inventario_transito.get(sku_data.sku, {}) %}
                                        {% if inv_disp or inv_trans %}
                                        <span class="inventory-icon-wrapper" style="position: relative; display: inline-block;">
                                            <i class="bi bi-box-seam"
                                               style="font-size: 1.1rem; color: #6c757d; cursor: pointer; transition: all 0.2s ease;"
                                               onmouseenter="this.style.color='#495057'; this.style.transform='scale(1.15)'"
                                               onmouseleave="this.style.color='#6c757d'; this.style.transform='scale(1)'"
                                               data-bs-toggle="tooltip"
                                               data-bs-html="true"
                                               data-bs-placement="right"
                                               title="<div style='text-align: left; font-size: 0.9rem; min-width: 320px; max-width: 450px; padding: 4px;'>
                                                   <div style='font-weight: 700; font-size: 1rem; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.25); color: #fff;'>
                                                       📦 Control de Inventario
                                                   </div>

                                                   {% if inv_disp and inv_disp.total > 0 %}
                                                   <div style='margin-bottom: 14px; padding: 10px; background: rgba(40, 167, 69, 0.15); border-radius: 6px; border-left: 3px solid #28a745;'>
                                                       <div style='font-weight: 700; color: #28a745; margin-bottom: 8px; font-size: 0.95rem;'>
                                                           ✅ DISPONIBLE AHORA
                                                       </div>
                                                       <div style='font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 10px; padding-left: 4px;'>
                                                           Total: {{ '{:,.0f}'.format(inv_disp.total) }} unidades
                                                       </div>
                                                       <div style='font-size: 0.85rem; color: rgba(255,255,255,0.9); line-height: 1.8; padding-left: 4px;'>
                                                           <div style='font-weight: 600; margin-bottom: 6px; color: rgba(255,255,255,0.95);'>📍 Distribución por Almacén:</div>
                                                           {% for alm in inv_disp.almacenes %}
                                                           <div style='padding: 3px 0; padding-left: 12px;'>
                                                               <span style='color: #90EE90; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>{{ alm.almacen }}:</span>
                                                               <span style='color: #fff; font-weight: 700;'>{{ '{:,.0f}'.format(alm.cantidad) }}</span> uds
                                                           </div>
                                                           {% endfor %}
                                                       </div>
                                                   </div>
                                                   {% else %}
                                                   <div style='margin-bottom: 14px; padding: 10px; background: rgba(220, 53, 69, 0.15); border-radius: 6px; border-left: 3px solid #dc3545;'>
                                                       <div style='font-weight: 600; color: #ff6b6b; font-size: 0.9rem;'>
                                                           ⚠️ Sin existencias disponibles
                                                       </div>
                                                   </div>
                                                   {% endif %}

                                                   {% if inv_trans and inv_trans.total > 0 %}
                                                   <div style='padding: 10px; background: rgba(255, 193, 7, 0.15); border-radius: 6px; border-left: 3px solid #ffc107;'>
                                                       <div style='font-weight: 700; color: #ffc107; margin-bottom: 8px; font-size: 0.95rem;'>
                                                           🚚 EN TRÁNSITO
                                                       </div>
                                                       <div style='font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 10px; padding-left: 4px;'>
                                                           Total: {{ '{:,.0f}'.format(inv_trans.total) }} unidades
                                                       </div>
                                                       <div style='font-size: 0.85rem; color: rgba(255,255,255,0.9); line-height: 1.8; padding-left: 4px;'>
                                                           <div style='font-weight: 600; margin-bottom: 6px; color: rgba(255,255,255,0.95);'>📅 Por Fecha de Llegada:</div>
                                                           {% if inv_trans.esta_semana > 0 %}
                                                           <div style='padding: 3px 0; padding-left: 12px;'>
                                                               <span style='color: #FFD700; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>Esta semana (próximos 7 días):</span><br>
                                                               <span style='color: #fff; font-weight: 700; padding-left: 18px;'>{{ '{:,.0f}'.format(inv_trans.esta_semana) }}</span> uds
                                                           </div>
                                                           {% endif %}
                                                           {% if inv_trans.proximas_semanas > 0 %}
                                                           <div style='padding: 3px 0; padding-left: 12px; {% if inv_trans.esta_semana > 0 %}margin-top: 6px;{% endif %}'>
                                                               <span style='color: #FFD700; font-weight: 600;'>•</span>
                                                               <span style='font-weight: 500;'>Próximas semanas (después de 7 días):</span><br>
                                                               <span style='color: #fff; font-weight: 700; padding-left: 18px;'>{{ '{:,.0f}'.format(inv_trans.proximas_semanas) }}</span> uds
                                                           </div>
                                                           {% endif %}
                                                           <div style='margin-top: 8px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.8rem; color: rgba(255,255,255,0.85);'>
                                                               <span style='font-weight: 600;'>💡 Detalle:</span> {{ inv_trans.envios|length }} envío{% if inv_trans.envios|length > 1 %}s{% endif %} programado{% if inv_trans.envios|length > 1 %}s{% endif %}
                                                           </div>
                                                       </div>
                                                   </div>
                                                   {% else %}
                                                   <div style='padding: 10px; background: rgba(108, 117, 125, 0.15); border-radius: 6px; border-left: 3px solid #6c757d;'>
                                                       <div style='font-weight: 600; color: #adb5bd; font-size: 0.9rem;'>
                                                           ℹ️ Sin envíos en tránsito recientes
                                                       </div>
                                                   </div>
                                                   {% endif %}

                                                   {% if not inv_disp and not inv_trans %}
                                                   <div style='padding: 15px; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9rem; font-style: italic;'>
                                                       Sin información de inventario disponible
                                                   </div>
                                                   {% endif %}
                                               </div>">
                                            </i>
                                        </span>
                                        {% endif %}
                                    </div>
                                    <!-- Número de transacciones -->
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #6c757d;"></i>{{ sku_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            <br>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if sku_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.costo_venta_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if sku_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_roi_pct is defined and sku_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Subfilas de canal para SKU Prometedores -->
                    {% for canal_data in sku_data.desglose_canales %}
                    <tr class="canal-subfila canal-subfila-prometedores-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(108, 117, 125, 0.05); border-left: 4px solid #6c757d;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-chevron-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ canal_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #6c757d;"></i>{{ canal_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>

                                <!-- ✅ NUEVO: Tooltip de Ingreso Ideal -->
                                {% if canal_data.tiene_ingreso_ideal %}
                                <div class="ms-2">
                                    <i class="bi bi-info-circle text-warning"
                                       style="font-size: 1.1rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"
                                       data-bs-placement="right"
                                       data-bs-custom-class="tooltip-ingreso-ideal"
                                       title="
                                       <div style='text-align: left; min-width: 340px; font-family: Consolas, Monaco, monospace;'>
                                           <!-- Título -->
                                           <div style='font-size: 1em; font-weight: 700; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3);'>
                                               INGRESO IDEAL
                                           </div>

                                           <!-- Barras de Comparación con Escala Dinámica -->
                                           <div style='margin-bottom: 10px; font-size: 0.85em; line-height: 1.8;'>
                                               <!-- Calcular el máximo para escalar -->
                                               {% if canal_data.ir_ideal >= canal_data.ingreso_real_porcentaje %}
                                                   {% set max_value = canal_data.ir_ideal %}
                                                   {% set bars_ideal = 10 %}
                                                   {% set bars_actual = ((canal_data.ingreso_real_porcentaje / canal_data.ir_ideal) * 10) | int if canal_data.ir_ideal > 0 else 0 %}
                                               {% else %}
                                                   {% set max_value = canal_data.ingreso_real_porcentaje %}
                                                   {% set bars_actual = 10 %}
                                                   {% set bars_ideal = ((canal_data.ir_ideal / canal_data.ingreso_real_porcentaje) * 10) | int if canal_data.ingreso_real_porcentaje > 0 else 0 %}
                                               {% endif %}

                                               <div style='display: flex; align-items: center; margin-bottom: 5px;'>
                                                   <span style='width: 90px;'>IR Actual:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #a78bfa;'>{{ '█' * bars_actual }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_actual) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #a78bfa;'>{{ '{:.1f}'.format(canal_data.ingreso_real_porcentaje) }}%</span>
                                               </div>

                                               <div style='display: flex; align-items: center;'>
                                                   <span style='width: 90px;'>IR Ideal:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #34d399;'>{{ '█' * bars_ideal }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_ideal) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre barras y componentes -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Componentes del Ideal - Formato Compacto 2 Columnas -->
                                           <div style='margin-bottom: 8px;'>
                                               <div style='font-weight: 600; margin-bottom: 6px; font-size: 0.9em;'>Componentes:</div>
                                               <div style='font-size: 0.8em; line-height: 1.6; font-family: Consolas, monospace;'>
                                                   <!-- Fila 1: Base y Calidad -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Base: <span style='font-weight: 700; color: #60a5fa;'>{{ '{:.1f}'.format(canal_data.ir_base) }}%</span></span>
                                                       <span style='flex: 1; text-align: right;'>Calidad: <span style='font-weight: 700; color: #a3e635;'>+{{ '{:.1f}'.format(canal_data.factor_calidad) }}</span></span>
                                                   </div>
                                                   <!-- Fila 2: Diferenciador y Percepción -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Diferenciador: <span style='font-weight: 700; color: #86efac;'>+{{ '{:.1f}'.format(canal_data.factor_diferenciador) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Percepción: <span style='font-weight: 700; color: #fde047;'>+{{ '{:.1f}'.format(canal_data.factor_percepcion) }}</span></span>
                                                   </div>
                                                   <!-- Fila 3: Funcionalidad y Competencia -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Funcionalidad: <span style='font-weight: 700; color: #facc15;'>+{{ '{:.1f}'.format(canal_data.factor_funcionalidad) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Competencia: <span style='font-weight: 700; color: #fca5a5;'>+{{ '{:.1f}'.format(canal_data.factor_competencia) }}</span></span>
                                                   </div>
                                                   <!-- Total IR Final -->
                                                   <div style='border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 6px; padding-top: 6px; font-weight: 700;'>
                                                       <span>= IR Final: <span style='color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span></span>
                                                   </div>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre IR Final y Potencial -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Potencial de Mejora / Mensaje Final -->
                                           {% if canal_data.gap_ingreso_pp < -1 %}
                                           <div style='background: rgba(251, 191, 36, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #fbbf24;'>
                                               <span style='font-weight: 700;'>💡 Potencial:</span>
                                               <span style='color: #fbbf24; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                               <span style='color: rgba(255,255,255,0.7);'>(+${{ '{:,.0f}'.format(canal_data.potencial_mensual) }}/mes)</span>
                                           </div>
                                           {% elif canal_data.gap_ingreso_pp >= 0 %}
                                           <div style='background: rgba(52, 211, 153, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #34d399;'>
                                               <span style='font-weight: 700; color: #34d399;'>✓ Superando ideal:</span>
                                               <span style='color: #34d399; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                           </div>
                                           {% else %}
                                           <div style='background: rgba(34, 197, 94, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #22c55e;'>
                                               <span style='font-weight: 700; color: #22c55e;'>✓ Cerca del ideal</span>
                                               <span style='color: rgba(255,255,255,0.7);'>({{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp)</span>
                                           </div>
                                           {% endif %}
                                       </div>
                                       ">
                                    </i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ventas_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ingreso_pct != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ingreso_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.costo_venta_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real por canal (PUNTOS PORCENTUALES) -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_roi_pct is defined and canal_data.variacion_roi_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ROI por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Subfilas temporales para SKU Prometedores -->
                    {% for mes_data in sku_data.desglose_meses %}
                    <tr class="mes-subfila mes-subfila-prometedores-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(108, 117, 125, 0.05); border-left: 4px solid #6c757d;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-calendar3 text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 600;">
                                        {{ mes_data.mes_corto }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-calendar-range me-1" style="color: #6c757d;"></i>{{ mes_data.periodo }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.costo_venta_promedio if mes_data.costo_venta_promedio is defined else mes_data.costo_venta) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.gastos_directos_promedio if mes_data.gastos_directos_promedio is defined else mes_data.gastos_directos) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ingreso_real_promedio if mes_data.ingreso_real_promedio is defined else mes_data.ingreso_real) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>

                    <!-- Subfilas de canal por mes para SKU Prometedores (cuando ambos desgloses están activos) -->
                    {% for canal_mes_data in mes_data.desglose_canales %}
                    <tr class="canal-mes-subfila canal-mes-subfila-prometedores-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(108, 117, 125, 0.03); border-left: 4px solid #6c757d;">
                        <td style="padding: 8px 15px 8px 75px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 20px; height: 20px; opacity: 0.5;">
                                        <i class="bi bi-arrow-right text-white" style="font-size: 0.6rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                        {{ canal_mes_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.65rem;">
                                            <i class="bi bi-receipt me-1" style="color: #6c757d;"></i>{{ canal_mes_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-gem text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay SKUs clasificados como Prometedores en este período</p>
            </div>
            {% endif %}
        </div>

        <!-- TABLA DE SKUs POTENCIALES -->
        <div id="tabla-potenciales" class="table-responsive" style="background: linear-gradient(135deg, rgba(248,249,250,0.4), rgba(233,236,239,0.3)); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none;">
            {% if skus_potenciales and skus_potenciales|length > 0 %}
            <table class="table table-hover mb-0 channel-analysis-table" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(23, 162, 184, 0.2);">
                        <th style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-box me-2" style="color: #17a2b8;"></i>Producto
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #dc3545;"></i>Costo de Venta
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-down me-2" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up-arrow me-2" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-trophy me-2" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="text-center" style="background: rgba(23, 162, 184, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up me-2" style="color: #20c997;"></i>ROI %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sku_data in skus_potenciales %}
                    <tr style="transition: all 0.3s ease;">
                        <td style="padding: 15px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 35px; height: 35px; background: linear-gradient(135deg, #17a2b8, #138496) !important;">
                                        <i class="bi bi-lightning-fill text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <!-- SKU con fondito bonito -->
                                    <div class="mb-2">
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #17a2b8, #138496);
                                                     color: white;
                                                     font-weight: 600;
                                                     font-size: 0.75rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);">
                                            {{ sku_data.sku }}
                                        </span>
                                    </div>
                                    <!-- Descripción del producto -->
                                    <div style="line-height: 1.3;">
                                        <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                            {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                                        </span>


                                    </div>
                                    <!-- Número de transacciones -->
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #17a2b8;"></i>{{ sku_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            <br>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if sku_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 1rem;">
                                ${{ "{:,.0f}".format(sku_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                Prom: ${{ "{:,.0f}".format(sku_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.costo_venta_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if sku_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: 15px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.8rem; padding: 8px 12px;">
                                {{ "{:.1f}%".format(sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_roi_pct is defined and sku_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Subfilas de canal para SKU Potenciales -->
                    {% for canal_data in sku_data.desglose_canales %}
                    <tr class="canal-subfila canal-subfila-potenciales-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(23, 162, 184, 0.05); border-left: 4px solid #17a2b8;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-chevron-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ canal_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #17a2b8;"></i>{{ canal_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>

                                <!-- ✅ NUEVO: Tooltip de Ingreso Ideal -->
                                {% if canal_data.tiene_ingreso_ideal %}
                                <div class="ms-2">
                                    <i class="bi bi-info-circle text-warning"
                                       style="font-size: 1.1rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"
                                       data-bs-placement="right"
                                       data-bs-custom-class="tooltip-ingreso-ideal"
                                       title="
                                       <div style='text-align: left; min-width: 340px; font-family: Consolas, Monaco, monospace;'>
                                           <!-- Título -->
                                           <div style='font-size: 1em; font-weight: 700; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3);'>
                                               INGRESO IDEAL
                                           </div>

                                           <!-- Barras de Comparación con Escala Dinámica -->
                                           <div style='margin-bottom: 10px; font-size: 0.85em; line-height: 1.8;'>
                                               <!-- Calcular el máximo para escalar -->
                                               {% if canal_data.ir_ideal >= canal_data.ingreso_real_porcentaje %}
                                                   {% set max_value = canal_data.ir_ideal %}
                                                   {% set bars_ideal = 10 %}
                                                   {% set bars_actual = ((canal_data.ingreso_real_porcentaje / canal_data.ir_ideal) * 10) | int if canal_data.ir_ideal > 0 else 0 %}
                                               {% else %}
                                                   {% set max_value = canal_data.ingreso_real_porcentaje %}
                                                   {% set bars_actual = 10 %}
                                                   {% set bars_ideal = ((canal_data.ir_ideal / canal_data.ingreso_real_porcentaje) * 10) | int if canal_data.ingreso_real_porcentaje > 0 else 0 %}
                                               {% endif %}

                                               <div style='display: flex; align-items: center; margin-bottom: 5px;'>
                                                   <span style='width: 90px;'>IR Actual:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #a78bfa;'>{{ '█' * bars_actual }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_actual) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #a78bfa;'>{{ '{:.1f}'.format(canal_data.ingreso_real_porcentaje) }}%</span>
                                               </div>

                                               <div style='display: flex; align-items: center;'>
                                                   <span style='width: 90px;'>IR Ideal:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #34d399;'>{{ '█' * bars_ideal }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_ideal) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre barras y componentes -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Componentes del Ideal - Formato Compacto 2 Columnas -->
                                           <div style='margin-bottom: 8px;'>
                                               <div style='font-weight: 600; margin-bottom: 6px; font-size: 0.9em;'>Componentes:</div>
                                               <div style='font-size: 0.8em; line-height: 1.6; font-family: Consolas, monospace;'>
                                                   <!-- Fila 1: Base y Calidad -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Base: <span style='font-weight: 700; color: #60a5fa;'>{{ '{:.1f}'.format(canal_data.ir_base) }}%</span></span>
                                                       <span style='flex: 1; text-align: right;'>Calidad: <span style='font-weight: 700; color: #a3e635;'>+{{ '{:.1f}'.format(canal_data.factor_calidad) }}</span></span>
                                                   </div>
                                                   <!-- Fila 2: Diferenciador y Percepción -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Diferenciador: <span style='font-weight: 700; color: #86efac;'>+{{ '{:.1f}'.format(canal_data.factor_diferenciador) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Percepción: <span style='font-weight: 700; color: #fde047;'>+{{ '{:.1f}'.format(canal_data.factor_percepcion) }}</span></span>
                                                   </div>
                                                   <!-- Fila 3: Funcionalidad y Competencia -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Funcionalidad: <span style='font-weight: 700; color: #facc15;'>+{{ '{:.1f}'.format(canal_data.factor_funcionalidad) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Competencia: <span style='font-weight: 700; color: #fca5a5;'>+{{ '{:.1f}'.format(canal_data.factor_competencia) }}</span></span>
                                                   </div>
                                                   <!-- Total IR Final -->
                                                   <div style='border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 6px; padding-top: 6px; font-weight: 700;'>
                                                       <span>= IR Final: <span style='color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span></span>
                                                   </div>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre IR Final y Potencial -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Potencial de Mejora / Mensaje Final -->
                                           {% if canal_data.gap_ingreso_pp < -1 %}
                                           <div style='background: rgba(251, 191, 36, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #fbbf24;'>
                                               <span style='font-weight: 700;'>💡 Potencial:</span>
                                               <span style='color: #fbbf24; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                               <span style='color: rgba(255,255,255,0.7);'>(+${{ '{:,.0f}'.format(canal_data.potencial_mensual) }}/mes)</span>
                                           </div>
                                           {% elif canal_data.gap_ingreso_pp >= 0 %}
                                           <div style='background: rgba(52, 211, 153, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #34d399;'>
                                               <span style='font-weight: 700; color: #34d399;'>✓ Superando ideal:</span>
                                               <span style='color: #34d399; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                           </div>
                                           {% else %}
                                           <div style='background: rgba(34, 197, 94, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #22c55e;'>
                                               <span style='font-weight: 700; color: #22c55e;'>✓ Cerca del ideal</span>
                                               <span style='color: rgba(255,255,255,0.7);'>({{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp)</span>
                                           </div>
                                           {% endif %}
                                       </div>
                                       ">
                                    </i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ventas_pct != 0 %}
                            <!-- Nivel 2: Variación de ventas por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ventas_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ingreso_pct != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ingreso_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.costo_venta_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de costo de venta por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de gastos directos por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real por canal (PUNTOS PORCENTUALES) -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_roi_pct is defined and canal_data.variacion_roi_pct != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ROI por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Subfilas temporales para SKU Potenciales -->
                    {% for mes_data in sku_data.desglose_meses %}
                    <tr class="mes-subfila mes-subfila-potenciales-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(23, 162, 184, 0.05); border-left: 4px solid #17a2b8;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-calendar3 text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 600;">
                                        {{ mes_data.mes_corto }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-calendar-range me-1" style="color: #17a2b8;"></i>{{ mes_data.periodo }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.costo_venta_promedio if mes_data.costo_venta_promedio is defined else mes_data.costo_venta) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.gastos_directos_promedio if mes_data.gastos_directos_promedio is defined else mes_data.gastos_directos) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ingreso_real_promedio if mes_data.ingreso_real_promedio is defined else mes_data.ingreso_real) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>

                    <!-- Subfilas de canal por mes para SKU Potenciales (cuando ambos desgloses están activos) -->
                    {% for canal_mes_data in mes_data.desglose_canales %}
                    <tr class="canal-mes-subfila canal-mes-subfila-potenciales-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(23, 162, 184, 0.03); border-left: 4px solid #17a2b8;">
                        <td style="padding: 8px 15px 8px 75px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 20px; height: 20px; opacity: 0.5;">
                                        <i class="bi bi-arrow-right text-white" style="font-size: 0.6rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                        {{ canal_mes_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.65rem;">
                                            <i class="bi bi-receipt me-1" style="color: #17a2b8;"></i>{{ canal_mes_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ventas_reales) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ventas_reales_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.8rem;">
                                ${{ "{:,.0f}".format(canal_mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.65rem;">
                                Prom: ${{ "{:,.0f}".format(canal_mes_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.costo_venta_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.gastos_directos_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if canal_mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.ingreso_real_porcentaje) }}
                            </span>
                        </td>
                        <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.6rem; padding: 4px 8px;">
                                {{ "{:.1f}%".format(canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-lightning text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay SKUs clasificados como Potenciales en este período</p>
            </div>
            {% endif %}
        </div>

        <!-- TABLA DE SKUs REVISIÓN -->
        <div id="tabla-revision" class="table-responsive" style="background: linear-gradient(135deg, rgba(253,126,20,0.1), rgba(253,126,20,0.05)); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none;">
            {% if skus_revision and skus_revision|length > 0 %}
            <table class="table table-hover mb-0 channel-analysis-table" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(253, 126, 20, 0.2);">
                        <th style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-box me-2" style="color: #fd7e14;"></i>Producto
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #dc3545;"></i>Costo de Venta
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-down me-2" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up-arrow me-2" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-trophy me-2" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="text-center" style="background: rgba(253, 126, 20, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up me-2" style="color: #20c997;"></i>ROI %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sku_data in skus_revision %}
                    <!-- Verificar si es fila de totales -->
                    {% if sku_data.es_fila_total %}
                    <!-- FILA DE TOTALES REVISIÓN -->
                    <tr style="background: linear-gradient(135deg, rgba(253, 126, 20, 0.15), rgba(253, 126, 20, 0.08)); border-top: 3px solid #fd7e14; border-bottom: 2px solid #fd7e14; font-weight: 700;">
                        <td style="padding: 18px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #fd7e14, #e85d04) !important; box-shadow: 0 4px 8px rgba(253, 126, 20, 0.4);">
                                        <i class="bi bi-calculator text-white" style="font-size: 1rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="mb-2">
                                        <span class="badge px-4 py-2"
                                              style="background: linear-gradient(135deg, #fd7e14, #e85d04);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.85rem;
                                                     border-radius: 15px;
                                                     box-shadow: 0 3px 6px rgba(253, 126, 20, 0.4);">
                                            TOTAL REVISIÓN
                                        </span>
                                    </div>
                                    <div style="line-height: 1.3;">
                                        <span style="color: #2C2C2C; font-size: 0.85rem; font-weight: 600;">
                                            Consolidado de todos los SKUs en Revisión
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <small style="color: #fd7e14; font-size: 0.75rem; font-weight: 600;">
                                            <i class="bi bi-receipt me-1"></i>{{ sku_data.num_transacciones }} transacciones totales
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% else %}
                    <!-- FILA NORMAL DE SKU REVISIÓN -->
                    <tr style="transition: all 0.3s ease;">
                        <td style="padding: 15px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 35px; height: 35px; background: linear-gradient(135deg, #fd7e14, #e85d04) !important;">
                                        <i class="bi bi-exclamation-triangle-fill text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <!-- SKU con fondito bonito -->
                                    <div class="mb-2">
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #fd7e14, #e85d04);
                                                     color: white;
                                                     font-weight: 600;
                                                     font-size: 0.75rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 2px 4px rgba(253, 126, 20, 0.3);">
                                            {{ sku_data.sku }}
                                        </span>
                                    </div>
                                    <!-- Descripción del producto -->
                                    <div style="line-height: 1.3;">
                                        <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                            {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                                        </span>


                                    </div>
                                    <!-- Número de transacciones -->
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #fd7e14;"></i>{{ sku_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% endif %}

                        <!-- Celdas de datos con diferentes estilos según si es fila de total o no -->
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.ventas_reales_promedio) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if sku_data.ingreso_real >= 0 else '#dc3545' }}; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.get('periodo_comparacion', 'Sin comparación') }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}mt-1{% endif %}" style="font-size: {% if sku_data.get('es_fila_total', False) %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.get('ingreso_real_promedio', 0)) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.costo_venta_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if sku_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_roi_pct is defined and sku_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Subfilas de canal para SKU Revisión -->
                    {% for canal_data in sku_data.desglose_canales %}
                    <tr class="canal-subfila canal-subfila-revision-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(253, 126, 20, 0.05); border-left: 4px solid #fd7e14;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-chevron-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ canal_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #fd7e14;"></i>{{ canal_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>

                                <!-- ✅ NUEVO: Tooltip de Ingreso Ideal -->
                                {% if canal_data.tiene_ingreso_ideal %}
                                <div class="ms-2">
                                    <i class="bi bi-info-circle text-warning"
                                       style="font-size: 1.1rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"
                                       data-bs-placement="right"
                                       data-bs-custom-class="tooltip-ingreso-ideal"
                                       title="
                                       <div style='text-align: left; min-width: 340px; font-family: Consolas, Monaco, monospace;'>
                                           <!-- Título -->
                                           <div style='font-size: 1em; font-weight: 700; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3);'>
                                               INGRESO IDEAL
                                           </div>

                                           <!-- Barras de Comparación con Escala Dinámica -->
                                           <div style='margin-bottom: 10px; font-size: 0.85em; line-height: 1.8;'>
                                               <!-- Calcular el máximo para escalar -->
                                               {% if canal_data.ir_ideal >= canal_data.ingreso_real_porcentaje %}
                                                   {% set max_value = canal_data.ir_ideal %}
                                                   {% set bars_ideal = 10 %}
                                                   {% set bars_actual = ((canal_data.ingreso_real_porcentaje / canal_data.ir_ideal) * 10) | int if canal_data.ir_ideal > 0 else 0 %}
                                               {% else %}
                                                   {% set max_value = canal_data.ingreso_real_porcentaje %}
                                                   {% set bars_actual = 10 %}
                                                   {% set bars_ideal = ((canal_data.ir_ideal / canal_data.ingreso_real_porcentaje) * 10) | int if canal_data.ingreso_real_porcentaje > 0 else 0 %}
                                               {% endif %}

                                               <div style='display: flex; align-items: center; margin-bottom: 5px;'>
                                                   <span style='width: 90px;'>IR Actual:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #a78bfa;'>{{ '█' * bars_actual }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_actual) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #a78bfa;'>{{ '{:.1f}'.format(canal_data.ingreso_real_porcentaje) }}%</span>
                                               </div>

                                               <div style='display: flex; align-items: center;'>
                                                   <span style='width: 90px;'>IR Ideal:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #34d399;'>{{ '█' * bars_ideal }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_ideal) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre barras y componentes -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Componentes del Ideal - Formato Compacto 2 Columnas -->
                                           <div style='margin-bottom: 8px;'>
                                               <div style='font-weight: 600; margin-bottom: 6px; font-size: 0.9em;'>Componentes:</div>
                                               <div style='font-size: 0.8em; line-height: 1.6; font-family: Consolas, monospace;'>
                                                   <!-- Fila 1: Base y Calidad -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Base: <span style='font-weight: 700; color: #60a5fa;'>{{ '{:.1f}'.format(canal_data.ir_base) }}%</span></span>
                                                       <span style='flex: 1; text-align: right;'>Calidad: <span style='font-weight: 700; color: #a3e635;'>+{{ '{:.1f}'.format(canal_data.factor_calidad) }}</span></span>
                                                   </div>
                                                   <!-- Fila 2: Diferenciador y Percepción -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Diferenciador: <span style='font-weight: 700; color: #86efac;'>+{{ '{:.1f}'.format(canal_data.factor_diferenciador) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Percepción: <span style='font-weight: 700; color: #fde047;'>+{{ '{:.1f}'.format(canal_data.factor_percepcion) }}</span></span>
                                                   </div>
                                                   <!-- Fila 3: Funcionalidad y Competencia -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Funcionalidad: <span style='font-weight: 700; color: #facc15;'>+{{ '{:.1f}'.format(canal_data.factor_funcionalidad) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Competencia: <span style='font-weight: 700; color: #fca5a5;'>+{{ '{:.1f}'.format(canal_data.factor_competencia) }}</span></span>
                                                   </div>
                                                   <!-- Total IR Final -->
                                                   <div style='border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 6px; padding-top: 6px; font-weight: 700;'>
                                                       <span>= IR Final: <span style='color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span></span>
                                                   </div>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre IR Final y Potencial -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Potencial de Mejora / Mensaje Final -->
                                           {% if canal_data.gap_ingreso_pp < -1 %}
                                           <div style='background: rgba(251, 191, 36, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #fbbf24;'>
                                               <span style='font-weight: 700;'>💡 Potencial:</span>
                                               <span style='color: #fbbf24; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                               <span style='color: rgba(255,255,255,0.7);'>(+${{ '{:,.0f}'.format(canal_data.potencial_mensual) }}/mes)</span>
                                           </div>
                                           {% elif canal_data.gap_ingreso_pp >= 0 %}
                                           <div style='background: rgba(52, 211, 153, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #34d399;'>
                                               <span style='font-weight: 700; color: #34d399;'>✓ Superando ideal:</span>
                                               <span style='color: #34d399; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                           </div>
                                           {% else %}
                                           <div style='background: rgba(34, 197, 94, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #22c55e;'>
                                               <span style='font-weight: 700; color: #22c55e;'>✓ Cerca del ideal</span>
                                               <span style='color: rgba(255,255,255,0.7);'>({{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp)</span>
                                           </div>
                                           {% endif %}
                                       </div>
                                       ">
                                    </i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ventas_reales_promedio) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ingreso_pct != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ingreso_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.costo_venta_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- Variación de costo de venta por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- Variación de gastos directos por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.ingreso_real_porcentaje if canal_data.ingreso_real_porcentaje is defined else 0) >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.ingreso_real_porcentaje if canal_data.ingreso_real_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_ingreso_pct is defined and canal_data.variacion_ingreso_pct != 0 %}
                            <br>
                            <!-- Variación de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_roi_pct is defined and canal_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Subfilas temporales para SKU Revisión -->
                    {% for mes_data in sku_data.desglose_meses %}
                    <tr class="mes-subfila mes-subfila-revision-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(253, 126, 20, 0.05); border-left: 4px solid #fd7e14;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.8;">
                                        <i class="bi bi-calendar3 text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ mes_data.mes_corto if mes_data.mes_corto is defined else mes_data.mes_nombre }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-calendar-range me-1" style="color: #fd7e14;"></i>{{ mes_data.periodo if mes_data.periodo is defined else (mes_data.num_transacciones + ' transacciones' if mes_data.num_transacciones is defined else '') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if mes_data.variacion_ventas_pct is defined and mes_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas por mes -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if mes_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(mes_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(mes_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                                {% endif %}
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ventas_reales_promedio if mes_data.ventas_reales_promedio is defined else mes_data.ventas_reales) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.costo_venta_promedio if mes_data.costo_venta_promedio is defined else mes_data.costo_venta) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.gastos_directos_promedio if mes_data.gastos_directos_promedio is defined else mes_data.gastos_directos) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ingreso_real_promedio if mes_data.ingreso_real_promedio is defined else mes_data.ingreso_real) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.costo_venta_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_costo_venta_pct is defined and mes_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- Variación de costo de venta por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_gastos_directos_pct is defined and mes_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- Variación de gastos directos por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_ingreso_pct is defined and mes_data.variacion_ingreso_pct != 0 %}
                            <br>
                            <!-- Variación de ingreso real por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_ingreso_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_ingreso_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if mes_data.variacion_roi_pct is defined and mes_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>

                        <!-- Subfilas de canal por mes para SKU Revisión (cuando ambos desgloses están activos) -->
                        {% for canal_mes_data in mes_data.desglose_canales %}
                        <tr class="canal-mes-subfila canal-mes-subfila-revision-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(253, 126, 20, 0.03); border-left: 4px solid #fd7e14;">
                            <td style="padding: 8px 15px 8px 75px; vertical-align: middle; border: none;">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                                             style="width: 20px; height: 20px; border: 2px solid #fd7e14;">
                                            <i class="bi bi-dot" style="font-size: 0.8rem; color: #fd7e14;"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <span class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                                            {{ canal_mes_data.canal }}
                                        </span>
                                        <div class="mt-1">
                                            <small class="text-muted" style="font-size: 0.65rem;">
                                                <i class="bi bi-receipt me-1" style="color: #fd7e14;"></i>{{ canal_mes_data.num_transacciones }} transacciones
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #28a745; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.ventas_reales) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.ventas_reales_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #dc3545; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.costo_venta) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.costo_venta_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #ffc107; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.gastos_directos) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.gastos_directos_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: {{ '#6f42c1' if canal_mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.ingreso_real) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.ingreso_real_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.costo_venta_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.gastos_directos_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg,
                                             {% if canal_mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                             color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.ingreso_real_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg,
                                             {% if (canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                             color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-exclamation-triangle text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay SKUs clasificados como Revisión en este período</p>
            </div>
            {% endif %}
        </div>

        <!-- TABLA DE SKUs REMOVER -->
        <div id="tabla-remover" class="table-responsive" style="background: linear-gradient(135deg, rgba(220,53,69,0.1), rgba(220,53,69,0.05)); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: none;">
            {% if skus_remover and skus_remover|length > 0 %}
            <table class="table table-hover mb-0 channel-analysis-table" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(220, 53, 69, 0.2);">
                        <th style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-box me-2" style="color: #dc3545;"></i>Producto
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #28a745;"></i>Ventas Totales
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-currency-dollar me-2" style="color: #dc3545;"></i>Costo de Venta
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-receipt me-2" style="color: #ffc107;"></i>Gastos Directos
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-cash-coin me-2" style="color: #6f42c1;"></i>Ingreso Real
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-down me-2" style="color: #dc3545;"></i>% Costo
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up-arrow me-2" style="color: #ffc107;"></i>% Gastos
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-trophy me-2" style="color: #6f42c1;"></i>% Ingreso
                        </th>
                        <th class="text-center" style="background: rgba(220, 53, 69, 0.1); color: #2C2C2C; font-weight: 700; border: none; padding: 15px; font-size: 0.9rem;">
                            <i class="bi bi-graph-up me-2" style="color: #20c997;"></i>ROI %
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for sku_data in skus_remover %}
                    <!-- Verificar si es fila de totales -->
                    {% if sku_data.es_fila_total %}
                    <!-- FILA DE TOTALES REMOVER -->
                    <tr style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.15), rgba(220, 53, 69, 0.08)); border-top: 3px solid #dc3545; border-bottom: 2px solid #dc3545; font-weight: 700;">
                        <td style="padding: 18px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 40px; height: 40px; background: linear-gradient(135deg, #dc3545, #c92a2a) !important; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);">
                                        <i class="bi bi-calculator text-white" style="font-size: 1rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="mb-2">
                                        <span class="badge px-4 py-2"
                                              style="background: linear-gradient(135deg, #dc3545, #c92a2a);
                                                     color: white;
                                                     font-weight: 700;
                                                     font-size: 0.85rem;
                                                     border-radius: 15px;
                                                     box-shadow: 0 3px 6px rgba(220, 53, 69, 0.4);">
                                            TOTAL REMOVER
                                        </span>
                                    </div>
                                    <div style="line-height: 1.3;">
                                        <span style="color: #2C2C2C; font-size: 0.85rem; font-weight: 600;">
                                            Consolidado de todos los SKUs candidatos a Remoción
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <small style="color: #dc3545; font-size: 0.75rem; font-weight: 600;">
                                            <i class="bi bi-receipt me-1"></i>{{ sku_data.num_transacciones }} transacciones totales
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% else %}
                    <!-- FILA NORMAL DE SKU REMOVER -->
                    <tr style="transition: all 0.3s ease;">
                        <td style="padding: 15px; vertical-align: middle; border: none; max-width: 300px;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 35px; height: 35px; background: linear-gradient(135deg, #dc3545, #c92a2a) !important;">
                                        <i class="bi bi-trash-fill text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <!-- SKU con fondito bonito -->
                                    <div class="mb-2">
                                        <span class="badge px-3 py-1"
                                              style="background: linear-gradient(135deg, #dc3545, #c92a2a);
                                                     color: white;
                                                     font-weight: 600;
                                                     font-size: 0.75rem;
                                                     border-radius: 12px;
                                                     box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);">
                                            {{ sku_data.sku }}
                                        </span>
                                    </div>
                                    <!-- Descripción del producto -->
                                    <div style="line-height: 1.3;">
                                        <span class="text-muted" style="font-size: 0.8rem; font-weight: 500;">
                                            {{ sku_data.descripcion[:60] }}{% if sku_data.descripcion|length > 60 %}...{% endif %}
                                        </span>


                                    </div>
                                    <!-- Número de transacciones -->
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #dc3545;"></i>{{ sku_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                    {% endif %}

                        <!-- Celdas de datos con diferentes estilos según si es fila de total o no -->
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if not sku_data.es_fila_total and sku_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.ventas_reales_promedio) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: {% if sku_data.es_fila_total %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if sku_data.ingreso_real >= 0 else '#dc3545' }}; font-size: {% if sku_data.es_fila_total %}1.2rem{% else %}1rem{% endif %};">
                                ${{ "{:,.0f}".format(sku_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real para SKUs individuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_pct', 0)) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.get('periodo_comparacion', 'Sin comparación') }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if not sku_data.get('es_fila_total', False) and sku_data.get('variacion_ingreso_pct', 0) != 0 %}mt-1{% endif %}" style="font-size: {% if sku_data.get('es_fila_total', False) %}0.8rem{% else %}0.75rem{% endif %};">
                                Prom: ${{ "{:,.0f}".format(sku_data.get('ingreso_real_promedio', 0)) }}
                            </small>
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.costo_venta_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">{{ "{:.1f}".format(sku_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if sku_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.get('variacion_ingreso_porcentaje_pct', 0) != 0 %}
                            <br>
                            <!-- NUEVA: Variación de ingreso real en puntos porcentuales -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.get('variacion_ingreso_porcentaje_pct', 0) > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.get('variacion_ingreso_porcentaje_pct', 0)) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center metric-cell" style="padding: {% if sku_data.es_fila_total %}18px{% else %}15px{% endif %}; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: {% if sku_data.es_fila_total %}0.9rem{% else %}0.8rem{% endif %}; padding: {% if sku_data.es_fila_total %}10px 15px{% else %}8px 12px{% endif %};">
                                {{ "{:.1f}%".format(sku_data.roi_porcentaje if sku_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if not sku_data.es_fila_total and sku_data.variacion_roi_pct is defined and sku_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if sku_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1"></i>
                                    <span class="text-success fw-semibold">+{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1"></i>
                                    <span class="text-danger fw-semibold">{{ "{:.1f}".format(sku_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ sku_data.periodo_comparacion }}" style="font-size: 0.7rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Subfilas de canal para SKU Remover -->
                    {% for canal_data in sku_data.desglose_canales %}
                    <tr class="canal-subfila canal-subfila-remover-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(220, 53, 69, 0.05); border-left: 4px solid #dc3545;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.7;">
                                        <i class="bi bi-chevron-right text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ canal_data.canal }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-receipt me-1" style="color: #dc3545;"></i>{{ canal_data.num_transacciones }} transacciones
                                        </small>
                                    </div>
                                </div>

                                <!-- ✅ NUEVO: Tooltip de Ingreso Ideal -->
                                {% if canal_data.tiene_ingreso_ideal %}
                                <div class="ms-2">
                                    <i class="bi bi-info-circle text-warning"
                                       style="font-size: 1.1rem; cursor: help;"
                                       data-bs-toggle="tooltip"
                                       data-bs-html="true"
                                       data-bs-placement="right"
                                       data-bs-custom-class="tooltip-ingreso-ideal"
                                       title="
                                       <div style='text-align: left; min-width: 340px; font-family: Consolas, Monaco, monospace;'>
                                           <!-- Título -->
                                           <div style='font-size: 1em; font-weight: 700; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.3);'>
                                               INGRESO IDEAL
                                           </div>

                                           <!-- Barras de Comparación con Escala Dinámica -->
                                           <div style='margin-bottom: 10px; font-size: 0.85em; line-height: 1.8;'>
                                               <!-- Calcular el máximo para escalar -->
                                               {% if canal_data.ir_ideal >= canal_data.ingreso_real_porcentaje %}
                                                   {% set max_value = canal_data.ir_ideal %}
                                                   {% set bars_ideal = 10 %}
                                                   {% set bars_actual = ((canal_data.ingreso_real_porcentaje / canal_data.ir_ideal) * 10) | int if canal_data.ir_ideal > 0 else 0 %}
                                               {% else %}
                                                   {% set max_value = canal_data.ingreso_real_porcentaje %}
                                                   {% set bars_actual = 10 %}
                                                   {% set bars_ideal = ((canal_data.ir_ideal / canal_data.ingreso_real_porcentaje) * 10) | int if canal_data.ingreso_real_porcentaje > 0 else 0 %}
                                               {% endif %}

                                               <div style='display: flex; align-items: center; margin-bottom: 5px;'>
                                                   <span style='width: 90px;'>IR Actual:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #a78bfa;'>{{ '█' * bars_actual }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_actual) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #a78bfa;'>{{ '{:.1f}'.format(canal_data.ingreso_real_porcentaje) }}%</span>
                                               </div>

                                               <div style='display: flex; align-items: center;'>
                                                   <span style='width: 90px;'>IR Ideal:</span>
                                                   <div style='flex: 1; margin: 0 8px; font-family: monospace; font-size: 12px; letter-spacing: 1px;'>
                                                       <span style='color: #34d399;'>{{ '█' * bars_ideal }}</span><span style='color: rgba(255,255,255,0.2);'>{{ '░' * (10 - bars_ideal) }}</span>
                                                   </div>
                                                   <span style='font-weight: 700; min-width: 50px; text-align: right; color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre barras y componentes -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Componentes del Ideal - Formato Compacto 2 Columnas -->
                                           <div style='margin-bottom: 8px;'>
                                               <div style='font-weight: 600; margin-bottom: 6px; font-size: 0.9em;'>Componentes:</div>
                                               <div style='font-size: 0.8em; line-height: 1.6; font-family: Consolas, monospace;'>
                                                   <!-- Fila 1: Base y Calidad -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Base: <span style='font-weight: 700; color: #60a5fa;'>{{ '{:.1f}'.format(canal_data.ir_base) }}%</span></span>
                                                       <span style='flex: 1; text-align: right;'>Calidad: <span style='font-weight: 700; color: #a3e635;'>+{{ '{:.1f}'.format(canal_data.factor_calidad) }}</span></span>
                                                   </div>
                                                   <!-- Fila 2: Diferenciador y Percepción -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Diferenciador: <span style='font-weight: 700; color: #86efac;'>+{{ '{:.1f}'.format(canal_data.factor_diferenciador) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Percepción: <span style='font-weight: 700; color: #fde047;'>+{{ '{:.1f}'.format(canal_data.factor_percepcion) }}</span></span>
                                                   </div>
                                                   <!-- Fila 3: Funcionalidad y Competencia -->
                                                   <div style='display: flex; justify-content: space-between; padding: 2px 0;'>
                                                       <span style='flex: 1;'>Funcionalidad: <span style='font-weight: 700; color: #facc15;'>+{{ '{:.1f}'.format(canal_data.factor_funcionalidad) }}</span></span>
                                                       <span style='flex: 1; text-align: right;'>Competencia: <span style='font-weight: 700; color: #fca5a5;'>+{{ '{:.1f}'.format(canal_data.factor_competencia) }}</span></span>
                                                   </div>
                                                   <!-- Total IR Final -->
                                                   <div style='border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 6px; padding-top: 6px; font-weight: 700;'>
                                                       <span>= IR Final: <span style='color: #34d399;'>{{ '{:.1f}'.format(canal_data.ir_ideal) }}%</span></span>
                                                   </div>
                                               </div>
                                           </div>

                                           <!-- Espaciado entre IR Final y Potencial -->
                                           <div style='line-height: 1.8;'><br></div>

                                           <!-- Potencial de Mejora / Mensaje Final -->
                                           {% if canal_data.gap_ingreso_pp < -1 %}
                                           <div style='background: rgba(251, 191, 36, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #fbbf24;'>
                                               <span style='font-weight: 700;'>💡 Potencial:</span>
                                               <span style='color: #fbbf24; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                               <span style='color: rgba(255,255,255,0.7);'>(+${{ '{:,.0f}'.format(canal_data.potencial_mensual) }}/mes)</span>
                                           </div>
                                           {% elif canal_data.gap_ingreso_pp >= 0 %}
                                           <div style='background: rgba(52, 211, 153, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #34d399;'>
                                               <span style='font-weight: 700; color: #34d399;'>✓ Superando ideal:</span>
                                               <span style='color: #34d399; font-weight: 700;'>{{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp</span>
                                           </div>
                                           {% else %}
                                           <div style='background: rgba(34, 197, 94, 0.15); padding: 6px 8px; border-radius: 4px; font-size: 0.85em; border-left: 3px solid #22c55e;'>
                                               <span style='font-weight: 700; color: #22c55e;'>✓ Cerca del ideal</span>
                                               <span style='color: rgba(255,255,255,0.7);'>({{ '{:+.1f}'.format(canal_data.gap_ingreso_pp) }}pp)</span>
                                           </div>
                                           {% endif %}
                                       </div>
                                       ">
                                    </i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ventas_reales_promedio) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.costo_venta_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.gastos_directos_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if canal_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(canal_data.ingreso_real) }}
                            </span>
                            <br>
                            {% if canal_data.variacion_ingreso_pct != 0 %}
                            <!-- Nivel 2: Variación nominal de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}%</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                            <!-- Nivel 3: Precio promedio de ingreso real (SIEMPRE se muestra) -->
                            <small class="text-muted d-block {% if canal_data.variacion_ingreso_pct != 0 %}mt-1{% endif %}" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(canal_data.ingreso_real_promedio) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.costo_venta_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- Variación de costo de venta por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if canal_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- Variación de gastos directos por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.ingreso_real_porcentaje if canal_data.ingreso_real_porcentaje is defined else 0) >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.ingreso_real_porcentaje if canal_data.ingreso_real_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_ingreso_pct is defined and canal_data.variacion_ingreso_pct != 0 %}
                            <br>
                            <!-- Variación de ingreso real por canal -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_ingreso_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(canal_data.roi_porcentaje if canal_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if canal_data.variacion_roi_pct is defined and canal_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if canal_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(canal_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ canal_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Subfilas temporales para SKU Remover -->
                    {% for mes_data in sku_data.desglose_meses %}
                    <tr class="mes-subfila mes-subfila-remover-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(220, 53, 69, 0.05); border-left: 4px solid #dc3545;">
                        <td style="padding: 10px 15px 10px 50px; vertical-align: middle; border: none;">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-info rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 25px; height: 25px; opacity: 0.8;">
                                        <i class="bi bi-calendar3 text-white" style="font-size: 0.7rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <span class="text-muted" style="font-size: 0.85rem; font-weight: 500;">
                                        {{ mes_data.mes_corto if mes_data.mes_corto is defined else mes_data.mes_nombre }}
                                    </span>
                                    <div class="mt-1">
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            <i class="bi bi-calendar-range me-1" style="color: #dc3545;"></i>{{ mes_data.periodo if mes_data.periodo is defined else (mes_data.num_transacciones + ' transacciones' if mes_data.num_transacciones is defined else '') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #28a745; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ventas_reales) }}
                            </span>
                            <br>
                            {% if mes_data.variacion_ventas_pct is defined and mes_data.variacion_ventas_pct != 0 %}
                            <!-- Variación de ventas por mes -->
                            <small class="d-flex align-items-center justify-content-center">
                                {% if mes_data.variacion_ventas_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.65rem;">+{{ "{:.1f}".format(mes_data.variacion_ventas_pct) }}%</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.8rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.65rem;">{{ "{:.1f}".format(mes_data.variacion_ventas_pct) }}%</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.6rem;"></i>
                                {% endif %}
                            </small>
                            {% else %}
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ventas_reales_promedio if mes_data.ventas_reales_promedio is defined else mes_data.ventas_reales) }}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #dc3545; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.costo_venta) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.costo_venta_promedio if mes_data.costo_venta_promedio is defined else mes_data.costo_venta) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: #ffc107; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.gastos_directos) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.gastos_directos_promedio if mes_data.gastos_directos_promedio is defined else mes_data.gastos_directos) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="fw-bold" style="color: {{ '#6f42c1' if mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.9rem;">
                                ${{ "{:,.0f}".format(mes_data.ingreso_real) }}
                            </span>
                            <br>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                Prom: ${{ "{:,.0f}".format(mes_data.ingreso_real_promedio if mes_data.ingreso_real_promedio is defined else mes_data.ingreso_real) }}
                            </small>
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.costo_venta_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_costo_venta_pct is defined and mes_data.variacion_costo_venta_pct != 0 %}
                            <br>
                            <!-- Variación de costo de venta por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_costo_venta_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_costo_venta_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_costo_venta_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.gastos_directos_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_gastos_directos_pct is defined and mes_data.variacion_gastos_directos_pct != 0 %}
                            <br>
                            <!-- Variación de gastos directos por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_gastos_directos_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_gastos_directos_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_gastos_directos_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.ingreso_real_porcentaje) }}
                            </span>
                            {% if mes_data.variacion_ingreso_pct is defined and mes_data.variacion_ingreso_pct != 0 %}
                            <br>
                            <!-- Variación de ingreso real por mes -->
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_ingreso_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_ingreso_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_ingreso_pct) }}pp</span>
                                {% endif %}
                                {% if mes_data.periodo_comparacion is defined %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                                {% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td class="text-center" style="padding: 10px; vertical-align: middle; border: none;">
                            <span class="badge rounded-pill"
                                  style="background: linear-gradient(135deg,
                                         {% if (mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                         color: white; font-size: 0.7rem; padding: 6px 10px;">
                                {{ "{:.1f}%".format(mes_data.roi_porcentaje if mes_data.roi_porcentaje is defined else 0) }}
                            </span>
                            {% if mes_data.variacion_roi_pct is defined and mes_data.variacion_roi_pct != 0 %}
                            <br>
                            <small class="d-flex align-items-center justify-content-center mt-1">
                                {% if mes_data.variacion_roi_pct > 0 %}
                                    <i class="bi bi-arrow-up-short text-success me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-success fw-semibold" style="font-size: 0.6rem;">+{{ "{:.1f}".format(mes_data.variacion_roi_pct) }}pp</span>
                                {% else %}
                                    <i class="bi bi-arrow-down-short text-danger me-1" style="font-size: 0.7rem;"></i>
                                    <span class="text-danger fw-semibold" style="font-size: 0.6rem;">{{ "{:.1f}".format(mes_data.variacion_roi_pct) }}pp</span>
                                {% endif %}
                                <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                                   title="{{ mes_data.periodo_comparacion }}" style="font-size: 0.5rem;"></i>
                            </small>
                            {% endif %}
                        </td>

                        <!-- Subfilas de canal por mes para SKU Remover (cuando ambos desgloses están activos) -->
                        {% for canal_mes_data in mes_data.desglose_canales %}
                        <tr class="canal-mes-subfila canal-mes-subfila-remover-{{ loop.index0 }}{% if sku_data.get('es_sku_componente', False) %} subfila-componente{% endif %}" {% if sku_data.get('es_sku_componente', False) %}data-sku-principal="{{ sku_data.sku_principal }}"{% endif %} style="display: none; background: rgba(220, 53, 69, 0.03); border-left: 4px solid #dc3545;">
                            <td style="padding: 8px 15px 8px 75px; vertical-align: middle; border: none;">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                                             style="width: 20px; height: 20px; border: 2px solid #dc3545;">
                                            <i class="bi bi-dot" style="font-size: 0.8rem; color: #dc3545;"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <span class="text-muted" style="font-size: 0.75rem; font-weight: 500;">
                                            {{ canal_mes_data.canal }}
                                        </span>
                                        <div class="mt-1">
                                            <small class="text-muted" style="font-size: 0.65rem;">
                                                <i class="bi bi-receipt me-1" style="color: #dc3545;"></i>{{ canal_mes_data.num_transacciones }} transacciones
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #28a745; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.ventas_reales) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.ventas_reales_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #dc3545; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.costo_venta) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.costo_venta_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: #ffc107; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.gastos_directos) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.gastos_directos_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="fw-bold" style="color: {{ '#6f42c1' if canal_mes_data.ingreso_real >= 0 else '#dc3545' }}; font-size: 0.8rem;">
                                    ${{ "{:,.0f}".format(canal_mes_data.ingreso_real) }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.65rem;">
                                    Prom: ${{ "{:,.0f}".format(canal_mes_data.ingreso_real_promedio) }}
                                </small>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9)); color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.costo_venta_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.8), rgba(224, 168, 0, 0.9)); color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.gastos_directos_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg,
                                             {% if canal_mes_data.ingreso_real_porcentaje >= 0 %}rgba(111, 66, 193, 0.8), rgba(155, 89, 182, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                             color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.ingreso_real_porcentaje) }}
                                </span>
                            </td>
                            <td class="text-center" style="padding: 8px; vertical-align: middle; border: none;">
                                <span class="badge rounded-pill"
                                      style="background: linear-gradient(135deg,
                                             {% if (canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) >= 0 %}rgba(32, 201, 151, 0.8), rgba(40, 167, 69, 0.9){% else %}rgba(220, 53, 69, 0.8), rgba(200, 35, 51, 0.9){% endif %});
                                             color: white; font-size: 0.65rem; padding: 4px 8px;">
                                    {{ "{:.1f}%".format(canal_mes_data.roi_porcentaje if canal_mes_data.roi_porcentaje is defined else 0) }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-trash text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No hay SKUs clasificados como Candidatos a Remoción en este período</p>
            </div>
            {% endif %}
        </div>

    </div>
    {% endif %}

</div>

<script>
// Función para animar las tarjetas de métricas
function animateMetricCard(card) {
    // Animación para barras de progreso inferiores
    const progressBar = card.querySelector('.h-100.transition-all');
    if (progressBar && progressBar.style.width === '0%') {
        progressBar.style.width = '100%';
    }

    // Animación específica para tarjeta ROI (círculo de progreso)
    const roiCircle = card.querySelector('circle[stroke-dashoffset]');
    if (roiCircle) {
        // Activar animación del círculo ROI al hacer hover
        roiCircle.style.animationPlayState = 'running';
    }
}

function resetMetricCard(card) {
    // Reset animation si es necesario
}

// ===== FUNCIONES DE LA TABLA DE CANALES =====

function highlightTableRow(row) {
    row.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.04))';
    row.style.transform = 'translateY(-2px)';
    row.style.boxShadow = '0 4px 12px rgba(212, 175, 55, 0.15)';
    
    // Destacar también la card correspondiente si existe
    const canalName = row.getAttribute('data-canal');
    const correspondingCard = document.querySelector(`.canal-card[data-canal="${canalName}"]`);
    if (correspondingCard) {
        correspondingCard.style.transform = 'translateY(-4px) scale(1.02)';
        correspondingCard.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.2)';
    }
}

function resetTableRow(row) {
    row.style.background = '';
    row.style.transform = '';
    row.style.boxShadow = '';
    
    // Resetear también la card correspondiente
    const canalName = row.getAttribute('data-canal');
    const correspondingCard = document.querySelector(`.canal-card[data-canal="${canalName}"]`);
    if (correspondingCard) {
        correspondingCard.style.transform = '';
        correspondingCard.style.boxShadow = '';
    }
}

function toggleSubfilas() {
    const subfilas = document.querySelectorAll('.subfila-row');
    const button = document.getElementById('toggle-subfilas');
    
    if (subfilas.length === 0) return;
    
    // Verificar si las sub-filas están visibles
    const isVisible = subfilas[0].style.display !== 'none';
    
    if (isVisible) {
        // Ocultar sub-filas con animación
        subfilas.forEach(subfila => {
            subfila.classList.remove('show');
            setTimeout(() => {
                subfila.style.display = 'none';
            }, 300); // Esperar a que termine la animación
        });
        
        // Cambiar botón
        button.innerHTML = '<i class="bi bi-eye me-2"></i>Ver Desglose por Marca';
        button.classList.remove('btn-warning');
        button.classList.add('btn-outline-info');
    } else {
        // Mostrar sub-filas con animación
        subfilas.forEach((subfila, index) => {
            subfila.style.display = 'table-row';
            setTimeout(() => {
                subfila.classList.add('show');
            }, index * 50); // Animación escalonada
        });
        
        // Cambiar botón
        button.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Ocultar Desglose por Marca';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-warning');
    }
}

function toggleCategorias() {
    const categorias = document.querySelectorAll('.categoria-row');
    const button = document.getElementById('toggle-categorias');

    if (categorias.length === 0) return;

    // Verificar si las filas de categoría están visibles
    const isVisible = categorias[0].style.display !== 'none';

    if (isVisible) {
        // Ocultar categorías con animación
        categorias.forEach(categoria => {
            categoria.classList.remove('show');
            setTimeout(() => {
                categoria.style.display = 'none';
            }, 300); // Esperar a que termine la animación
        });

        // Cambiar botón
        button.innerHTML = '<i class="bi bi-tags me-2"></i>Ver Desglose por Categoría';
        button.classList.remove('btn-warning');
        button.classList.add('btn-outline-success');
    } else {
        // Mostrar categorías con animación
        categorias.forEach((categoria, index) => {
            categoria.style.display = 'table-row';
            setTimeout(() => {
                categoria.classList.add('show');
            }, index * 30); // Animación escalonada más rápida para categorías
        });

        // Cambiar botón
        button.innerHTML = '<i class="bi bi-tags-fill me-2"></i>Ocultar Desglose por Categoría';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-warning');
    }
}

// ===== FUNCIÓN PARA TOGGLE ENTRE CLASIFICACIONES DE SKUs =====

function toggleClasificacion(tipo) {
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');
    const buttonEstrella = document.getElementById('toggle-estrella');
    const buttonPrometedores = document.getElementById('toggle-prometedores');
    const buttonPotenciales = document.getElementById('toggle-potenciales');
    const buttonRevision = document.getElementById('toggle-revision');
    const buttonRemover = document.getElementById('toggle-remover');

    if (!tablaEstrella || !tablaPrometedores || !tablaPotenciales || !tablaRevision || !tablaRemover ||
        !buttonEstrella || !buttonPrometedores || !buttonPotenciales || !buttonRevision || !buttonRemover) {
        console.error('No se encontraron los elementos necesarios para el toggle de clasificaciones');
        return;
    }

    // Ocultar todas las tablas primero
    tablaEstrella.style.display = 'none';
    tablaPrometedores.style.display = 'none';
    tablaPotenciales.style.display = 'none';
    tablaRevision.style.display = 'none';
    tablaRemover.style.display = 'none';

    // Resetear todos los botones a estado inactivo
    // Botón Estrella inactivo
    buttonEstrella.classList.remove('btn-warning');
    buttonEstrella.classList.add('btn-outline-warning');
    buttonEstrella.style.background = 'transparent';
    buttonEstrella.style.borderColor = '#D4AF37';
    buttonEstrella.style.color = '#D4AF37';

    // Botón Prometedores inactivo
    buttonPrometedores.classList.remove('btn-secondary');
    buttonPrometedores.classList.add('btn-outline-secondary');
    buttonPrometedores.style.background = 'transparent';
    buttonPrometedores.style.borderColor = '#6c757d';
    buttonPrometedores.style.color = '#6c757d';

    // Botón Potenciales inactivo
    buttonPotenciales.classList.remove('btn-info');
    buttonPotenciales.classList.add('btn-outline-info');
    buttonPotenciales.style.background = 'transparent';
    buttonPotenciales.style.borderColor = '#17a2b8';
    buttonPotenciales.style.color = '#17a2b8';

    // Botón Revisión inactivo
    buttonRevision.classList.remove('btn-warning');
    buttonRevision.classList.add('btn-outline-warning');
    buttonRevision.style.background = 'transparent';
    buttonRevision.style.borderColor = '#fd7e14';
    buttonRevision.style.color = '#fd7e14';

    // Botón Remover inactivo
    buttonRemover.classList.remove('btn-danger');
    buttonRemover.classList.add('btn-outline-danger');
    buttonRemover.style.background = 'transparent';
    buttonRemover.style.borderColor = '#dc3545';
    buttonRemover.style.color = '#dc3545';

    // Mostrar tabla y activar botón correspondiente
    if (tipo === 'estrella') {
        tablaEstrella.style.display = 'block';

        // Activar botón Estrella
        buttonEstrella.classList.remove('btn-outline-warning');
        buttonEstrella.classList.add('btn-warning');
        buttonEstrella.style.background = 'linear-gradient(135deg, #D4AF37, #B8941F)';
        buttonEstrella.style.borderColor = '#D4AF37';
        buttonEstrella.style.color = 'white';

    } else if (tipo === 'prometedores') {
        tablaPrometedores.style.display = 'block';

        // Activar botón Prometedores
        buttonPrometedores.classList.remove('btn-outline-secondary');
        buttonPrometedores.classList.add('btn-secondary');
        buttonPrometedores.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
        buttonPrometedores.style.borderColor = '#6c757d';
        buttonPrometedores.style.color = 'white';

    } else if (tipo === 'potenciales') {
        tablaPotenciales.style.display = 'block';

        // Activar botón Potenciales
        buttonPotenciales.classList.remove('btn-outline-info');
        buttonPotenciales.classList.add('btn-info');
        buttonPotenciales.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
        buttonPotenciales.style.borderColor = '#17a2b8';
        buttonPotenciales.style.color = 'white';

    } else if (tipo === 'revision') {
        tablaRevision.style.display = 'block';

        // Activar botón Revisión
        buttonRevision.classList.remove('btn-outline-warning');
        buttonRevision.classList.add('btn-warning');
        buttonRevision.style.background = 'linear-gradient(135deg, #fd7e14, #e85d04)';
        buttonRevision.style.borderColor = '#fd7e14';
        buttonRevision.style.color = 'white';

    } else if (tipo === 'remover') {
        tablaRemover.style.display = 'block';

        // Activar botón Remover
        buttonRemover.classList.remove('btn-outline-danger');
        buttonRemover.classList.add('btn-danger');
        buttonRemover.style.background = 'linear-gradient(135deg, #dc3545, #c92a2a)';
        buttonRemover.style.borderColor = '#dc3545';
        buttonRemover.style.color = 'white';
    }

    // Actualizar visibilidad del botón de expandir SKUs componentes
    actualizarBotonExpandir();

    console.log(`✅ Toggle de clasificación: Mostrando ${tipo}`);
}

// ===== FUNCIÓN AUXILIAR PARA VERIFICAR ESTADO DE EXPANDIR UNIFICADOS =====

function verificarEstadoExpandirUnificados() {
    // Determinar qué tabla está activa y verificar su botón correspondiente
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');

    let botonExpandir = null;

    if (tablaEstrella && tablaEstrella.style.display !== 'none' && tablaEstrella.style.display !== '') {
        botonExpandir = document.getElementById('toggle-skus-componentes');
    } else if (tablaPrometedores && tablaPrometedores.style.display !== 'none' && tablaPrometedores.style.display !== '') {
        botonExpandir = document.getElementById('toggle-skus-componentes-prometedores');
    } else if (tablaPotenciales && tablaPotenciales.style.display !== 'none' && tablaPotenciales.style.display !== '') {
        botonExpandir = document.getElementById('toggle-skus-componentes-potenciales');
    } else if (tablaRevision && tablaRevision.style.display !== 'none' && tablaRevision.style.display !== '') {
        botonExpandir = document.getElementById('toggle-skus-componentes-revision');
    } else if (tablaRemover && tablaRemover.style.display !== 'none' && tablaRemover.style.display !== '') {
        botonExpandir = document.getElementById('toggle-skus-componentes-remover');
    }

    // Verificar si el botón existe y está en modo expandido
    if (!botonExpandir) {
        return false; // No hay botón, por defecto colapsado
    }

    const estaExpandido = botonExpandir.innerHTML.includes('Colapsar');
    console.log(`🔍 Estado Expandir Unificados: ${estaExpandido ? 'ACTIVADO' : 'DESACTIVADO'}`);
    return estaExpandido;
}

// ===== FUNCIÓN PARA TOGGLE DE SUBFILAS DE CANAL POR SKU =====

function toggleCanalesSku() {
    console.log('🔄 Ejecutando toggle de canales por SKU...');

    // Determinar qué tabla está activa
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');

    let selectorCanales = '';

    if (tablaEstrella && tablaEstrella.style.display !== 'none' && tablaEstrella.style.display !== '') {
        selectorCanales = '#tabla-estrella .canal-subfila';
        console.log('📊 Tabla activa: Estrella');
    } else if (tablaPrometedores && tablaPrometedores.style.display !== 'none' && tablaPrometedores.style.display !== '') {
        selectorCanales = '#tabla-prometedores .canal-subfila';
        console.log('📊 Tabla activa: Prometedores');
    } else if (tablaPotenciales && tablaPotenciales.style.display !== 'none' && tablaPotenciales.style.display !== '') {
        selectorCanales = '#tabla-potenciales .canal-subfila';
        console.log('📊 Tabla activa: Potenciales');
    } else if (tablaRevision && tablaRevision.style.display !== 'none' && tablaRevision.style.display !== '') {
        selectorCanales = '#tabla-revision .canal-subfila';
        console.log('📊 Tabla activa: Revisión');
    } else if (tablaRemover && tablaRemover.style.display !== 'none' && tablaRemover.style.display !== '') {
        selectorCanales = '#tabla-remover .canal-subfila';
        console.log('📊 Tabla activa: Remover');
    } else {
        console.warn('⚠️ No se encontró tabla activa');
        return;
    }

    // Verificar si el botón de meses también está activo
    const btnMeses = document.getElementById('btn-desglose-meses');
    const mesesActivos = btnMeses && btnMeses.innerHTML.includes('Ocultar');

    // Seleccionar todas las subfilas de canal en la tabla activa
    const subfilas = document.querySelectorAll(selectorCanales);
    console.log(`🔍 Encontradas ${subfilas.length} subfilas de canal`);

    if (subfilas.length === 0) {
        console.warn('⚠️ No se encontraron subfilas de canal para mostrar/ocultar');
        return;
    }

    // Verificar el estado actual basándose en si hay alguna subfila visible
    const haySubfilasVisibles = Array.from(subfilas).some(subfila =>
        subfila.style.display !== 'none' && subfila.style.display !== ''
    );

    // Toggle: si hay subfilas visibles, ocultarlas; si no hay visibles, mostrarlas
    const nuevoEstado = haySubfilasVisibles ? 'none' : 'table-row';

    // LÓGICA DE PRECEDENCIA: Si los meses están activos, las subfilas de canal se ocultan
    // para evitar duplicación (el desglose por mes tiene precedencia)
    const mostrarCanales = (nuevoEstado === 'table-row') && !mesesActivos;

    // Verificar el estado del botón "Expandir Unificados" para la tabla activa
    const expandirActivado = verificarEstadoExpandirUnificados();

    subfilas.forEach((subfila, index) => {
        const esSubfilaComponente = subfila.classList.contains('subfila-componente');

        let mostrarEstaSubfila = false;
        if (esSubfilaComponente) {
            // Subfila de componente: solo mostrar si expandir está activado Y canales están activos
            mostrarEstaSubfila = mostrarCanales && expandirActivado;
        } else {
            // Subfila de producto unificado: solo mostrar si expandir está desactivado Y canales están activos
            mostrarEstaSubfila = mostrarCanales && !expandirActivado;
        }

        subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
        console.log(`${mostrarEstaSubfila ? '👀' : '🙈'} Subfila canal ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'mostrada' : 'oculta'}`);
    });

    // Contar cuántas subfilas están realmente visibles
    const subfilasVisibles = Array.from(subfilas).filter(subfila => subfila.style.display === 'table-row').length;

    // Actualizar el botón basándose en si hay subfilas realmente visibles
    const btnCanales = document.getElementById('btn-desglose-canales');
    if (btnCanales) {
        if (subfilasVisibles > 0) {
            // Hay subfilas visibles - botón activo
            btnCanales.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Ocultar Desglose por Canal';
            btnCanales.className = 'btn btn-sm btn-outline-secondary';
            console.log(`🔵 Botón actualizado: Canal activo (${subfilasVisibles} subfilas visibles)`);
        } else {
            // No hay subfilas visibles - botón inactivo
            btnCanales.innerHTML = '<i class="bi bi-eye me-2"></i>Ver Desglose por Canal';
            btnCanales.className = 'btn btn-sm btn-outline-primary';
            console.log('🔴 Botón actualizado: Canal inactivo (sin subfilas visibles)');
        }
    }

    console.log(`✅ Toggle canales completado: Estado lógico ${nuevoEstado === 'table-row' ? 'activo' : 'inactivo'}, Visibilidad ${mostrarCanales ? 'mostrado' : 'oculto'}`);

    // Actualizar las subfilas canal-mes según el estado actual
    actualizarSubfilasCanalesMeses();
}

// ===== FUNCIÓN PARA TOGGLE DE SUBFILAS TEMPORALES POR SKU =====

function toggleMesesSku() {
    console.log('📅 Ejecutando toggle de meses por SKU...');

    // Determinar qué clasificación está activa actualmente
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');

    let tablaActiva = null;
    let selectorMeses = '';
    let selectorCanalesMeses = '';

    if (tablaEstrella && tablaEstrella.style.display !== 'none' && tablaEstrella.style.display !== '') {
        tablaActiva = tablaEstrella;
        selectorMeses = '#tabla-estrella .mes-subfila';
        selectorCanalesMeses = '#tabla-estrella .canal-mes-subfila';
        console.log('📊 Tabla activa: Estrella');
    } else if (tablaPrometedores && tablaPrometedores.style.display !== 'none' && tablaPrometedores.style.display !== '') {
        tablaActiva = tablaPrometedores;
        selectorMeses = '#tabla-prometedores .mes-subfila';
        selectorCanalesMeses = '#tabla-prometedores .canal-mes-subfila';
        console.log('📊 Tabla activa: Prometedores');
    } else if (tablaPotenciales && tablaPotenciales.style.display !== 'none' && tablaPotenciales.style.display !== '') {
        tablaActiva = tablaPotenciales;
        selectorMeses = '#tabla-potenciales .mes-subfila';
        selectorCanalesMeses = '#tabla-potenciales .canal-mes-subfila';
        console.log('📊 Tabla activa: Potenciales');
    } else if (tablaRevision && tablaRevision.style.display !== 'none' && tablaRevision.style.display !== '') {
        tablaActiva = tablaRevision;
        selectorMeses = '#tabla-revision .mes-subfila';
        selectorCanalesMeses = '#tabla-revision .canal-mes-subfila';
        console.log('📊 Tabla activa: Revisión');
    } else if (tablaRemover && tablaRemover.style.display !== 'none' && tablaRemover.style.display !== '') {
        tablaActiva = tablaRemover;
        selectorMeses = '#tabla-remover .mes-subfila';
        selectorCanalesMeses = '#tabla-remover .canal-mes-subfila';
        console.log('📊 Tabla activa: Remover');
    } else {
        console.warn('⚠️ No se encontró tabla activa');
        return;
    }

    // Seleccionar todas las subfilas temporales en la tabla activa específica
    const subfilasMeses = document.querySelectorAll(selectorMeses);
    const subfilasCanalesMeses = document.querySelectorAll(selectorCanalesMeses);

    console.log(`🔍 Encontradas ${subfilasMeses.length} subfilas de meses y ${subfilasCanalesMeses.length} subfilas de canal-mes`);

    if (subfilasMeses.length === 0) {
        console.warn('⚠️ No se encontraron subfilas temporales para mostrar/ocultar');
        return;
    }

    // Verificar el estado actual basándose en si hay alguna subfila de mes visible
    const haySubfilasMesesVisibles = Array.from(subfilasMeses).some(subfila =>
        subfila.style.display !== 'none' && subfila.style.display !== ''
    );

    // Toggle: si hay subfilas visibles, ocultarlas; si no hay visibles, mostrarlas
    const nuevoEstado = haySubfilasMesesVisibles ? 'none' : 'table-row';

    // Verificar si el desglose por canal también está activo
    const btnCanales = document.getElementById('btn-desglose-canales');
    const canalesActivos = btnCanales && btnCanales.innerHTML.includes('Ocultar');

    // LÓGICA DE PRECEDENCIA: Cuando los meses se activan, ocultar las subfilas de canal
    // para evitar duplicación (el desglose por mes tiene precedencia)
    if (nuevoEstado === 'table-row' && canalesActivos) {
        // Ocultar subfilas de canal individuales para evitar duplicación
        let selectorCanales = '';
        if (tablaActiva === tablaEstrella) {
            selectorCanales = '#tabla-estrella .canal-subfila';
        } else if (tablaActiva === tablaPrometedores) {
            selectorCanales = '#tabla-prometedores .canal-subfila';
        } else if (tablaActiva === tablaPotenciales) {
            selectorCanales = '#tabla-potenciales .canal-subfila';
        } else if (tablaActiva === tablaRevision) {
            selectorCanales = '#tabla-revision .canal-subfila';
        } else if (tablaActiva === tablaRemover) {
            selectorCanales = '#tabla-remover .canal-subfila';
        }

        const subfilasCanal = document.querySelectorAll(selectorCanales);
        subfilasCanal.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`🙈 Subfila canal individual ${index + 1}: oculta por precedencia`);
        });
    }

    // Verificar el estado del botón "Expandir Unificados" para la tabla activa
    const expandirActivado = verificarEstadoExpandirUnificados();

    // Mostrar/ocultar subfilas de meses
    subfilasMeses.forEach((subfila, index) => {
        const esSubfilaComponente = subfila.classList.contains('subfila-componente');

        let mostrarEstaSubfila = false;
        if (esSubfilaComponente) {
            // Subfila de componente: solo mostrar si expandir está activado Y meses están activos
            mostrarEstaSubfila = (nuevoEstado === 'table-row') && expandirActivado;
        } else {
            // Subfila de producto unificado: solo mostrar si expandir está desactivado Y meses están activos
            mostrarEstaSubfila = (nuevoEstado === 'table-row') && !expandirActivado;
        }

        subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
        console.log(`${mostrarEstaSubfila ? '📅' : '🗓️'} Subfila mes ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'mostrada' : 'oculta'}`);
    });

    // Si los meses están visibles Y los canales están activos, mostrar también las subfilas canal-mes
    if (nuevoEstado === 'table-row' && canalesActivos) {
        subfilasCanalesMeses.forEach((subfila, index) => {
            const esSubfilaComponente = subfila.classList.contains('subfila-componente');

            let mostrarEstaSubfila = false;
            if (esSubfilaComponente) {
                // Subfila canal-mes de componente: solo mostrar si expandir está activado
                mostrarEstaSubfila = expandirActivado;
            } else {
                // Subfila canal-mes de producto unificado: solo mostrar si expandir está desactivado
                mostrarEstaSubfila = !expandirActivado;
            }

            subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
            console.log(`🔗 Subfila canal-mes ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'mostrada' : 'oculta'}`);
        });
    } else {
        // Si los meses se ocultan O los canales no están activos, ocultar las subfilas canal-mes
        subfilasCanalesMeses.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`🔗 Subfila canal-mes ${index + 1}: oculta`);
        });

        // Si los meses se desactivan pero los canales siguen activos, mostrar las subfilas de canal individuales
        if (nuevoEstado === 'none' && canalesActivos) {
            let selectorCanales = '';
            if (tablaActiva === tablaEstrella) {
                selectorCanales = '#tabla-estrella .canal-subfila';
            } else if (tablaActiva === tablaPrometedores) {
                selectorCanales = '#tabla-prometedores .canal-subfila';
            } else if (tablaActiva === tablaPotenciales) {
                selectorCanales = '#tabla-potenciales .canal-subfila';
            }

            const subfilasCanal = document.querySelectorAll(selectorCanales);
            subfilasCanal.forEach((subfila, index) => {
                const esSubfilaComponente = subfila.classList.contains('subfila-componente');

                let mostrarEstaSubfila = false;
                if (esSubfilaComponente) {
                    // Subfila de componente: solo mostrar si expandir está activado
                    mostrarEstaSubfila = expandirActivado;
                } else {
                    // Subfila de producto unificado: solo mostrar si expandir está desactivado
                    mostrarEstaSubfila = !expandirActivado;
                }

                subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
                console.log(`👀 Subfila canal individual ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'restaurada' : 'mantenida oculta'}`);
            });
        }
    }

    // Contar cuántas subfilas de mes están realmente visibles
    const subfilasMesesVisibles = Array.from(subfilasMeses).filter(subfila => subfila.style.display === 'table-row').length;

    // Actualizar el botón basándose en si hay subfilas realmente visibles
    const btnMeses = document.getElementById('btn-desglose-meses');
    if (btnMeses) {
        if (subfilasMesesVisibles > 0) {
            // Hay subfilas visibles - botón activo
            btnMeses.innerHTML = '<i class="bi bi-calendar-x me-2"></i>Ocultar Desglose por Mes';
            btnMeses.className = 'btn btn-sm btn-outline-secondary ms-2';
            console.log(`📘 Botón actualizado: Meses activo (${subfilasMesesVisibles} subfilas visibles)`);
        } else {
            // No hay subfilas visibles - botón inactivo
            btnMeses.innerHTML = '<i class="bi bi-calendar3 me-2"></i>Ver Desglose por Mes';
            btnMeses.className = 'btn btn-sm btn-outline-info ms-2';
            console.log('📙 Botón actualizado: Meses inactivo (sin subfilas visibles)');
        }
    }

    console.log(`✅ Toggle temporal completado: Subfilas ${nuevoEstado === 'table-row' ? 'mostradas' : 'ocultas'}`);
}

// ===== FUNCIÓN AUXILIAR PARA MANEJAR LA INTERACCIÓN ENTRE AMBOS DESGLOSES =====

function actualizarSubfilasCanalesMeses() {
    console.log('🔄 Actualizando subfilas canal-mes según estado actual...');

    // Determinar qué tabla está activa
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');

    let selectorMeses = '';
    let selectorCanalesMeses = '';
    let selectorCanales = '';

    if (tablaEstrella && tablaEstrella.style.display !== 'none' && tablaEstrella.style.display !== '') {
        selectorMeses = '#tabla-estrella .mes-subfila';
        selectorCanalesMeses = '#tabla-estrella .canal-mes-subfila';
        selectorCanales = '#tabla-estrella .canal-subfila';
    } else if (tablaPrometedores && tablaPrometedores.style.display !== 'none' && tablaPrometedores.style.display !== '') {
        selectorMeses = '#tabla-prometedores .mes-subfila';
        selectorCanalesMeses = '#tabla-prometedores .canal-mes-subfila';
        selectorCanales = '#tabla-prometedores .canal-subfila';
    } else if (tablaPotenciales && tablaPotenciales.style.display !== 'none' && tablaPotenciales.style.display !== '') {
        selectorMeses = '#tabla-potenciales .mes-subfila';
        selectorCanalesMeses = '#tabla-potenciales .canal-mes-subfila';
        selectorCanales = '#tabla-potenciales .canal-subfila';
    } else if (tablaRevision && tablaRevision.style.display !== 'none' && tablaRevision.style.display !== '') {
        selectorMeses = '#tabla-revision .mes-subfila';
        selectorCanalesMeses = '#tabla-revision .canal-mes-subfila';
        selectorCanales = '#tabla-revision .canal-subfila';
    } else if (tablaRemover && tablaRemover.style.display !== 'none' && tablaRemover.style.display !== '') {
        selectorMeses = '#tabla-remover .mes-subfila';
        selectorCanalesMeses = '#tabla-remover .canal-mes-subfila';
        selectorCanales = '#tabla-remover .canal-subfila';
    } else {
        console.warn('⚠️ No se encontró tabla activa para actualizar subfilas canal-mes');
        return;
    }

    const subfilasMeses = document.querySelectorAll(selectorMeses);
    const subfilasCanalesMeses = document.querySelectorAll(selectorCanalesMeses);

    // Verificar si los meses están visibles (en la tabla activa)
    const mesesVisibles = subfilasMeses.length > 0 && subfilasMeses[0].style.display === 'table-row';

    // Verificar si los canales están activos
    const btnCanales = document.getElementById('btn-desglose-canales');
    const canalesActivos = btnCanales && btnCanales.innerHTML.includes('Ocultar');

    // Verificar si los meses están activos
    const btnMeses = document.getElementById('btn-desglose-meses');
    const mesesActivos = btnMeses && btnMeses.innerHTML.includes('Ocultar');

    // LÓGICA DE PRECEDENCIA ACTUALIZADA:
    // - Si solo canales activos: mostrar subfilas de canal individuales
    // - Si solo meses activos: mostrar subfilas de mes
    // - Si ambos activos: mostrar subfilas de mes + subfilas de canal-mes (NO subfilas de canal individuales)

    // Verificar el estado del botón "Expandir Unificados" para la tabla activa
    const expandirActivado = verificarEstadoExpandirUnificados();

    if (mesesActivos && canalesActivos) {
        // CASO: Ambos botones activos -> Mostrar canal-mes, ocultar canal individuales
        subfilasCanalesMeses.forEach((subfila, index) => {
            const esSubfilaComponente = subfila.classList.contains('subfila-componente');

            let mostrarEstaSubfila = false;
            if (esSubfilaComponente) {
                // Subfila canal-mes de componente: solo mostrar si expandir está activado
                mostrarEstaSubfila = expandirActivado;
            } else {
                // Subfila canal-mes de producto unificado: solo mostrar si expandir está desactivado
                mostrarEstaSubfila = !expandirActivado;
            }

            subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
            console.log(`🔗 Subfila canal-mes ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'mostrada' : 'oculta'} (ambos activos)`);
        });

        // Ocultar subfilas de canal individuales para evitar duplicación
        const subfilasCanal = document.querySelectorAll(selectorCanales);
        subfilasCanal.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`🙈 Subfila canal individual ${index + 1}: oculta por precedencia`);
        });

        console.log(`✅ Modo ambos activos: Canal-mes mostradas, canal individuales ocultas`);

    } else if (canalesActivos && !mesesActivos) {
        // CASO: Solo canales activos -> Mostrar canal individuales, ocultar canal-mes
        subfilasCanalesMeses.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`🔗 Subfila canal-mes ${index + 1}: oculta (solo canales activo)`);
        });

        const subfilasCanal = document.querySelectorAll(selectorCanales);
        subfilasCanal.forEach((subfila, index) => {
            const esSubfilaComponente = subfila.classList.contains('subfila-componente');

            let mostrarEstaSubfila = false;
            if (esSubfilaComponente) {
                // Subfila de componente: solo mostrar si expandir está activado
                mostrarEstaSubfila = expandirActivado;
            } else {
                // Subfila de producto unificado: solo mostrar si expandir NO está activado
                mostrarEstaSubfila = !expandirActivado;
            }

            subfila.style.display = mostrarEstaSubfila ? 'table-row' : 'none';
            console.log(`👀 Subfila canal individual ${index + 1} ${esSubfilaComponente ? '(componente)' : '(unificado)'}: ${mostrarEstaSubfila ? 'mostrada' : 'oculta'} (solo canales)`);
        });

        console.log(`✅ Modo solo canales: Canal individuales mostradas`);

    } else {
        // CASO: Meses no activos -> Ocultar todas las subfilas de canal-mes
        subfilasCanalesMeses.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`🔗 Subfila canal-mes ${index + 1}: oculta (meses no activos)`);
        });

        console.log(`✅ Canal-mes desactivadas`);
    }
}

// Inicializar estado por defecto (Estrella activo)
document.addEventListener('DOMContentLoaded', function() {
    // Asegurar que la tabla de Estrella esté visible por defecto
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');

    if (tablaEstrella && tablaPrometedores && tablaPotenciales) {
        tablaEstrella.style.display = 'block';
        tablaPrometedores.style.display = 'none';
        tablaPotenciales.style.display = 'none';
        console.log('✅ Estado inicial: Tabla de SKUs Estrella visible, Prometedores y Potenciales ocultas');
    }

    // Inicializar visibilidad del botón de expandir SKUs componentes
    actualizarBotonExpandir();
});

// ===== FUNCIÓN PARA EXPANDIR/COLAPSAR SKUs COMPONENTES =====

function toggleSkusComponentes(categoria = 'estrella') {
    console.log(`🔄 Ejecutando toggle de SKUs componentes para: ${categoria}...`);

    // Determinar qué tabla y botón usar según la categoría
    let tablaId, buttonId, skusComponentes;

    if (categoria === 'estrella') {
        tablaId = 'tabla-estrella';
        buttonId = 'toggle-skus-componentes';
    } else if (categoria === 'prometedores') {
        tablaId = 'tabla-prometedores';
        buttonId = 'toggle-skus-componentes-prometedores';
    } else if (categoria === 'potenciales') {
        tablaId = 'tabla-potenciales';
        buttonId = 'toggle-skus-componentes-potenciales';
    } else if (categoria === 'revision') {
        tablaId = 'tabla-revision';
        buttonId = 'toggle-skus-componentes-revision';
    } else if (categoria === 'remover') {
        tablaId = 'tabla-remover';
        buttonId = 'toggle-skus-componentes-remover';
    } else {
        console.error('❌ Categoría no válida:', categoria);
        return;
    }

    // Buscar SKUs componentes solo en la tabla activa
    const tabla = document.getElementById(tablaId);
    if (!tabla) {
        console.error(`❌ No se encontró la tabla: ${tablaId}`);
        return;
    }

    skusComponentes = tabla.querySelectorAll('.sku-componente');
    const subfilasComponentes = tabla.querySelectorAll('.subfila-componente');
    const button = document.getElementById(buttonId);

    if (!button) {
        console.error(`❌ No se encontró el botón: ${buttonId}`);
        return;
    }

    if (skusComponentes.length === 0 && subfilasComponentes.length === 0) {
        console.log(`⚠️ No se encontraron SKUs componentes ni subfilas en ${categoria} para mostrar/ocultar`);
        return;
    }

    // Verificar el estado actual (basado en el primer SKU componente o subfila)
    const primerElemento = skusComponentes.length > 0 ? skusComponentes[0] : subfilasComponentes[0];
    const estaExpandido = primerElemento && primerElemento.style.display !== 'none';

    if (estaExpandido) {
        // Colapsar: Ocultar todos los SKUs componentes y sus subfilas
        skusComponentes.forEach((sku, index) => {
            sku.style.display = 'none';
            console.log(`📦 SKU componente ${categoria} ${index + 1}: oculto`);
        });

        subfilasComponentes.forEach((subfila, index) => {
            subfila.style.display = 'none';
            console.log(`📊 Subfila componente ${categoria} ${index + 1}: oculta`);
        });

        // Actualizar botón según la categoría
        button.innerHTML = '<i class="bi bi-arrows-expand me-1"></i>Expandir Unificados';
        actualizarEstiloBotonColapsado(button, categoria);

        console.log(`✅ SKUs y subfilas componentes ${categoria} colapsados`);

    } else {
        // Expandir: Mostrar todos los SKUs componentes
        skusComponentes.forEach((sku, index) => {
            sku.style.display = 'table-row';
            console.log(`📦 SKU componente ${categoria} ${index + 1}: mostrado`);
        });

        // Para las subfilas, solo mostrar las que correspondan según el estado de los botones de desglose
        mostrarSubfilasComponentesSegunEstado(subfilasComponentes, categoria);

        // Actualizar botón según la categoría
        button.innerHTML = '<i class="bi bi-arrows-collapse me-1"></i>Colapsar Unificados';
        actualizarEstiloBotonExpandido(button, categoria);

        console.log(`✅ SKUs y subfilas componentes ${categoria} expandidos`);
    }
}

function mostrarSubfilasComponentesSegunEstado(subfilasComponentes, categoria) {
    console.log(`🔍 Evaluando estado de desgloses para mostrar subfilas componentes en ${categoria}...`);

    // Verificar estado de los botones de desglose
    const btnCanales = document.getElementById('btn-desglose-canales');
    const btnMeses = document.getElementById('btn-desglose-meses');

    const canalesActivos = btnCanales && btnCanales.innerHTML.includes('Ocultar');
    const mesesActivos = btnMeses && btnMeses.innerHTML.includes('Ocultar');

    console.log(`   📊 Estado: Canales=${canalesActivos}, Meses=${mesesActivos}`);

    subfilasComponentes.forEach((subfila, index) => {
        let mostrar = false;

        // Lógica similar a la de las subfilas normales
        if (subfila.classList.contains('canal-subfila')) {
            // Subfila de canal: mostrar si canales activos Y meses NO activos
            mostrar = canalesActivos && !mesesActivos;
        } else if (subfila.classList.contains('mes-subfila')) {
            // Subfila de mes: mostrar si meses activos
            mostrar = mesesActivos;
        } else if (subfila.classList.contains('canal-mes-subfila')) {
            // Subfila de canal-mes: mostrar si ambos activos
            mostrar = canalesActivos && mesesActivos;
        }

        subfila.style.display = mostrar ? 'table-row' : 'none';
        console.log(`   📊 Subfila componente ${index + 1} (${subfila.className}): ${mostrar ? 'mostrada' : 'oculta'}`);
    });
}

function actualizarEstiloBotonColapsado(button, categoria) {
    if (categoria === 'estrella') {
        button.className = 'btn btn-outline-warning btn-sm';
        button.style.borderColor = '#D4AF37';
        button.style.color = '#B8941F';
    } else if (categoria === 'prometedores') {
        button.className = 'btn btn-outline-secondary btn-sm';
        button.style.borderColor = '#6c757d';
        button.style.color = '#495057';
    } else if (categoria === 'potenciales') {
        button.className = 'btn btn-outline-info btn-sm';
        button.style.borderColor = '#17a2b8';
        button.style.color = '#138496';
    }
    button.style.background = 'transparent';
}

function actualizarEstiloBotonExpandido(button, categoria) {
    if (categoria === 'estrella') {
        button.className = 'btn btn-warning btn-sm';
        button.style.background = 'linear-gradient(135deg, #D4AF37, #B8941F)';
        button.style.color = 'white';
    } else if (categoria === 'prometedores') {
        button.className = 'btn btn-secondary btn-sm';
        button.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
        button.style.color = 'white';
    } else if (categoria === 'potenciales') {
        button.className = 'btn btn-info btn-sm';
        button.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
        button.style.color = 'white';
    }
}

// Función para verificar si una tabla tiene SKUs unificados
function tieneSkusUnificados(tablaId) {
    const tabla = document.getElementById(tablaId);
    if (!tabla) return false;

    // Buscar SKUs componentes (que solo existen si hay productos unificados)
    const skusComponentes = tabla.querySelectorAll('.sku-componente');

    console.log(`🔍 Verificando SKUs unificados en ${tablaId}: ${skusComponentes.length} componentes encontrados`);
    return skusComponentes.length > 0;
}

// Función para mostrar/ocultar los botones de expandir cuando se cambia de clasificación
function actualizarBotonExpandir() {
    const tablaEstrella = document.getElementById('tabla-estrella');
    const tablaPrometedores = document.getElementById('tabla-prometedores');
    const tablaPotenciales = document.getElementById('tabla-potenciales');
    const tablaRevision = document.getElementById('tabla-revision');
    const tablaRemover = document.getElementById('tabla-remover');

    const botonExpandirEstrella = document.getElementById('toggle-skus-componentes');
    const botonExpandirPrometedores = document.getElementById('toggle-skus-componentes-prometedores');
    const botonExpandirPotenciales = document.getElementById('toggle-skus-componentes-potenciales');
    const botonExpandirRevision = document.getElementById('toggle-skus-componentes-revision');
    const botonExpandirRemover = document.getElementById('toggle-skus-componentes-remover');

    // Ocultar todos los botones primero
    if (botonExpandirEstrella) botonExpandirEstrella.style.display = 'none';
    if (botonExpandirPrometedores) botonExpandirPrometedores.style.display = 'none';
    if (botonExpandirPotenciales) botonExpandirPotenciales.style.display = 'none';
    if (botonExpandirRevision) botonExpandirRevision.style.display = 'none';
    if (botonExpandirRemover) botonExpandirRemover.style.display = 'none';

    // Mostrar solo el botón de la tabla activa Y que tenga SKUs unificados
    if (tablaEstrella && tablaEstrella.style.display === 'block' && botonExpandirEstrella && tieneSkusUnificados('tabla-estrella')) {
        botonExpandirEstrella.style.display = 'inline-block';
        console.log('✅ Botón de expandir SKUs Estrella mostrado - tiene SKUs unificados');
    } else if (tablaPrometedores && tablaPrometedores.style.display === 'block' && botonExpandirPrometedores && tieneSkusUnificados('tabla-prometedores')) {
        botonExpandirPrometedores.style.display = 'inline-block';
        console.log('✅ Botón de expandir SKUs Prometedores mostrado - tiene SKUs unificados');
    } else if (tablaPotenciales && tablaPotenciales.style.display === 'block' && botonExpandirPotenciales && tieneSkusUnificados('tabla-potenciales')) {
        botonExpandirPotenciales.style.display = 'inline-block';
        console.log('✅ Botón de expandir SKUs Potenciales mostrado - tiene SKUs unificados');
    } else if (tablaRevision && tablaRevision.style.display === 'block' && botonExpandirRevision && tieneSkusUnificados('tabla-revision')) {
        botonExpandirRevision.style.display = 'inline-block';
        console.log('✅ Botón de expandir SKUs Revisión mostrado - tiene SKUs unificados');
    } else if (tablaRemover && tablaRemover.style.display === 'block' && botonExpandirRemover && tieneSkusUnificados('tabla-remover')) {
        botonExpandirRemover.style.display = 'inline-block';
        console.log('✅ Botón de expandir SKUs Remover mostrado - tiene SKUs unificados');
    }
}

// ===== FUNCIONES DE GRÁFICOS DE EVOLUCIÓN =====

// Función para gráfico de evolución de costo
function initializeCostoEvolucionChart() {
    console.log('🚀 Iniciando función de gráfico...');
    
    const canvas = document.getElementById('costoEvolucionChart');
    if (!canvas) {
        console.log('❌ Canvas costoEvolucionChart no encontrado');
        return false;
    }
    
    console.log('✅ Canvas encontrado');
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.log('❌ No se pudo obtener contexto 2D del canvas');
        return false;
    }
    
    // Configurar dimensiones originales que funcionaban bien
    const width = 280;
    const height = 80;
    
    canvas.width = width;
    canvas.height = height;
    
    console.log('📏 Canvas configurado:', width, 'x', height);
    
    // Limpiar canvas (sin fondo blanco grande)
    ctx.clearRect(0, 0, width, height);
    
    // Solo texto de debug temporal
    ctx.fillStyle = '#999';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GRÁFICO CARGANDO...', width/2, height/2);
    
    console.log('🎨 Canvas limpio, preparando gráfico...');
    
    // **USAR DATOS HARDCODEADOS PRIMERO PARA TESTING**
    const datosReales = {{ resumen_general.evolucion_costo | tojson }};
    console.log('📊 Datos del backend:', datosReales);
    
    // Datos de prueba realistas si no hay datos reales
    const datosTest = [
        {fecha: '01/12', porcentaje: 42.5},
        {fecha: '03/12', porcentaje: 41.8},
        {fecha: '05/12', porcentaje: 43.2},
        {fecha: '08/12', porcentaje: 44.1},
        {fecha: '10/12', porcentaje: 43.7},
        {fecha: '12/12', porcentaje: 42.9},
        {fecha: '15/12', porcentaje: 43.8},
        {fecha: '18/12', porcentaje: 42.4}
    ];
    
    // Usar datos reales si existen, si no usar datos de prueba
    const datos = (datosReales && datosReales.length > 0) ? datosReales : datosTest;
    
    console.log('📈 Datos a usar:', datos);
    console.log('📈 Cantidad de puntos:', datos.length);
    
    if (datos.length === 0) {
        // Solo limpiar el texto de debug
        ctx.clearRect(0, 0, width, height);
        
        ctx.fillStyle = '#6c757d';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sin datos disponibles', width/2, height/2);
        return true;
    }
    
    // Limpiar solo el texto de debug, no agregar fondo
    ctx.clearRect(0, 0, width, height);

    // Configurar área de dibujo con márgenes optimizados para evitar corte de etiquetas
    const marginTop = 18;      // Margen superior aumentado para evitar corte de valores
    const marginBottom = 15;   // Margen inferior normal
    const marginLeft = 18;     // Margen izquierdo aumentado
    const marginRight = 18;    // Margen derecho aumentado
    const chartWidth = width - (marginLeft + marginRight);
    const chartHeight = height - (marginTop + marginBottom);

    // Obtener rango de valores
    const valores = datos.map(d => parseFloat(d.porcentaje) || 0);
    const minVal = Math.min(...valores) - 2; // Un poco más bajo para mejor visualización
    const maxVal = Math.max(...valores) + 2; // Un poco más alto
    const range = maxVal - minVal;

    console.log('📊 Rango de datos: ', minVal.toFixed(1), '-', maxVal.toFixed(1), '% (range:', range.toFixed(1), ')');

    // PRIMERO: Dibujar área degradada bajo la línea
    const gradient = ctx.createLinearGradient(0, marginTop, 0, height - marginBottom);
    gradient.addColorStop(0, 'rgba(220, 53, 69, 0.3)');
    gradient.addColorStop(0.6, 'rgba(220, 53, 69, 0.1)');
    gradient.addColorStop(1, 'rgba(220, 53, 69, 0.02)');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(marginLeft, height - marginBottom);

    // Dibujar la línea superior del área
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.lineTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    // Cerrar el área hacia abajo
    const ultimoX = marginLeft + chartWidth;
    ctx.lineTo(ultimoX, height - marginBottom);
    ctx.closePath();
    ctx.fill();
    
    // SEGUNDO: Dibujar línea principal
    ctx.strokeStyle = '#dc3545';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    ctx.beginPath();

    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        console.log(`Punto ${index}: (${x.toFixed(1)}, ${y.toFixed(1)}) = ${punto.porcentaje}%`);

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    ctx.stroke();

    // TERCERO: Dibujar puntos visibles en cada mes
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        // Punto principal (círculo grande)
        ctx.fillStyle = '#dc3545';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();

        // Punto interior (círculo blanco más pequeño)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, 2 * Math.PI);
        ctx.fill();

        // Etiqueta del mes (abajo del punto)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(punto.fecha, x, height - 2);

        // Valor de porcentaje + posicionamiento dinámico
        ctx.fillStyle = '#dc3545';
        ctx.font = 'bold 9px Arial';

        // Ajuste dinámico: si el punto está muy arriba, colocar etiqueta debajo
        const labelOffset = y < (marginTop + 10) ? 14 : -10;
        ctx.fillText(punto.porcentaje.toFixed(1) + '%', x, y + labelOffset);
    });

    console.log('✅ Línea principal dibujada - estilo ultra minimalista');

    console.log('✅ Gráfico completado exitosamente');
    return true;
}

// Función para gráfico de evolución de ventas
function initializeVentasEvolucionChart() {
    console.log('🚀 Iniciando función de gráfico de ventas...');
    
    const canvas = document.getElementById('ventasEvolucionChart');
    if (!canvas) {
        console.log('❌ Canvas ventasEvolucionChart no encontrado');
        return false;
    }
    
    console.log('✅ Canvas de ventas encontrado');
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.log('❌ No se pudo obtener contexto 2D del canvas de ventas');
        return false;
    }
    
    // Configurar dimensiones (iguales al de costo)
    const width = 280;
    const height = 80;
    
    canvas.width = width;
    canvas.height = height;
    
    console.log('📏 Canvas de ventas configurado:', width, 'x', height);
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Solo texto de debug temporal
    ctx.fillStyle = '#999';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GRÁFICO VENTAS CARGANDO...', width/2, height/2);
    
    console.log('🎨 Canvas de ventas limpio, preparando gráfico...');
    
    const datosReales = {{ resumen_general.evolucion_ventas | tojson }};
    console.log('📊 Datos de ventas del backend:', datosReales);
    
    // Datos de prueba realistas para ventas (en miles)
    const datosTest = [
        {fecha: '01/12', ventas: 15000},
        {fecha: '03/12', ventas: 18500},
        {fecha: '05/12', ventas: 22000},
        {fecha: '08/12', ventas: 19500},
        {fecha: '10/12', ventas: 25000},
        {fecha: '12/12', ventas: 21000},
        {fecha: '15/12', ventas: 28000},
        {fecha: '18/12', ventas: 32000}
    ];
    
    // Usar datos reales si existen, si no usar datos de prueba
    const datos = (datosReales && datosReales.length > 0) ? datosReales : datosTest;
    
    console.log('📈 Datos de ventas a usar:', datos);
    console.log('📈 Cantidad de puntos de ventas:', datos.length);
    
    if (datos.length === 0) {
        // Solo limpiar el texto de debug
        ctx.clearRect(0, 0, width, height);
        
        ctx.fillStyle = '#6c757d';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sin datos disponibles', width/2, height/2);
        return true;
    }
    
    // Limpiar solo el texto de debug, no agregar fondo
    ctx.clearRect(0, 0, width, height);

    // Configurar área de dibujo con márgenes optimizados para evitar corte de etiquetas
    const marginTop = 18;      // Margen superior aumentado para evitar corte de valores
    const marginBottom = 15;   // Margen inferior normal
    const marginLeft = 18;     // Margen izquierdo aumentado
    const marginRight = 18;    // Margen derecho aumentado
    const chartWidth = width - (marginLeft + marginRight);
    const chartHeight = height - (marginTop + marginBottom);
    
    // Obtener rango de valores de ventas
    const valores = datos.map(d => parseFloat(d.ventas) || 0);
    const minVal = Math.min(...valores) * 0.95; // 5% menos para mejor visualización
    const maxVal = Math.max(...valores) * 1.05; // 5% más
    const range = maxVal - minVal;
    
    console.log('📊 Rango de datos ventas: ', minVal.toFixed(0), '-', maxVal.toFixed(0), '$ (range:', range.toFixed(0), ')');
    
    // PRIMERO: Dibujar área degradada bajo la línea (verde en lugar de rojo)
    const gradient = ctx.createLinearGradient(0, marginTop, 0, height - marginBottom);
    gradient.addColorStop(0, 'rgba(40, 167, 69, 0.3)');
    gradient.addColorStop(0.6, 'rgba(40, 167, 69, 0.1)');
    gradient.addColorStop(1, 'rgba(40, 167, 69, 0.02)');

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(marginLeft, height - marginBottom);

    // Dibujar la línea superior del área
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ventas) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.lineTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    // Cerrar el área hacia abajo
    const ultimoX = marginLeft + chartWidth;
    ctx.lineTo(ultimoX, height - marginBottom);
    ctx.closePath();
    ctx.fill();
    
    // SEGUNDO: Dibujar línea principal (verde en lugar de rojo)
    ctx.strokeStyle = '#28a745';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    ctx.beginPath();

    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ventas) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        console.log(`Punto ventas ${index}: (${x.toFixed(1)}, ${y.toFixed(1)}) = $${punto.ventas}`);

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    ctx.stroke();

    // TERCERO: Dibujar puntos visibles en cada mes
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ventas) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        // Punto principal (círculo grande)
        ctx.fillStyle = '#28a745';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();

        // Punto interior (círculo blanco más pequeño)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, 2 * Math.PI);
        ctx.fill();

        // Etiqueta del mes (abajo del punto)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(punto.fecha, x, height - 2);

        // Valor de ventas - formato abreviado + posicionamiento dinámico
        const ventasAbreviadas = formatearCantidad(punto.ventas);
        ctx.fillStyle = '#28a745';
        ctx.font = 'bold 9px Arial';

        // Ajuste dinámico: si el punto está muy arriba, colocar etiqueta debajo
        const labelOffset = y < (marginTop + 10) ? 14 : -10;
        ctx.fillText('$' + ventasAbreviadas, x, y + labelOffset);
    });

    console.log('✅ Gráfico de ventas completado exitosamente');
    return true;

// Función auxiliar para formatear cantidades
function formatearCantidad(cantidad) {
    if (cantidad >= 1000000) {
        return (cantidad / 1000000).toFixed(1) + 'M';  // Millones con 1 decimal
    } else if (cantidad >= 1000) {
        return (cantidad / 1000).toFixed(0) + 'k';     // Miles sin decimales
    } else {
        return cantidad.toString();
    }
}
}

// Función para gráfico de evolución de ingreso real %
function initializeIngresoEvolucionChart() {
    console.log('🚀 Iniciando función de gráfico de ingreso real...');

    const canvas = document.getElementById('ingresoEvolucionChart');
    if (!canvas) {
        console.log('❌ Canvas ingresoEvolucionChart no encontrado');
        return false;
    }

    console.log('✅ Canvas de ingreso real encontrado');

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.log('❌ No se pudo obtener contexto 2D del canvas de ingreso real');
        return false;
    }

    // Configurar dimensiones originales que funcionaban bien
    const width = 280;
    const height = 80;

    canvas.width = width;
    canvas.height = height;

    console.log('📏 Canvas configurado:', width, 'x', height);

    // Limpiar canvas (sin fondo blanco grande)
    ctx.clearRect(0, 0, width, height);

    // Solo texto de debug temporal
    ctx.fillStyle = '#999';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GRÁFICO CARGANDO...', width/2, height/2);

    console.log('🎨 Canvas limpio, preparando gráfico...');

    // **USAR DATOS NOMINALES (valores en pesos) PARA GRÁFICO DE INGRESO REAL**
    const datosReales = {{ resumen_general.evolucion_ingreso_nominal | tojson }};
    console.log('📊 Datos del backend (nominal):', datosReales);

    // Datos de prueba realistas con valores nominales
    const datosTest = [
        {fecha: '01/12', ingreso_real: 15000},
        {fecha: '03/12', ingreso_real: 18500},
        {fecha: '05/12', ingreso_real: 22000},
        {fecha: '08/12', ingreso_real: 19500},
        {fecha: '10/12', ingreso_real: 25000},
        {fecha: '12/12', ingreso_real: 21000},
        {fecha: '15/12', ingreso_real: 28000},
        {fecha: '18/12', ingreso_real: 32000}
    ];

    // Usar datos reales si existen, si no usar datos de prueba
    const datos = (datosReales && datosReales.length > 0) ? datosReales : datosTest;

    console.log('📈 Datos a usar:', datos);
    console.log('📈 Cantidad de puntos:', datos.length);

    if (datos.length === 0) {
        // Solo limpiar el texto de debug
        ctx.clearRect(0, 0, width, height);

        ctx.fillStyle = '#6c757d';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sin datos disponibles', width/2, height/2);
        return true;
    }

    // Limpiar solo el texto de debug, no agregar fondo
    ctx.clearRect(0, 0, width, height);

    // Configurar área de dibujo con márgenes optimizados para evitar corte de etiquetas
    const marginTop = 18;      // Margen superior aumentado para evitar corte de valores
    const marginBottom = 15;   // Margen inferior normal
    const marginLeft = 18;     // Margen izquierdo aumentado
    const marginRight = 18;    // Margen derecho aumentado
    const chartWidth = width - (marginLeft + marginRight);
    const chartHeight = height - (marginTop + marginBottom);

    // Obtener rango de valores NOMINALES (en pesos)
    const valores = datos.map(d => parseFloat(d.ingreso_real) || 0);
    const minVal = Math.min(...valores);
    const maxVal = Math.max(...valores);
    const range = maxVal - minVal;

    // Añadir buffer del 10% para mejor visualización
    const buffer = range * 0.1;
    const minValAjustado = minVal - buffer;
    const maxValAjustado = maxVal + buffer;
    const rangeAjustado = maxValAjustado - minValAjustado;

    console.log('📊 Rango de datos (nominal): $', minVal.toFixed(0), '- $', maxVal.toFixed(0), ' (range: $', range.toFixed(0), ')');

    // Determinar color basado en si el ingreso es positivo o negativo
    const esPositivo = valores.every(v => v >= 0);
    const colorBase = esPositivo ? '40, 167, 69' : '220, 53, 69';

    // PRIMERO: Dibujar área degradada bajo la línea
    const gradient = ctx.createLinearGradient(0, marginTop, 0, height - marginBottom);
    gradient.addColorStop(0, `rgba(${colorBase}, 0.3)`);
    gradient.addColorStop(0.6, `rgba(${colorBase}, 0.1)`);
    gradient.addColorStop(1, `rgba(${colorBase}, 0.02)`);

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(marginLeft, height - marginBottom);

    // Dibujar la línea superior del área
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ingreso_real) - minValAjustado) / rangeAjustado;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.lineTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    // Cerrar el área hacia abajo
    const ultimoX = marginLeft + chartWidth;
    ctx.lineTo(ultimoX, height - marginBottom);
    ctx.closePath();
    ctx.fill();

    // SEGUNDO: Dibujar línea principal
    ctx.strokeStyle = esPositivo ? '#28a745' : '#dc3545';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();

    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ingreso_real) - minValAjustado) / rangeAjustado;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        console.log(`Punto ${index}: (${x.toFixed(1)}, ${y.toFixed(1)}) = $${punto.ingreso_real.toLocaleString()}`);

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    ctx.stroke();

    // TERCERO: Dibujar puntos visibles en cada mes
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.ingreso_real) - minValAjustado) / rangeAjustado;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        // Punto principal (círculo grande)
        ctx.fillStyle = esPositivo ? '#28a745' : '#dc3545';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();

        // Punto interior (círculo blanco más pequeño)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, 2 * Math.PI);
        ctx.fill();

        // Etiqueta del mes (abajo del punto)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(punto.fecha, x, height - 2);

        // Valor NOMINAL - formato inteligente con millones y miles + posicionamiento dinámico
        ctx.fillStyle = esPositivo ? '#28a745' : '#dc3545';
        ctx.font = 'bold 9px Arial';
        const valorFormateado = punto.ingreso_real >= 1000000
            ? '$' + (punto.ingreso_real / 1000000).toFixed(1) + 'M'  // Millones con 1 decimal
            : punto.ingreso_real >= 1000
            ? '$' + (punto.ingreso_real / 1000).toFixed(0) + 'k'     // Miles sin decimales
            : '$' + punto.ingreso_real.toFixed(0);                    // Valores menores a $1k

        // Ajuste dinámico: si el punto está muy arriba, colocar etiqueta debajo
        const labelOffset = y < (marginTop + 10) ? 14 : -10;
        ctx.fillText(valorFormateado, x, y + labelOffset);
    });

    console.log('✅ Línea principal dibujada - estilo ultra minimalista');

    console.log('✅ Gráfico completado exitosamente');
    return true;
}

// Función para gráfico de evolución de ingreso real en tarjeta % (duplicado del anterior)
function initializeIngresoEvolucionChartPorcentaje() {
    console.log('🚀 Iniciando función de gráfico de ingreso real % (tarjeta porcentaje)...');

    const canvas = document.getElementById('ingresoEvolucionChartPorcentaje');
    if (!canvas) {
        console.log('❌ Canvas ingresoEvolucionChartPorcentaje no encontrado');
        return false;
    }

    console.log('✅ Canvas de ingreso real % encontrado');

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.log('❌ No se pudo obtener contexto 2D del canvas de ingreso real %');
        return false;
    }

    // Configurar dimensiones
    const width = 280;
    const height = 80;

    canvas.width = width;
    canvas.height = height;

    // Texto de carga temporal
    ctx.fillStyle = '#6c757d';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GRÁFICO INGRESO % CARGANDO...', width/2, height/2);

    console.log('🎨 Canvas de ingreso % limpio, preparando gráfico...');

    // USAR LOS MISMOS DATOS QUE EL GRÁFICO DE INGRESO REAL
    const datosReales = {{ resumen_general.evolucion_ingreso | tojson }};
    console.log('📊 Datos de ingreso % del backend:', datosReales);

    // Datos de prueba idénticos al gráfico original
    const datosTest = [
        {fecha: '01/12', porcentaje: 15.2},
        {fecha: '03/12', porcentaje: 18.1},
        {fecha: '05/12', porcentaje: 22.5},
        {fecha: '08/12', porcentaje: 19.5},
        {fecha: '10/12', porcentaje: 25.0},
        {fecha: '12/12', porcentaje: 21.0},
        {fecha: '15/12', porcentaje: 28.0},
        {fecha: '18/12', porcentaje: 32.0}
    ];

    // Usar datos reales si existen, si no usar datos de prueba
    const datos = (datosReales && datosReales.length > 0) ? datosReales : datosTest;

    console.log('📈 Datos de ingreso % a usar:', datos);
    console.log('📈 Cantidad de puntos de ingreso %:', datos.length);

    if (datos.length === 0) {
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#6c757d';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sin datos disponibles', width/2, height/2);
        return true;
    }

    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);

    // Configurar área de dibujo con márgenes optimizados para evitar corte de etiquetas
    const marginTop = 18;      // Margen superior aumentado para evitar corte de valores
    const marginBottom = 15;   // Margen inferior normal
    const marginLeft = 18;     // Margen izquierdo aumentado
    const marginRight = 18;    // Margen derecho aumentado
    const chartWidth = width - (marginLeft + marginRight);
    const chartHeight = height - (marginTop + marginBottom);

    // Obtener rango de valores de porcentaje
    const valores = datos.map(d => parseFloat(d.porcentaje) || 0);
    const minVal = Math.min(...valores) * 0.95;
    const maxVal = Math.max(...valores) * 1.05;
    const range = maxVal - minVal;

    console.log('📊 Rango de datos ingreso %: ', minVal.toFixed(1), '-', maxVal.toFixed(1), '% (range:', range.toFixed(1), ')');

    // PRIMERO: Dibujar área degradada bajo la línea (mismo color verde)
    const gradient = ctx.createLinearGradient(0, marginTop, 0, height - marginBottom);
    gradient.addColorStop(0, 'rgba(40, 167, 69, 0.3)');
    gradient.addColorStop(0.6, 'rgba(40, 167, 69, 0.1)');
    gradient.addColorStop(1, 'rgba(40, 167, 69, 0.02)');

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(marginLeft, height - marginBottom);

    // Dibujar la línea superior del área
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.lineTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    // Cerrar el área hasta la línea base
    const lastX = marginLeft + chartWidth;
    ctx.lineTo(lastX, height - marginBottom);
    ctx.lineTo(marginLeft, height - marginBottom);
    ctx.fill();

    // SEGUNDO: Dibujar la línea principal (verde)
    ctx.strokeStyle = 'rgba(40, 167, 69, 0.9)';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();

    // TERCERO: Dibujar puntos y etiquetas (igual que el gráfico original)
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.porcentaje) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        // Determinar color según si es positivo o negativo
        const esPositivo = parseFloat(punto.porcentaje) >= 0;

        // Punto principal (círculo grande)
        ctx.fillStyle = esPositivo ? '#28a745' : '#dc3545';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();

        // Punto interior (círculo blanco más pequeño)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, 2 * Math.PI);
        ctx.fill();

        // Etiqueta del mes (abajo del punto)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(punto.fecha, x, height - 2);

        // Valor de porcentaje + posicionamiento dinámico
        ctx.fillStyle = esPositivo ? '#28a745' : '#dc3545';
        ctx.font = 'bold 9px Arial';

        // Ajuste dinámico: si el punto está muy arriba, colocar etiqueta debajo
        const labelOffset = y < (marginTop + 10) ? 14 : -10;
        ctx.fillText(punto.porcentaje.toFixed(1) + '%', x, y + labelOffset);
    });

    console.log('✅ Gráfico de ingreso % completado exitosamente');
    return true;
}

// Función para gráfico de evolución de ROI
function initializeRoiEvolucionChart() {
    console.log('🚀 Iniciando función de gráfico de ROI...');

    const canvas = document.getElementById('roiEvolucionChart');
    if (!canvas) {
        console.log('❌ Canvas roiEvolucionChart no encontrado');
        return false;
    }

    console.log('✅ Canvas de ROI encontrado');

    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.log('❌ No se pudo obtener contexto 2D del canvas de ROI');
        return false;
    }

    // Configurar dimensiones
    const width = 280;
    const height = 80;

    canvas.width = width;
    canvas.height = height;

    // Texto de carga temporal
    ctx.fillStyle = '#6c757d';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('GRÁFICO ROI CARGANDO...', width/2, height/2);

    console.log('🎨 Canvas de ROI limpio, preparando gráfico...');

    const datosReales = {{ resumen_general.evolucion_roi | tojson }};
    console.log('📊 Datos de ROI del backend:', datosReales);

    // Datos de prueba realistas para ROI (en porcentaje)
    const datosTest = [
        {fecha: '01/12', roi: 85.2},
        {fecha: '03/12', roi: 92.1},
        {fecha: '05/12', roi: 78.5},
        {fecha: '08/12', roi: 105.3},
        {fecha: '10/12', roi: 112.7},
        {fecha: '12/12', roi: 98.4},
        {fecha: '15/12', roi: 118.9},
        {fecha: '18/12', roi: 124.2}
    ];

    // Usar datos reales si existen, si no usar datos de prueba
    const datos = (datosReales && datosReales.length > 0) ? datosReales : datosTest;

    console.log('📈 Datos de ROI a usar:', datos);
    console.log('📈 Cantidad de puntos de ROI:', datos.length);

    if (datos.length === 0) {
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#6c757d';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sin datos disponibles', width/2, height/2);
        return true;
    }

    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);

    // Configurar área de dibujo con márgenes optimizados para evitar corte de etiquetas
    const marginTop = 18;      // Margen superior aumentado para evitar corte de valores
    const marginBottom = 15;   // Margen inferior normal
    const marginLeft = 18;     // Margen izquierdo aumentado
    const marginRight = 18;    // Margen derecho aumentado
    const chartWidth = width - (marginLeft + marginRight);
    const chartHeight = height - (marginTop + marginBottom);

    // Obtener rango de valores de ROI
    const valores = datos.map(d => parseFloat(d.roi) || 0);
    const minVal = Math.min(...valores) * 0.95;
    const maxVal = Math.max(...valores) * 1.05;
    const range = maxVal - minVal;

    console.log('📊 Rango de datos ROI: ', minVal.toFixed(1), '-', maxVal.toFixed(1), '% (range:', range.toFixed(1), ')');

    // Color Teal fijo para ROI (sin lógica condicional)
    const colorPrincipal = 'rgba(32, 201, 151, 0.9)';   // #20c997
    const colorSecundario = 'rgba(23, 162, 184, 0.7)';  // #17a2b8
    const colorArea = 'rgba(32, 201, 151, 0.3)';

    // PRIMERO: Dibujar área degradada bajo la línea
    const gradient = ctx.createLinearGradient(0, marginTop, 0, height - marginBottom);
    gradient.addColorStop(0, colorArea);
    gradient.addColorStop(0.6, colorArea.replace('0.3', '0.1'));
    gradient.addColorStop(1, colorArea.replace('0.3', '0.02'));

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(marginLeft, height - marginBottom);

    // Dibujar la línea superior del área
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.roi) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.lineTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });

    // Cerrar el área hasta la línea base
    const lastX = marginLeft + chartWidth;
    ctx.lineTo(lastX, height - marginBottom);
    ctx.lineTo(marginLeft, height - marginBottom);
    ctx.fill();

    // SEGUNDO: Dibujar la línea principal (más gruesa y con color dinámico)
    ctx.strokeStyle = colorPrincipal;
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.roi) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();

    // TERCERO: Dibujar puntos y etiquetas (igual que otros gráficos)
    datos.forEach((punto, index) => {
        const x = marginLeft + (index / Math.max(datos.length - 1, 1)) * chartWidth;
        const normalizedY = (parseFloat(punto.roi) - minVal) / range;
        const y = marginTop + chartHeight - (normalizedY * chartHeight);

        // Punto principal (círculo grande) con color dinámico
        ctx.fillStyle = colorPrincipal;
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();

        // Punto interior (círculo blanco más pequeño)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, 2 * Math.PI);
        ctx.fill();

        // Etiqueta del mes (abajo del punto)
        ctx.fillStyle = '#495057';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(punto.fecha, x, height - 2);

        // Valor de ROI + posicionamiento dinámico
        ctx.fillStyle = colorPrincipal;
        ctx.font = 'bold 9px Arial';

        // Ajuste dinámico: si el punto está muy arriba, colocar etiqueta debajo
        const labelOffset = y < (marginTop + 10) ? 14 : -10;
        ctx.fillText(punto.roi.toFixed(1) + '%', x, y + labelOffset);
    });

    console.log('✅ Gráfico ROI completado exitosamente');
    return true;
}

// Inicializar tooltips y gráficos
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Animar las barras de progreso al cargar
    setTimeout(function() {
        const progressBars = document.querySelectorAll('.h-100.transition-all');
        progressBars.forEach(function(bar) {
            if (bar.style.width === '0%') {
                bar.style.width = '100%';
            }
        });
    }, 500);

    // ===== INICIALIZACIÓN DE GRÁFICOS =====
    console.log('🚀 Página cargada, preparando gráficos...');

    // Variables para intentos de inicialización
    let chartInitAttempts = 0;
    const maxAttempts = 10;

    function tryInitCharts() {
        chartInitAttempts++;
        console.log(`🚀 Intento ${chartInitAttempts} de inicializar gráficos...`);

        const costoSuccess = initializeCostoEvolucionChart();
        const ventasSuccess = initializeVentasEvolucionChart();
        const ingresoSuccess = initializeIngresoEvolucionChart();
        const ingresoPorcentajeSuccess = initializeIngresoEvolucionChartPorcentaje();
        const roiSuccess = initializeRoiEvolucionChart();

        if ((!costoSuccess || !ventasSuccess || !ingresoSuccess || !ingresoPorcentajeSuccess || !roiSuccess) && chartInitAttempts < maxAttempts) {
            setTimeout(tryInitCharts, 500);
        } else if (costoSuccess && ventasSuccess && ingresoSuccess && ingresoPorcentajeSuccess && roiSuccess) {
            console.log('✅ Todos los gráficos inicializados exitosamente (incluyendo ROI e Ingreso %)');

            // Registrar gráficos en el sistema de modal
            console.log('📊 Registrando gráficos en el sistema de modal...');

            // Datos de los gráficos
            const datosCosto = {{ resumen_general.evolucion_costo | tojson }};
            const datosVentas = {{ resumen_general.evolucion_ventas | tojson }};
            const datosIngreso = {{ resumen_general.evolucion_ingreso_nominal | tojson }};
            const datosIngresoPorcentaje = {{ resumen_general.evolucion_ingreso | tojson }};
            const datosRoi = {{ resumen_general.evolucion_roi | tojson }};

            // Registrar cada gráfico con sus funciones helper
            if (typeof registerCostoChart === 'function' && datosCosto) {
                registerCostoChart(datosCosto);
            }
            if (typeof registerVentasChart === 'function' && datosVentas) {
                registerVentasChart(datosVentas);
            }
            if (typeof registerIngresoChart === 'function' && datosIngreso) {
                registerIngresoChart(datosIngreso);
            }
            if (typeof registerIngresoPorcentajeChart === 'function' && datosIngresoPorcentaje) {
                registerIngresoPorcentajeChart(datosIngresoPorcentaje);
            }
            if (typeof registerRoiChart === 'function' && datosRoi) {
                registerRoiChart(datosRoi);
            }

            console.log('✅ Gráficos registrados en el sistema de modal');
        } else {
            console.log('❌ No se pudieron inicializar todos los gráficos después de varios intentos');
        }
    }
    
    // Iniciar después de un pequeño delay
    setTimeout(tryInitCharts, 1000);


});
</script>
{% endblock %}