{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4" data-aos="fade-down" style="color: #2C2C2C; font-weight: 700;">Indicadores de Ventas</h2>

    <form method="POST" class="row g-3 align-items-end mb-4" data-aos="fade-up" data-aos-delay="100">
        <div class="col-md-3">
            <label for="preset_main" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Periodo principal:</strong></label>
            <select name="preset_main" id="preset_main" class="form-select" style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
                <option value="hoy" {% if selected_preset_main == "hoy" %}selected{% endif %}>Hoy</option>
                <option value="7" {% if selected_preset_main == "7" %}selected{% endif %}>Últimos 7 días</option>
                <option value="15" {% if selected_preset_main == "15" %}selected{% endif %}>Últimos 15 días</option>
                <option value="30" {% if selected_preset_main == "30" %}selected{% endif %}>Últimos 30 días</option>
                <option value="personalizado" {% if selected_preset_main == "personalizado" %}selected{% endif %}>Fecha personalizada</option>
            </select>
        </div>

        <div class="col-md-3" id="main_range_group" {% if selected_preset_main != "personalizado" %}style="display:none;"{% endif %}>
            <label for="main_range" class="form-label" style="color: #2C2C2C; font-weight: 600;">Rango personalizado:</label>
            <input type="text" id="main_range" name="main_range" class="form-control" 
                   value="{{ selected_main_range }}" placeholder="Selecciona un rango" readonly
                   style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
        </div>

        <div class="col-md-3">
            <label for="preset_compare" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Comparar con:</strong></label>
            <select name="preset_compare" id="preset_compare" class="form-select" style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
                <option value="anterior" {% if selected_preset_compare == "anterior" %}selected{% endif %}>Período anterior</option>
                <option value="anual" {% if selected_preset_compare == "anual" %}selected{% endif %}>Año anterior</option>
                <option value="personalizado" {% if selected_preset_compare == "personalizado" %}selected{% endif %}>Fecha personalizada</option>
            </select>
        </div>

        <div class="col-md-3" id="compare_range_group" {% if selected_preset_compare != "personalizado" %}style="display:none;"{% endif %}>
            <label for="compare_range" class="form-label" style="color: #2C2C2C; font-weight: 600;">Comparar con este rango:</label>
            <input type="text" id="compare_range" name="compare_range" class="form-control" 
                   value="{{ selected_compare_range }}" placeholder="Comparar con este rango" readonly
                   style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
        </div>

        <div class="col-md-2">
            <label class="form-label d-block invisible">Filtros</label>
            <button type="button" class="btn btn-outline-warning w-100 position-relative" data-bs-toggle="modal" data-bs-target="#filtroModal"
                    style="border-color: #D4AF37; color: #D4AF37; font-weight: 600; transition: all 0.3s ease;">
                <i class="bi bi-sliders"></i> Filtros
                {% if selected_channels or selected_warehouses %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning filter-badge-counter" id="filterBadge"
                      style="background-color: #D4AF37 !important;">
                    {{ (selected_channels|length) + (selected_warehouses|length) }}
                </span>
                {% endif %}
            </button>
        </div>

        <div class="col-12">
            <button type="submit" class="btn btn-warning" id="filterButton" 
                    style="background-color: #D4AF37; border-color: #D4AF37; color: #2C2C2C; font-weight: 600; transition: all 0.3s ease;">
                <i class="bi bi-funnel-fill me-2"></i>Filtrar
            </button>
        </div>

        {% if selected_channels or selected_warehouses %}
        <div class="col-12" data-aos="slide-down" data-aos-duration="400">
            <div class="alert" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05)); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 12px;">
                <strong style="color: #2C2C2C;">Filtros activos:</strong>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    {% set canales_ecommerce = ['Mercado Libre', 'Doto', 'Yuhu', 'Aliexpress', 'Coppel', 'Liverpool', 'Shein', 'CrediTienda', 'Walmart', 'TikTok Shop'] %}
                    {% set canales_b2b = ['ASI', 'Betterware', 'Amazon', 'Loomber'] %}
                    {% set canales_ecommerce_seleccionados = [] %}
                    {% set canales_b2b_seleccionados = [] %}
                    {% set otros_canales_seleccionados = [] %}
                    
                    {% for channel in selected_channels %}
                        {% if channel in canales_ecommerce %}
                            {% set _ = canales_ecommerce_seleccionados.append(channel) %}
                        {% elif channel in canales_b2b %}
                            {% set _ = canales_b2b_seleccionados.append(channel) %}
                        {% else %}
                            {% set _ = otros_canales_seleccionados.append(channel) %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Badge agrupado para Ecommerce -->
                    {% if canales_ecommerce_seleccionados|length == canales_ecommerce|length %}
                    <!-- Todos los canales Ecommerce seleccionados - mostrar badge agrupado -->
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; font-size: 0.9rem; padding: 8px 12px;">
                        <i class="bi bi-cart me-1"></i>Canales Ecommerce
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar" 
                                onclick="clearEcommerceChannels()"></button>
                    </span>
                    {% else %}
                    <!-- Solo algunos canales Ecommerce - mostrar individualmente -->
                    {% for channel in canales_ecommerce_seleccionados %}
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
                        <i class="bi bi-cart me-1"></i>Ecommerce: {{ channel }}
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar" 
                                onclick="removeFilter('channel', '{{ channel }}')"></button>
                    </span>
                    {% endfor %}
                    {% endif %}
                    
                    <!-- Badge agrupado para B2B -->
                    {% if canales_b2b_seleccionados|length == canales_b2b|length %}
                    <!-- Todos los canales B2B seleccionados - mostrar badge agrupado -->
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #0d6efd, #0056b3); color: white; font-size: 0.9rem; padding: 8px 12px;">
                        <i class="bi bi-building-gear me-1"></i>Canales B2B
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar" 
                                onclick="clearB2BChannels()"></button>
                    </span>
                    {% else %}
                    <!-- Solo algunos canales B2B - mostrar individualmente -->
                    {% for channel in canales_b2b_seleccionados %}
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #0d6efd, #0056b3); color: white;">
                        <i class="bi bi-building-gear me-1"></i>B2B: {{ channel }}
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar" 
                                onclick="removeFilter('channel', '{{ channel }}')"></button>
                    </span>
                    {% endfor %}
                    {% endif %}
                    
                    <!-- Otros canales individualmente -->
                    {% for channel in otros_canales_seleccionados %}
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #6c757d, #495057); color: white;">
                        <i class="bi bi-question-circle me-1"></i>Otro: {{ channel }}
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar" 
                                onclick="removeFilter('channel', '{{ channel }}')"></button>
                    </span>
                    {% endfor %}
                    
                    {% for warehouse in selected_warehouses %}
                    <span class="badge animate-badge" style="background: linear-gradient(135deg, #2C2C2C, #4a4a4a); color: white;">
                        Bodega: {{ warehouse }}
                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Eliminar"
                                onclick="removeFilter('warehouse', '{{ warehouse }}')"></button>
                    </span>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearAllFilters()"
                        style="border-color: #D4AF37; color: #D4AF37;">
                    <i class="bi bi-x-circle"></i> Limpiar todos los filtros
                </button>
            </div>
        </div>
        {% endif %}

        <!-- MODAL FILTROS -->
        <div class="modal fade" id="filtroModal" tabindex="-1" aria-labelledby="filtroModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content" style="border: none; border-radius: 15px; border-top: 4px solid #D4AF37;">
              <div class="modal-header" style="border-bottom: 1px solid rgba(212, 175, 55, 0.2); background: rgba(212, 175, 55, 0.05);">
                <h5 class="modal-title" id="filtroModalLabel" style="color: #2C2C2C; font-weight: 700;">
                    <i class="bi bi-funnel me-2" style="color: #D4AF37;"></i>Filtrar resultados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0" style="color: #2C2C2C;">
                        <i class="bi bi-broadcast me-2" style="color: #D4AF37;"></i>Canal
                    </h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectAllChannels()"
                                style="border-color: #D4AF37; color: #D4AF37;">Todos</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearChannels()">Ninguno</button>
                    </div>
                </div>

                <!-- ECOMMERCE -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2" style="background: rgba(220, 53, 69, 0.05); padding: 8px 12px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h6 class="fw-bold mb-0" style="color: #dc3545; font-size: 0.9rem;">
                            <i class="bi bi-cart me-2"></i>Ecommerce
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="selectEcommerceChannels()"
                                style="border-color: #dc3545; color: #dc3545; font-size: 0.8rem; padding: 4px 8px;">
                            Seleccionar Ecommerce
                        </button>
                    </div>
                    <div class="row">
                      {% for canal in channels %}
                      {% if canal in ['Mercado Libre', 'Doto', 'Yuhu', 'Aliexpress', 'Coppel', 'Liverpool', 'Shein', 'CrediTienda', 'Walmart', 'TikTok Shop'] %}
                      <div class="col-md-6">
                        <div class="form-check">
                          <input class="form-check-input ecommerce-channel" type="checkbox" name="channel" value="{{ canal }}" 
                                 id="channel_{{ loop.index }}" 
                                 {% if canal in selected_channels %}checked{% endif %}
                                 style="border-color: #dc3545;">
                          <label class="form-check-label" for="channel_{{ loop.index }}" style="color: #2C2C2C; font-size: 0.9rem;">{{ canal }}</label>
                        </div>
                      </div>
                      {% endif %}
                      {% endfor %}
                    </div>
                </div>

                <!-- B2B -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2" style="background: rgba(13, 110, 253, 0.05); padding: 8px 12px; border-radius: 8px; border-left: 4px solid #0d6efd;">
                        <h6 class="fw-bold mb-0" style="color: #0d6efd; font-size: 0.9rem;">
                            <i class="bi bi-building-gear me-2"></i>B2B
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectB2BChannels()"
                                style="border-color: #0d6efd; color: #0d6efd; font-size: 0.8rem; padding: 4px 8px;">
                            Seleccionar B2B
                        </button>
                    </div>
                    <div class="row">
                      {% for canal in channels %}
                      {% if canal in ['ASI', 'Betterware', 'Amazon', 'Loomber'] %}
                      <div class="col-md-6">
                        <div class="form-check">
                          <input class="form-check-input b2b-channel" type="checkbox" name="channel" value="{{ canal }}" 
                                 id="channel_{{ loop.index }}" 
                                 {% if canal in selected_channels %}checked{% endif %}
                                 style="border-color: #0d6efd;">
                          <label class="form-check-label" for="channel_{{ loop.index }}" style="color: #2C2C2C; font-size: 0.9rem;">{{ canal }}</label>
                        </div>
                      </div>
                      {% endif %}
                      {% endfor %}
                    </div>
                </div>

                <!-- OTROS CANALES (si existen canales que no están en las categorías) -->
                {% set otros_canales = [] %}
                {% for canal in channels %}
                    {% if canal not in ['Mercado Libre', 'Doto', 'Yuhu', 'Aliexpress', 'Coppel', 'Liverpool', 'Shein', 'CrediTienda', 'Walmart', 'TikTok Shop', 'ASI', 'Betterware', 'Amazon', 'Loomber'] %}
                        {% set _ = otros_canales.append(canal) %}
                    {% endif %}
                {% endfor %}
                
                {% if otros_canales %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2" style="background: rgba(108, 117, 125, 0.05); padding: 8px 12px; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h6 class="fw-bold mb-0" style="color: #6c757d; font-size: 0.9rem;">
                            <i class="bi bi-question-circle me-2"></i>Otros
                        </h6>
                    </div>
                    <div class="row">
                      {% for canal in otros_canales %}
                      <div class="col-md-6">
                        <div class="form-check">
                          <input class="form-check-input other-channel" type="checkbox" name="channel" value="{{ canal }}" 
                                 id="channel_otros_{{ loop.index }}" 
                                 {% if canal in selected_channels %}checked{% endif %}
                                 style="border-color: #6c757d;">
                          <label class="form-check-label" for="channel_otros_{{ loop.index }}" style="color: #2C2C2C; font-size: 0.9rem;">{{ canal }}</label>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0" style="color: #2C2C2C;">
                        <i class="bi bi-building me-2" style="color: #D4AF37;"></i>Bodega
                    </h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectAllWarehouses()"
                                style="border-color: #D4AF37; color: #D4AF37;">Todos</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearWarehouses()">Ninguno</button>
                    </div>
                </div>
                <div class="row">
                  {% for wh in warehouses %}
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="warehouse" value="{{ wh }}" 
                             id="wh_{{ loop.index }}"
                             {% if wh in selected_warehouses %}checked{% endif %}
                             style="border-color: #D4AF37;">
                      <label class="form-check-label" for="wh_{{ loop.index }}" style="color: #2C2C2C;">{{ wh }}</label>
                    </div>
                  </div>
                  {% endfor %}
                </div>

              </div>
              <div class="modal-footer" style="border-top: 1px solid rgba(212, 175, 55, 0.2);">
                <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar filtros</button>
                <button type="submit" class="btn btn-warning" style="background-color: #D4AF37; border-color: #D4AF37; color: #2C2C2C; font-weight: 600;">
                    <i class="bi bi-check-circle me-2"></i>Aplicar
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- FIN MODAL -->
    </form>

    {% if indicadores %}
    <div class="row g-4" id="indicatorsContainer">
        {% for ind in indicadores %}
        <div class="col-md-4" data-aos="zoom-in" data-aos-delay="{{ loop.index0 * 100 + 200 }}">
            <div class="p-4 shadow-sm border rounded-3 bg-white position-relative overflow-hidden" 
                 style="height: 170px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
                        transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
                 onmouseenter="animateIndicatorCard(this)"
                 onmouseleave="resetIndicatorCard(this)">
                
                <!-- Efecto de fondo sutil - LÓGICA SIMPLE COMO EN INDEX -->
                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                     style="background: linear-gradient(135deg, {{ 'rgba(40, 167, 69, 0.08)' if ind.delta >= 0 else 'rgba(220, 53, 69, 0.08)' }} 0%, transparent 100%);"></div>
                
                <div class="text-muted fw-semibold text-uppercase mb-1 position-relative" 
                     style="font-size: 0.85rem; letter-spacing: 0.5px; transition: all 0.2s ease; color: #6c757d;">
                    {{ ind.label }}
                </div>
                
                <div class="fw-bold position-relative" 
                     style="font-size: 1.8rem; color: #2C2C2C; transition: all 0.2s ease;">
                    <span class="animated-number" id="indicator-{{ loop.index0 }}" 
                          data-value="{{ ind.valor|replace('$', '')|replace(',', '')|replace('%', '')|replace(' ', '') }}"
                          data-type="{{ 'currency' if '$' in ind.valor else ('percentage' if '%' in ind.valor else 'number') }}">
                        {{ ind.valor }}
                    </span>
                </div>
                
                <div class="fw-medium position-relative" 
                     style="font-size: 0.9rem; transition: all 0.2s ease;">
                    <span class="delta-indicator" data-delta="{{ ind.delta }}">
                        <span style="color: {{ '#28a745' if ind.delta >= 0 else '#dc3545' }};">
                            {{ ind.diferencia.split(' ')[0] }}
                        </span>
                        <span style="color: #D4AF37;">
                            {{ ' '.join(ind.diferencia.split(' ')[1:]) }}
                        </span>
                    </span>
                </div>
                
                <!-- Barra de progreso sutil en la parte inferior - todas doradas -->
                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                    <div class="h-100 transition-all" 
                         style="background: linear-gradient(90deg, #D4AF37, #F4E4A6); 
                                width: 0%; 
                                transition: width 1.5s ease {{ loop.index0 * 0.2 + 1 }}s;"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
    /* Estilos personalizados para paleta Loomber */
    .form-control:focus, .form-select:focus {
        border-color: #D4AF37 !important;
        box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25) !important;
    }
    
    .btn-outline-warning:hover {
        background-color: #D4AF37 !important;
        border-color: #D4AF37 !important;
        color: #2C2C2C !important;
    }
    
    .btn-warning:hover {
        background-color: #B8941F !important;
        border-color: #B8941F !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    
    .form-check-input:checked {
        background-color: #D4AF37 !important;
        border-color: #D4AF37 !important;
    }
    
    .form-check-input:focus {
        border-color: #D4AF37 !important;
        box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25) !important;
    }
    
    /* Animación para badges */
    .animate-badge {
        animation: slideInBadge 0.3s ease-out;
    }
    
    @keyframes slideInBadge {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>

<script>
    let diasPeriodoPrincipal = null;

    // Inicializar Flatpickr con valores persistentes
    document.addEventListener('DOMContentLoaded', function() {
        const mainPicker = flatpickr("#main_range", {
            mode: "range",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d/m/Y",
            allowSingleDateSelection: true,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    diasPeriodoPrincipal = (selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24);
                } else if (selectedDates.length === 1) {
                    diasPeriodoPrincipal = 0; // Un solo día
                    // Actualizar el valor del input para un solo día
                    instance.input.value = dateStr;
                } else {
                    diasPeriodoPrincipal = null;
                }
            }
        });

        const comparePicker = flatpickr("#compare_range", {
            mode: "range",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d/m/Y",
            allowSingleDateSelection: true,
            onChange: function(selectedDates, dateStr, instance) {
                if (diasPeriodoPrincipal !== null && selectedDates.length === 1) {
                    if (diasPeriodoPrincipal > 0) {
                        // Si el período principal es un rango, auto-completar el rango de comparación
                        const inicio = selectedDates[0];
                        const fin = new Date(inicio);
                        fin.setDate(inicio.getDate() + diasPeriodoPrincipal);
                        instance.setDate([inicio, fin], true);
                    } else {
                        // Si el período principal es un solo día, mantener un solo día
                        instance.input.value = dateStr;
                    }
                }
            }
        });

        // INICIALIZAR FLATPICKR CON VALORES EXISTENTES SI LOS HAY
        {% if selected_main_range %}
        const mainValue = "{{ selected_main_range }}";
        if (mainValue.includes(" to ")) {
            const dates = mainValue.split(" to ");
            mainPicker.setDate([dates[0], dates[1]], false);
        }
        {% endif %}

        {% if selected_compare_range %}
        const compareValue = "{{ selected_compare_range }}";
        if (compareValue.includes(" to ")) {
            const dates = compareValue.split(" to ");
            comparePicker.setDate([dates[0], dates[1]], false);
        }
        {% endif %}

        function toggleMainRange() {
            const show = document.getElementById("preset_main").value === "personalizado";
            const element = document.getElementById("main_range_group");
            
            if (show) {
                element.style.display = "block";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.transition = "all 0.3s ease";
                    element.style.opacity = "1";
                    element.style.transform = "translateY(0)";
                }, 10);
            } else {
                element.style.transition = "all 0.3s ease";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.display = "none";
                    document.getElementById("main_range").value = "";
                    diasPeriodoPrincipal = null;
                    mainPicker.clear();
                }, 300);
            }
        }

        function toggleCompareRange() {
            const show = document.getElementById("preset_compare").value === "personalizado";
            const element = document.getElementById("compare_range_group");
            
            if (show) {
                element.style.display = "block";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.transition = "all 0.3s ease";
                    element.style.opacity = "1";
                    element.style.transform = "translateY(0)";
                }, 10);
            } else {
                element.style.transition = "all 0.3s ease";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.display = "none";
                    document.getElementById("compare_range").value = "";
                    comparePicker.clear();
                }, 300);
            }
        }

        // Event listeners
        document.getElementById("preset_main").addEventListener("change", toggleMainRange);
        document.getElementById("preset_compare").addEventListener("change", toggleCompareRange);

        // Inicializar estados
        toggleMainRange();
        toggleCompareRange();

        // Animar números e indicadores después de que AOS termine
        setTimeout(() => {
            animateIndicatorNumbers();
            animateProgressBars();
        }, 600);
    });

    // Función para animar números de indicadores (MÁS RÁPIDA)
    function animateIndicatorNumbers() {
        document.querySelectorAll('.animated-number').forEach((element, index) => {
            const value = element.getAttribute('data-value');
            const type = element.getAttribute('data-type');
            
            if (value && !isNaN(value)) {
                const numericValue = parseFloat(value);
                
                setTimeout(() => {
                    if (typeof window.animateNumber === 'function') {
                        let prefix = '';
                        let suffix = '';
                        
                        if (type === 'currency') {
                            prefix = '$';
                        } else if (type === 'percentage') {
                            suffix = ' %';
                        }
                        
                        window.animateNumber(element.id, numericValue, 800, prefix, suffix);
                    }
                }, index * 100);
            }
        });
    }

    // Función para animar las barras de progreso - SIEMPRE AL 100%
    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.position-absolute.bottom-0 .h-100');
        
        progressBars.forEach((bar, index) => {
            setTimeout(() => {
                bar.style.width = '100%';
            }, index * 50 + 100);
        });
    }

    // Funciones para efectos hover en las cards de indicadores
    function animateIndicatorCard(card) {
        card.style.transform = 'translateY(-5px) scale(1.02)';
        card.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.2)';
        card.style.borderColor = 'rgba(212, 175, 55, 0.5)';
        
        const title = card.querySelector('.text-muted');
        const value = card.querySelector('.fw-bold');
        const delta = card.querySelector('.fw-medium');
        
        if (title) title.style.transform = 'scale(1.05)';
        if (value) value.style.transform = 'scale(1.08)';
        if (delta) delta.style.transform = 'scale(1.05)';
    }

    function resetIndicatorCard(card) {
        card.style.transform = 'translateY(0) scale(1)';
        card.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.05)';
        card.style.borderColor = 'rgba(212, 175, 55, 0.2)';
        
        const title = card.querySelector('.text-muted');
        const value = card.querySelector('.fw-bold');
        const delta = card.querySelector('.fw-medium');
        
        if (title) title.style.transform = 'scale(1)';
        if (value) value.style.transform = 'scale(1)';
        if (delta) delta.style.transform = 'scale(1)';
    }

    // FILTROS SIMPLIFICADOS - SIN ANIMACIONES CONFLICTIVAS
    function limpiarFiltros() {
        document.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
    }

    function clearAllFilters() {
        limpiarFiltros();
        document.querySelector('form').submit();
    }

    function removeFilter(type, value) {
        const checkbox = document.querySelector(`input[name="${type}"][value="${value}"]`);
        if (checkbox) {
            checkbox.checked = false;
        }
        document.querySelector('form').submit();
    }

    function selectAllChannels() {
        document.querySelectorAll('input[name="channel"]').forEach(cb => cb.checked = true);
    }

    function clearChannels() {
        document.querySelectorAll('input[name="channel"]').forEach(cb => cb.checked = false);
    }

    // Función para seleccionar todos los canales de Ecommerce
    function selectEcommerceChannels() {
        document.querySelectorAll('.ecommerce-channel').forEach(cb => cb.checked = true);
    }

    // Función para seleccionar todos los canales de B2B  
    function selectB2BChannels() {
        document.querySelectorAll('.b2b-channel').forEach(cb => cb.checked = true);
    }

    // Función para limpiar todos los canales de Ecommerce (desde badge agrupado)
    function clearEcommerceChannels() {
        document.querySelectorAll('.ecommerce-channel').forEach(cb => cb.checked = false);
        document.querySelector('form').submit();
    }

    // Función para limpiar todos los canales de B2B (desde badge agrupado)  
    function clearB2BChannels() {
        document.querySelectorAll('.b2b-channel').forEach(cb => cb.checked = false);
        document.querySelector('form').submit();
    }

    function selectAllWarehouses() {
        document.querySelectorAll('input[name="warehouse"]').forEach(cb => cb.checked = true);
    }

    function clearWarehouses() {
        document.querySelectorAll('input[name="warehouse"]').forEach(cb => cb.checked = false);
    }
</script>
{% endblock %}